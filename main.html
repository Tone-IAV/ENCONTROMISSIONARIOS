<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gestão do Encontro - Visualização Leitura + Edição</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --p:#1e40af; --s:#3b82f6; --ok:#10b981; --no:#ef4444; --bg:#f8fafc; }
  * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui,sans-serif; }
  body { background:var(--bg); color:#1f2937; line-height:1.6; }
  header { background:var(--p); color:white; padding:2rem; text-align:center; }
  nav { background:#172554; padding:1rem; position:sticky; top:0; z-index:1000; }
  nav ul { display:flex; flex-wrap:wrap; justify-content:center; gap:1rem; list-style:none; }
  nav a { color:white; text-decoration:none; padding:0.8rem 1.4rem; border-radius:8px; font-weight:600; }
  nav a:hover, nav a.active { background:#1e40af; }

  .container { max-width:1400px; margin:0 auto; padding:1.5rem; }
  .view { display:none; }
  .view.active { display:block; }

  .modo-leitura { background:#fff; border-radius:12px; padding:2rem; box-shadow:0 6px 25px rgba(0,0,0,0.1); margin-bottom:2rem; }
  .modo-edicao { background:#f0f9ff; border:2px dashed #0ea5e9; border-radius:12px; padding:2rem; margin-bottom:2rem; }

  .card { background:white; border-radius:10px; padding:1.5rem; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin-bottom:1rem; }
  .grid-3 { display:grid; gap:1.5rem; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); }

  button { padding:0.8rem 1.4rem; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
  .btn-editar { background:#f59e0b; color:white; }
  .btn-salvar { background:var(--ok); color:white; }
  .btn-cancelar { background:var(--no); color:white; }
  .btn-no { background:var(--no); color:white; }
  .btn-small { padding:0.4rem 0.8rem; font-size:0.9rem; }

  input, select, textarea { width:100%; padding:0.9rem; border:1px solid #ccc; border-radius:8px; margin:0.5rem 0; font-size:1rem; }
  table { width:100%; border-collapse:collapse; margin:1.5rem 0; font-size:0.95rem; }
  th, td { padding:0.85rem 1rem; text-align:left; border-bottom:1px solid #e5e7eb; vertical-align:top; }
  th { background:#f1f5f9; font-weight:700; }
  .table-group { background:white; border-radius:12px; padding:1rem 1.2rem; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin:1rem 0; }
  .table-group h3 { margin-bottom:0.5rem; color:#0f172a; }
  .nota-dependencia { background:#ecfeff; border:1px dashed #06b6d4; padding:0.8rem 1rem; border-radius:10px; margin-top:0.5rem; color:#0f172a; }

  .mapa-wrapper { background:white; border-radius:14px; padding:1rem; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin:1rem 0 2rem; }
  .mapa-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1rem; flex-wrap:wrap; }
  .mapa-quartos { display:grid; grid-template-columns:repeat(5, 1fr); grid-auto-rows:120px; gap:0.75rem; }
  .mapa-celula { border:2px dashed #e2e8f0; border-radius:10px; position:relative; background:#f8fafc; transition:border-color .2s, box-shadow .2s; }
  .mapa-celula.drag-over { border-color:var(--s); box-shadow:0 0 0 3px rgba(59,130,246,0.15); }
  .quarto-card { background:white; border-radius:12px; padding:0.75rem; box-shadow:0 4px 15px rgba(0,0,0,0.08); border:2px solid #e5e7eb; height:100%; display:flex; flex-direction:column; justify-content:space-between; cursor:grab; }
  .quarto-card h4 { margin:0 0 0.3rem; color:#0f172a; font-size:1rem; }
  .quarto-card small { color:#475569; display:block; margin-bottom:0.3rem; }
  .quarto-card .ocupantes { font-size:0.9rem; line-height:1.35; }
  .quarto-card.cheio { border-color:var(--no); background:#fff1f2; }
  .quarto-card.disponivel { border-color:var(--ok); background:#f0fdf4; }
  .quarto-card .vagas { font-weight:700; color:#0f172a; font-size:0.95rem; }
  .mapa-rodape { margin-top:0.5rem; color:#475569; font-size:0.95rem; }
  .tag-ocupante { display:inline-flex; align-items:center; gap:0.4rem; background:#e0f2fe; color:#0f172a; padding:0.3rem 0.6rem; border-radius:999px; margin:0.2rem 0.2rem 0 0; }
  .tag-ocupante button { background:transparent; border:none; color:#0f172a; cursor:pointer; font-size:0.9rem; }
  .tag-ocupante button:hover { color:var(--no); }

  .kpi { font-size:3.2rem; font-weight:900; color:var(--p); }
  .section-actions { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; margin:1rem 0; }
  .btn-secondary { background:#0ea5e9; color:white; }
  .pill { display:inline-flex; align-items:center; gap:0.5rem; padding:0.6rem 1rem; background:#e0f2fe; border-radius:999px; font-size:0.95rem; }
  .hidden { display:none !important; }
</style>
</head>
<body>

<header>
  <h1>Gestão do Grande Encontro de Missionários</h1>
  <p>700–1.500 pessoas • Visualização e edição contínuas em cada módulo</p>
</header>

<nav>
  <ul>
    <li><a href="#conta" class="nav-link active">Conta</a></li>
    <li><a href="#dashboard" class="nav-link">Dashboard</a></li>
    <li><a href="#equipes" class="nav-link">Equipes & Projetos</a></li>
    <li><a href="#participantes" class="nav-link">Participantes</a></li>
    <li><a href="#transporte" class="nav-link">Transporte</a></li>
    <li><a href="#alojamento" class="nav-link">Alojamento</a></li>
    <li><a href="#cronograma" class="nav-link">Cronograma</a></li>
    <li><a href="#cardapio" class="nav-link">Cardápio</a></li>
    <li><a href="#compras" class="nav-link">Compras</a></li>
    <li><a href="#palestras" class="nav-link">Palestras</a></li>
    <li><a href="#kids" class="nav-link">Kids</a></li>
    <li><a href="#financeiro" class="nav-link">Financeiro</a></li>
  </ul>
</nav>

<div class="container">
<main>

<!-- CONTA -->
<section id="conta" class="view active">
  <div class="card">
    <h2>Conta do Usuário</h2>
    <p id="contaDescricao">Cadastre um usuário para acessar as edições. Todas as ações são registradas em log em formato JSON e os dados são mantidos somente durante a sessão atual.</p>

    <div id="acoesConta" class="section-actions">
      <button type="button" class="btn-salvar" data-modo-conta="cadastro">Criar nova conta</button>
      <button type="button" class="btn-secondary" data-modo-conta="login">Já tenho conta</button>
    </div>

    <div id="blocoCadastro" class="card">
      <h3>Novo cadastro</h3>
      <form id="formCadastro">
        <input type="text" placeholder="Nome completo" required>
        <input type="email" placeholder="E-mail" required>
        <input type="text" placeholder="Usuário" required>
        <input type="password" placeholder="Senha" required>
        <button type="submit" class="btn-salvar">Registrar</button>
      </form>
    </div>

    <div id="blocoLogin" class="card hidden">
      <h3>Login</h3>
      <form id="formLogin">
        <input type="text" placeholder="Usuário" required>
        <input type="password" placeholder="Senha" required>
        <div class="section-actions">
          <button type="submit" class="btn-secondary">Entrar</button>
          <button type="button" id="btnLogout" class="btn-no hidden">Sair</button>
        </div>
      </form>
    </div>

    <div id="blocoSessao" class="card hidden">
      <h3>Dados da sessão</h3>
      <div id="sessaoUsuario" class="pill">Nenhum usuário autenticado</div>
      <div id="perfilSelecionado"></div>
      <div class="section-actions" id="acoesSessao"></div>
    </div>
  </div>
  <div class="modo-edicao" id="usuariosCard">
    <h3>Usuários cadastrados</h3>
    <div id="usuariosLista"></div>
  </div>
  <div class="modo-leitura" id="logCard">
    <h3>Log de alterações</h3>
    <div id="logAlteracoes"></div>
  </div>
</section>

<!-- DASHBOARD -->
<section id="dashboard" class="view">
  <div class="modo-leitura">
    <h2>Dashboard Executivo</h2>
    <div class="grid-3">
      <div class="card"><h3>Participantes</h3><div class="kpi" id="paxTotal">0</div></div>
      <div class="card"><h3>Ônibus</h3><div class="kpi" id="onibusTotal">0</div></div>
      <div class="card"><h3>Voos</h3><div class="kpi" id="voosTotal">0</div></div>
      <div class="card"><h3>Quartos Ocupados</h3><div class="kpi" id="quartosInfo">0 / 0</div></div>
      <div class="card"><h3>Orçado</h3><div class="kpi">R$ <span id="orcado">0,00</span></div></div>
      <div class="card"><h3>Realizado</h3><div class="kpi">R$ <span id="realizado">0,00</span></div></div>
    </div>
  </div>

  <div class="modo-edicao">
    <h2>Editar Dashboard</h2>
    <p>Os dados são atualizados automaticamente com base nos cadastros.</p>
  </div>
</section>

<!-- EQUIPES E PROJETOS -->
<section id="equipes" class="view">
  <div class="modo-leitura">
    <h2>Equipes, Projetos e Tarefas</h2>
    <div id="equipes-lista"></div>
  </div>
  <div class="modo-edicao">
    <h2>Gerenciar Equipes e Projetos</h2>
    <div class="grid-3">
      <div class="card">
        <h3>Nova Equipe</h3>
        <form id="formEquipe">
          <input type="text" placeholder="Nome da equipe" required>
          <input type="text" placeholder="Responsável" required>
          <textarea placeholder="Membros (separados por vírgula)"></textarea>
          <button type="submit" class="btn-salvar">Salvar Equipe</button>
        </form>
      </div>
      <div class="card">
        <h3>Novo Projeto</h3>
        <form id="formProjeto">
          <input type="text" placeholder="Nome do projeto" required>
          <select id="projetoEquipe" required></select>
          <input type="date" required>
          <select>
            <option value="pendente">Pendente</option>
            <option value="andamento">Em andamento</option>
            <option value="concluido">Concluído</option>
          </select>
          <button type="submit" class="btn-salvar">Salvar Projeto</button>
        </form>
      </div>
      <div class="card">
        <h3>Nova Tarefa (Kanban)</h3>
        <form id="formTarefa">
          <input type="text" placeholder="Título da tarefa" required>
          <select id="tarefaProjeto" required></select>
          <select>
            <option value="backlog">Backlog</option>
            <option value="fazendo">Fazendo</option>
            <option value="pronto">Pronto</option>
          </select>
          <button type="submit" class="btn-salvar">Adicionar Tarefa</button>
        </form>
      </div>
    </div>
    <div id="equipes-edicao"></div>
  </div>
</section>

<!-- PARTICIPANTES -->
<section id="participantes" class="view">
  <div class="modo-leitura" id="leitura-participantes">
    <h2>Participantes Confirmados</h2>
    <div id="lista-participantes-leitura"></div>
  </div>

  <div class="modo-edicao">
    <h2>Cadastrar Nova Família</h2>
    <form id="formFamilia">
      <input type="text" placeholder="Responsável" required>
      <input type="number" placeholder="Quantas pessoas" min="1" value="1" required>
      <input type="text" placeholder="Cidade/Estado" required>
      <input type="tel" placeholder="WhatsApp">
      <select><option>Ônibus</option><option>Voo</option><option>Carro próprio</option></select>
      <button type="submit" class="btn-salvar">Salvar Família</button>
    </form>
    <div id="lista-participantes-edicao"></div>
  </div>
</section>

<!-- TRANSPORTE -->
<section id="transporte" class="view">
  <div class="modo-leitura">
    <h2>Transporte Organizado</h2>
    <div id="leitura-transporte"></div>
  </div>
  <div class="modo-edicao">
    <h2>Adicionar Transporte</h2>
    <form id="formOnibus">
      <input type="text" placeholder="Cidade de origem" required>
      <input type="number" placeholder="Passageiros" required>
      <input type="text" placeholder="Empresa/Motorista" required>
      <input type="datetime-local" required>
      <button type="submit" class="btn-salvar">Adicionar Ônibus</button>
    </form>
    <form id="formVoo" style="margin-top:1rem;">
      <input type="text" placeholder="Passageiro" required>
      <input type="text" placeholder="Voo (ex: G3 1234)" required>
      <input type="datetime-local" required>
      <button type="submit" class="btn-salvar">Adicionar Voo</button>
    </form>
    <div id="edicao-transporte"></div>
  </div>
</section>

<!-- ALOJAMENTO -->
<section id="alojamento" class="view">
  <div class="modo-leitura">
    <h2>Alojamentos</h2>
    <p>Visualize a ocupação dos quartos e organize o mapa de planta baixa com arrastar e soltar.</p>
    <div class="mapa-wrapper">
      <div class="mapa-header">
        <div>
          <h3>Mapa de planta baixa (arraste os quadrados)</h3>
          <small>Distribua os quartos em 5 colunas para simular a planta.</small>
        </div>
        <span class="pill">Drag & drop habilitado</span>
      </div>
      <div id="mapa-alojamento" class="mapa-quartos"></div>
      <div class="mapa-rodape">Cada célula representa um espaço da planta. Arraste os quartos para reposicionar.</div>
    </div>
    <div id="leitura-alojamento"></div>
  </div>
  <div class="modo-edicao">
    <h2>Gerenciar Quartos</h2>
    <div class="grid-3">
      <div class="card">
        <h3>Novo quadrado/quarto</h3>
        <form id="formQuarto">
          <input type="text" placeholder="Identificação do quarto" required>
          <input type="number" placeholder="Quantidade de camas/unidades" min="1" required>
          <select id="tipoCama" required>
            <option value="Casal">Cama de casal</option>
            <option value="Solteiro">Cama de solteiro</option>
            <option value="Beliche">Beliche</option>
          </select>
          <input type="number" id="andaresBeliche" placeholder="Andares do beliche" min="2" value="2">
          <button type="submit" class="btn-salvar">Adicionar Quarto</button>
        </form>
      </div>
      <div class="card">
        <h3>Alocar participante</h3>
        <form id="formAlocacao">
          <select id="alocacaoQuarto" required></select>
          <select id="alocacaoParticipante" required></select>
          <button type="submit" class="btn-salvar">Vincular ao quarto</button>
        </form>
        <small>Capacidade considera o tipo da cama: casal = 2 vagas; solteiro = 1 vaga; beliche = andares x beliches.</small>
      </div>
    </div>
    <div id="edicao-alojamento"></div>
  </div>
</section>

<!-- CRONOGRAMA -->
<section id="cronograma" class="view">
  <div class="modo-leitura">
    <h2>Cronograma</h2>
    <div id="cronograma-lista"></div>
  </div>
  <div class="modo-edicao">
    <h2>Adicionar Atividade</h2>
    <form id="formCronograma">
      <input type="datetime-local" required>
      <input type="text" placeholder="Atividade" required>
      <input type="text" placeholder="Responsável" required>
      <button type="submit" class="btn-salvar">Salvar Atividade</button>
    </form>
    <div id="cronograma-edicao"></div>
  </div>
</section>

<!-- CARDÁPIO -->
<section id="cardapio" class="view">
  <div class="modo-leitura">
    <h2>Cardápio e Compras Automáticas</h2>
    <div id="cardapio-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Planejar Refeição</h2>
    <form id="formRefeicao">
      <input type="date" required>
      <select>
        <option>Café</option>
        <option>Almoço</option>
        <option>Jantar</option>
      </select>
      <textarea placeholder="Cardápio detalhado" required></textarea>
      <button type="submit" class="btn-salvar">Salvar Refeição</button>
    </form>
    <div id="cardapio-edicao"></div>
  </div>
</section>

<!-- COMPRAS -->
<section id="compras" class="view">
  <div class="modo-leitura">
    <h2>Solicitações, Aprovações e Pedidos</h2>
    <div id="compras-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Fluxo de Compras</h2>
    <div class="grid-3">
      <div class="card">
        <h3>Solicitar Compra</h3>
        <form id="formSolicitacao">
          <input type="text" placeholder="Item" required>
          <input type="number" placeholder="Quantidade" min="1" required>
          <input type="text" placeholder="Centro de Custo" required>
          <button type="submit" class="btn-salvar">Nova Solicitação</button>
        </form>
      </div>
      <div class="card">
        <h3>Aprovação Orçamentária</h3>
        <form id="formAprovacao">
          <select id="aprovacaoSolicitacao" required></select>
          <input type="number" placeholder="Valor aprovado" min="0" step="0.01" required>
          <button type="submit" class="btn-salvar">Aprovar</button>
        </form>
      </div>
      <div class="card">
        <h3>Registrar Pedido</h3>
        <form id="formPedido">
          <select id="pedidoAprovado" required></select>
          <input type="text" placeholder="Fornecedor" required>
          <button type="submit" class="btn-salvar">Registrar Pedido</button>
        </form>
      </div>
    </div>
    <div id="compras-edicao"></div>
  </div>
</section>

<!-- PALESTRAS -->
<section id="palestras" class="view">
  <div class="modo-leitura">
    <h2>Palestras</h2>
    <div id="palestras-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Programar Palestra</h2>
    <form id="formPalestra">
      <input type="datetime-local" required>
      <input type="text" placeholder="Tema" required>
      <input type="text" placeholder="Palestrante" required>
      <button type="submit" class="btn-salvar">Salvar</button>
    </form>
    <div id="palestras-edicao"></div>
  </div>
</section>

<!-- KIDS -->
<section id="kids" class="view">
  <div class="modo-leitura">
    <h2>Programação Kids</h2>
    <div id="kids-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Adicionar Atividade Kids</h2>
    <form id="formKids">
      <input type="datetime-local" required>
      <input type="text" placeholder="Atividade" required>
      <input type="text" placeholder="Responsável" required>
      <button type="submit" class="btn-salvar">Salvar</button>
    </form>
    <div id="kids-edicao"></div>
  </div>
</section>

<!-- FINANCEIRO -->
<section id="financeiro" class="view">
  <div class="modo-leitura">
    <h2>Financeiro</h2>
    <div id="financeiro-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Atualizar Financeiro</h2>
    <div class="grid-3">
      <div class="card">
        <h3>Totais</h3>
        <form id="formFinanceiro">
          <input type="number" placeholder="Orçado" min="0" step="0.01" required>
          <input type="number" placeholder="Realizado" min="0" step="0.01" required>
          <button type="submit" class="btn-salvar">Salvar Totais</button>
        </form>
      </div>
      <div class="card">
        <h3>Novo Centro de Custo</h3>
        <form id="formCentro">
          <input type="text" placeholder="Centro" required>
          <input type="number" placeholder="Orçado" min="0" step="0.01" required>
          <input type="number" placeholder="Realizado" min="0" step="0.01" required>
          <button type="submit" class="btn-salvar">Adicionar Centro</button>
        </form>
      </div>
    </div>
    <div id="financeiro-edicao"></div>
  </div>
</section>

</main>
</div>

<script>
// =============================================
// DADOS + PERSISTÊNCIA
// =============================================
const DB = {
  usuarios: [],
  logs: [],
  sessao: null,
  familias: [],
  onibus: [],
  voos: [],
  equipes: [],
  projetos: [],
  tarefas: [],
  quartos: [],
  cronograma: [],
  refeicoes: [],
  solicitacoes: [],
  aprovacoes: [],
  pedidos: [],
  palestras: [],
  kids: [],
  financeiro: { orcado: 0, realizado: 0, centros: [] }
};

const MAP_ROWS = 4;
const MAP_COLS = 5;

function posicaoParaIndex(row, col) { return row * MAP_COLS + col; }
function indexParaPosicao(index) { return { row: Math.floor(index / MAP_COLS), col: index % MAP_COLS }; }
function quartoNaPosicao(row, col, ignorarId) {
  return DB.quartos.find(q => q.pos && q.pos.row === row && q.pos.col === col && q.id !== ignorarId);
}
function proximaPosicaoLivre() {
  for (let r = 0; r < MAP_ROWS; r++) {
    for (let c = 0; c < MAP_COLS; c++) {
      if (!quartoNaPosicao(r, c)) return { row: r, col: c };
    }
  }
  return null;
}

function capacidadeQuarto(quarto) {
  if (!quarto) return 0;
  if (quarto.tipo === 'Casal') return (quarto.camas || 0) * 2;
  if (quarto.tipo === 'Beliche') return (quarto.camas || 0) * (quarto.andares || 2);
  return quarto.camas || 0;
}

function ocupacaoQuarto(quarto) {
  if (!quarto || !quarto.ocupantes) return 0;
  return quarto.ocupantes.reduce((total, familiaId) => {
    const familia = DB.familias.find(f => f.id === familiaId);
    return total + (familia ? familia.qtd : 0);
  }, 0);
}

function descricaoTipoQuarto(quarto) {
  if (!quarto) return '—';
  if (quarto.tipo === 'Beliche') return `Beliche (${quarto.andares || 2} andares)`;
  return quarto.tipo === 'Casal' ? 'Cama de casal' : 'Cama de solteiro';
}

function vagasDisponiveis(quarto) {
  return Math.max(capacidadeQuarto(quarto) - ocupacaoQuarto(quarto), 0);
}

function salvar() { /* Dados ficam apenas na sessão atual em formato JSON. */ }
function carregar() { /* Sem persistência em disco. */ }
carregar();

// =============================================
// NAVEGAÇÃO
// =============================================
document.querySelectorAll('.nav-link').forEach(l => {
  l.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
    l.classList.add('active');
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelector(l.getAttribute('href')).classList.add('active');
    atualizarContaUI();
    atualizarLeitura();
    atualizarEdicao();
  });
});

// =============================================
// CONTA E LOGS
// =============================================
let usuarioEditando = null;
let modoConta = 'cadastro';

function registrarLog(acao, detalhe) {
  const entrada = {
    id: Date.now(),
    usuario: DB.sessao ? DB.sessao.usuario : 'anônimo',
    acao,
    detalhe,
    data: new Date().toISOString()
  };
  DB.logs.unshift(entrada);
  renderLogs();
}

function renderLogs() {
  const alvo = document.getElementById('logAlteracoes');
  if (!alvo) return;
  if (!DB.logs.length) {
    alvo.innerHTML = '<p>Nenhuma ação registrada nesta sessão.</p>';
    return;
  }
  alvo.innerHTML = DB.logs.map(log => `<pre>${JSON.stringify(log, null, 2)}</pre>`).join('');
}

function renderUsuarios() {
  const alvo = document.getElementById('usuariosLista');
  if (!alvo) return;
  if (!DB.usuarios.length) {
    alvo.innerHTML = '<p>Nenhum usuário cadastrado.</p>';
    return;
  }
  const linhas = DB.usuarios.map(u => [
    u.nome,
    u.email,
    u.usuario,
    `<button class="btn-editar btn-small" onclick="editarUsuario(${u.id})">Editar</button> <button class="btn-no btn-small" onclick="excluirUsuario(${u.id})">Excluir</button>`
  ]);
  const headers = ['Nome', 'E-mail', 'Usuário', 'Ações'];
  const corpo = linhas.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
  alvo.innerHTML = `<table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${corpo}</tbody></table>`;
}

function atualizarSessaoVisual() {
  const sessao = document.getElementById('sessaoUsuario');
  const perfil = document.getElementById('perfilSelecionado');
  const btnLogout = document.getElementById('btnLogout');
  const acoesSessao = document.getElementById('acoesSessao');
  if (DB.sessao) {
    sessao.textContent = `Logado como ${DB.sessao.nome}`;
    perfil.innerHTML = `<p><strong>E-mail:</strong> ${DB.sessao.email}<br><strong>Usuário:</strong> ${DB.sessao.usuario}</p>`;
    btnLogout.classList.remove('hidden');
    acoesSessao.innerHTML = `
      <button class="btn-editar btn-small" type="button" onclick="editarMinhaConta()">Editar meus dados</button>
      <button class="btn-secondary btn-small" type="button" onclick="executarLogout()">Sair</button>
      <button class="btn-no btn-small" type="button" onclick="excluirMinhaConta()">Excluir conta</button>
    `;
  } else {
    sessao.textContent = 'Nenhum usuário autenticado';
    perfil.textContent = '';
    btnLogout.classList.add('hidden');
    acoesSessao.innerHTML = '';
  }
}

function atualizarContaUI() {
  atualizarSessaoVisual();
  renderUsuarios();
  renderLogs();
  const autenticado = Boolean(DB.sessao);
  const descricao = document.getElementById('contaDescricao');
  const blocos = {
    cadastro: document.getElementById('blocoCadastro'),
    login: document.getElementById('blocoLogin'),
    sessao: document.getElementById('blocoSessao'),
    acoes: document.getElementById('acoesConta'),
    usuarios: document.getElementById('usuariosCard'),
    log: document.getElementById('logCard'),
  };
  if (autenticado) {
    blocos.acoes.classList.add('hidden');
    blocos.cadastro.classList.add('hidden');
    blocos.login.classList.add('hidden');
    blocos.sessao.classList.remove('hidden');
    descricao.textContent = 'Sessão autenticada. Edite ou exclua sua conta e continue navegando pelos módulos.';
    blocos.usuarios.classList.remove('hidden');
    blocos.log.classList.remove('hidden');
  } else {
    blocos.sessao.classList.add('hidden');
    blocos.acoes.classList.remove('hidden');
    blocos.usuarios.classList.add('hidden');
    blocos.log.classList.add('hidden');
    const modoAtual = DB.usuarios.length ? modoConta : 'cadastro';
    modoConta = modoAtual;
    descricao.textContent = modoAtual === 'cadastro'
      ? 'Crie sua conta para começar. Os dados ficam somente nesta sessão.'
      : 'Acesse com seu usuário para editar os módulos.';
    blocos.cadastro.classList.toggle('hidden', modoAtual !== 'cadastro');
    blocos.login.classList.toggle('hidden', modoAtual !== 'login');
  }
}

window.editarUsuario = id => {
  const usuario = DB.usuarios.find(u => u.id === id);
  if (!usuario) return;
  usuarioEditando = usuario.id;
  const form = document.getElementById('formCadastro');
  form[0].value = usuario.nome;
  form[1].value = usuario.email;
  form[2].value = usuario.usuario;
  form[3].value = usuario.senha;
  form.querySelector('button[type="submit"]').textContent = 'Atualizar dados';
};

window.editarMinhaConta = () => {
  if (!DB.sessao) return;
  modoConta = 'cadastro';
  atualizarContaUI();
  editarUsuario(DB.sessao.id);
};

window.excluirMinhaConta = () => {
  if (!DB.sessao) return;
  excluirUsuario(DB.sessao.id);
};

window.excluirUsuario = id => {
  const usuario = DB.usuarios.find(u => u.id === id);
  DB.usuarios = DB.usuarios.filter(u => u.id !== id);
  if (DB.sessao && DB.sessao.id === id) {
    DB.sessao = null;
  }
  registrarLog('excluir_usuario', { usuario: usuario ? usuario.usuario : id });
  usuarioEditando = null;
  atualizarContaUI();
};

document.getElementById('formCadastro').onsubmit = e => {
  e.preventDefault();
  const [nome, email, usuario, senha] = [e.target[0].value, e.target[1].value, e.target[2].value, e.target[3].value];
  if (usuarioEditando) {
    const atual = DB.usuarios.find(u => u.id === usuarioEditando);
    if (atual) {
      atual.nome = nome; atual.email = email; atual.usuario = usuario; atual.senha = senha;
      registrarLog('editar_usuario', { usuario });
    }
  } else {
    DB.usuarios.push({ id: Date.now(), nome, email, usuario, senha });
    registrarLog('criar_usuario', { usuario });
  }
  usuarioEditando = null;
  e.target.reset();
  e.target.querySelector('button[type="submit"]').textContent = 'Registrar';
  atualizarContaUI();
};

document.getElementById('formLogin').onsubmit = e => {
  e.preventDefault();
  const [usuario, senha] = [e.target[0].value, e.target[1].value];
  const encontrado = DB.usuarios.find(u => u.usuario === usuario && u.senha === senha);
  if (!encontrado) return alert('Usuário ou senha inválidos.');
  DB.sessao = { id: encontrado.id, nome: encontrado.nome, email: encontrado.email, usuario: encontrado.usuario };
  registrarLog('login', { usuario });
  atualizarContaUI();
};

function executarLogout() {
  if (!DB.sessao) return;
  registrarLog('logout', { usuario: DB.sessao.usuario });
  DB.sessao = null;
  atualizarContaUI();
}

document.getElementById('btnLogout').onclick = executarLogout;

document.querySelectorAll('[data-modo-conta]').forEach(botao => {
  botao.addEventListener('click', () => {
    modoConta = botao.dataset.modoConta;
    atualizarContaUI();
  });
});

// =============================================
// ATUALIZAR TELAS
// =============================================
function formatarDataHora(valor) {
  return new Date(valor).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
}

function atualizarLeitura() {
  const total = DB.familias.reduce((s, f) => s + f.qtd, 0);
  document.getElementById('paxTotal').textContent = total;
  document.getElementById('onibusTotal').textContent = DB.onibus.length;
  document.getElementById('voosTotal').textContent = DB.voos.length;
  const quartosOcupados = DB.quartos.filter(q => ocupacaoQuarto(q) > 0).length;
  const capacidadeTotal = DB.quartos.reduce((s, q) => s + capacidadeQuarto(q), 0);
  const vagasUsadas = DB.quartos.reduce((s, q) => s + ocupacaoQuarto(q), 0);
  document.getElementById('quartosInfo').innerHTML = `${quartosOcupados} / ${DB.quartos.length} quartos • ${vagasUsadas}/${capacidadeTotal} vagas`;
  document.getElementById('orcado').textContent = DB.financeiro.orcado.toFixed(2).replace('.', ',');
  document.getElementById('realizado').textContent = DB.financeiro.realizado.toFixed(2).replace('.', ',');

  const buildTable = (titulo, headers, rows, vazio) => {
    const corpo = rows.length
      ? rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')
      : `<tr><td colspan="${headers.length}">${vazio}</td></tr>`;
    return `
      <div class="table-group">
        <h3>${titulo}</h3>
        <table>
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
          <tbody>${corpo}</tbody>
        </table>
      </div>`;
  };

  document.getElementById('lista-participantes-leitura').innerHTML =
    buildTable('Famílias inscritas', ['Responsável', 'Pessoas', 'Cidade/Estado'],
      DB.familias.map(f => [f.nome, `${f.qtd}`, f.cidade]),
      'Nenhum participante cadastrado.');

  document.getElementById('equipes-lista').innerHTML = [
    buildTable('Equipes', ['Equipe', 'Responsável', 'Membros'],
      DB.equipes.map(eq => [eq.nome, eq.responsavel, eq.membros || '—']),
      'Nenhuma equipe cadastrada.'),
    buildTable('Projetos por equipe', ['Projeto', 'Equipe', 'Prazo', 'Status'],
      DB.projetos.map(p => [p.nome, (DB.equipes.find(e => e.id === p.equipeId) || {}).nome || '—', p.prazo || '—', p.status]),
      'Nenhum projeto cadastrado.'),
    buildTable('Tarefas (Kanban)', ['Tarefa', 'Projeto', 'Status'],
      DB.tarefas.map(t => [t.titulo, (DB.projetos.find(p => p.id === t.projetoId) || {}).nome || '—', t.status]),
      'Nenhuma tarefa registrada.')
  ].join('');

  document.getElementById('leitura-transporte').innerHTML = [
    buildTable(`Ônibus (${DB.onibus.length})`, ['Origem', 'Passageiros', 'Empresa', 'Data/Hora'],
      DB.onibus.map(o => [o.cidade, `${o.qtd}`, o.empresa, formatarDataHora(o.data)]),
      'Nenhum ônibus cadastrado.'),
    buildTable(`Voos (${DB.voos.length})`, ['Passageiro', 'Voo', 'Data/Hora'],
      DB.voos.map(v => [v.passageiro, v.voo, formatarDataHora(v.data)]),
      'Nenhum voo cadastrado.')
  ].join('');

  const renderMapa = () => {
    const container = document.getElementById('mapa-alojamento');
    if (!container) return;
    if (!DB.quartos.length) {
      container.innerHTML = '<p>Nenhum quarto cadastrado.</p>';
      return;
    }

    const quartoCard = q => {
      const ocupantes = (q.ocupantes || []).map(id => {
        const familia = DB.familias.find(f => f.id === id);
        return familia ? `${familia.nome} (${familia.qtd}p)` : 'Participante removido';
      }).join('<br>') || 'Nenhum participante vinculado';
      const classe = vagasDisponiveis(q) > 0 ? 'disponivel' : 'cheio';
      return `<div class="quarto-card ${classe}" draggable="true" data-id="${q.id}">
        <div>
          <h4>${q.nome}</h4>
          <small>${descricaoTipoQuarto(q)} • ${capacidadeQuarto(q)} vagas</small>
          <div class="ocupantes">${ocupantes}</div>
        </div>
        <div class="vagas">${ocupacaoQuarto(q)}/${capacidadeQuarto(q)} vagas usadas</div>
      </div>`;
    };

    DB.quartos.forEach(q => {
      if (!q.pos) {
        const livre = proximaPosicaoLivre();
        if (livre) q.pos = livre;
      }
    });

    const celulas = Array.from({ length: MAP_ROWS * MAP_COLS }, (_, idx) => {
      const { row, col } = indexParaPosicao(idx);
      const quarto = quartoNaPosicao(row, col);
      const card = quarto ? quartoCard(quarto) : '';
      return `<div class="mapa-celula" data-idx="${idx}">${card}</div>`;
    }).join('');

    container.innerHTML = celulas;

    container.querySelectorAll('.quarto-card').forEach(card => {
      card.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/quarto', card.dataset.id);
      });
    });

    container.querySelectorAll('.mapa-celula').forEach(cell => {
      cell.addEventListener('dragover', e => { e.preventDefault(); cell.classList.add('drag-over'); });
      cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
      cell.addEventListener('drop', e => {
        e.preventDefault();
        cell.classList.remove('drag-over');
        const id = Number(e.dataTransfer.getData('text/quarto'));
        if (!id) return;
        const { row, col } = indexParaPosicao(Number(cell.dataset.idx));
        const quarto = DB.quartos.find(q => q.id === id);
        if (!quarto) return;
        const atual = quarto.pos || null;
        const ocupanteDestino = quartoNaPosicao(row, col, id);
        quarto.pos = { row, col };
        if (ocupanteDestino) {
          ocupanteDestino.pos = atual || proximaPosicaoLivre() || ocupanteDestino.pos;
        }
        atualizarLeitura();
        atualizarEdicao();
        salvar();
      });
    });
  };

  renderMapa();

  document.getElementById('leitura-alojamento').innerHTML = buildTable('Quartos e ocupação', ['Quarto', 'Capacidade total', 'Tipo de cama', 'Ocupação'],
    DB.quartos.map(q => {
      const ocupantes = (q.ocupantes || []).map(id => {
        const familia = DB.familias.find(f => f.id === id);
        return familia ? `${familia.nome} (${familia.qtd}p)` : 'Participante removido';
      }).join('<br>') || 'Sem participantes vinculados.';
      return [q.nome, `${capacidadeQuarto(q)} vagas`, descricaoTipoQuarto(q), `${ocupacaoQuarto(q)}/${capacidadeQuarto(q)} pessoas<br><small>${ocupantes}</small>`];
    }),
    'Nenhum quarto cadastrado.');

  const eventos = [...DB.cronograma].sort((a, b) => new Date(a.data) - new Date(b.data));
  document.getElementById('cronograma-lista').innerHTML = buildTable('Cronograma', ['Data', 'Atividade', 'Responsável'],
    eventos.map(e => [formatarDataHora(e.data), e.titulo, e.responsavel]),
    'Cronograma vazio.');

  document.getElementById('cardapio-leitura').innerHTML = buildTable('Refeições planejadas', ['Data', 'Tipo', 'Cardápio'],
    DB.refeicoes.map(r => [r.data, r.tipo, `${r.descricao}<br><small>Lista automática: frutas, proteínas, bebidas</small>`]),
    'Nenhuma refeição planejada.');

  document.getElementById('compras-leitura').innerHTML = [
    buildTable('Solicitações', ['Item', 'Quantidade', 'Centro de custo'],
      DB.solicitacoes.map(s => [s.item, s.qtd, s.centro]),
      'Sem solicitações.'),
    buildTable('Aprovações', ['Item', 'Qtd', 'Valor aprovado'],
      DB.aprovacoes.map(a => [a.item, a.qtd, `R$ ${a.valor.toFixed(2)}`]),
      'Sem aprovações.'),
    buildTable('Pedidos', ['Item', 'Fornecedor'],
      DB.pedidos.map(p => [p.item, p.fornecedor]),
      'Sem pedidos registrados.')
  ].join('');

  document.getElementById('palestras-leitura').innerHTML = buildTable('Palestras', ['Data/Hora', 'Tema', 'Palestrante'],
    DB.palestras.map(p => [formatarDataHora(p.data), p.tema, p.palestrante]),
    'Nenhuma palestra cadastrada.');

  document.getElementById('kids-leitura').innerHTML = buildTable('Programação Kids', ['Data/Hora', 'Atividade', 'Responsável'],
    DB.kids.map(k => [formatarDataHora(k.data), k.atividade, k.responsavel]),
    'Sem atividades kids.');

  const fluxoPagamentos = DB.aprovacoes.reduce((s, a) => s + a.valor, 0);
  const centros = DB.financeiro.centros;
  document.getElementById('financeiro-leitura').innerHTML = `
    <div class="card">
      <strong>Orçado:</strong> R$ ${DB.financeiro.orcado.toFixed(2)}<br>
      <strong>Realizado:</strong> R$ ${DB.financeiro.realizado.toFixed(2)}<br>
      <small>Pagamentos lançados pelos módulos somam R$ ${fluxoPagamentos.toFixed(2)}.</small>
    </div>
    ${buildTable('Centros de Custo', ['Centro', 'Orçado', 'Realizado'],
      centros.map(c => [c.nome, `R$ ${c.orcado.toFixed(2)}`, `R$ ${c.realizado.toFixed(2)}`]),
      'Nenhum centro cadastrado.')}
    <p class="nota-dependencia">A maioria das informações é derivada dos cadastros de participantes. O financeiro consolida pagamentos informados pelos módulos de compras, logística e alimentação.</p>
  `;
}

function setSelectOptions(selectId, items, labelFn) {
  const select = document.getElementById(selectId);
  if (!select) return;
  select.innerHTML = '<option value="" disabled selected>Selecione</option>' + items.map(i => `<option value="${i.id}">${labelFn(i)}</option>`).join('');
}

function atualizarEdicao() {
  const buildTable = (titulo, headers, rows, vazio) => {
    const corpo = rows.length
      ? rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')
      : `<tr><td colspan="${headers.length}">${vazio}</td></tr>`;
    return `
      <div class="table-group">
        <h3>${titulo}</h3>
        <table>
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
          <tbody>${corpo}</tbody>
        </table>
      </div>`;
  };

  setSelectOptions('projetoEquipe', DB.equipes, e => e.nome);
  setSelectOptions('tarefaProjeto', DB.projetos, p => p.nome);
  setSelectOptions('aprovacaoSolicitacao', DB.solicitacoes, s => `${s.item} (${s.qtd} un)`);
  setSelectOptions('pedidoAprovado', DB.aprovacoes, a => `${a.item} - R$ ${a.valor.toFixed(2)}`);
  setSelectOptions('alocacaoQuarto', DB.quartos, q => `${q.nome} • ${vagasDisponiveis(q)} vagas livres`);
  setSelectOptions('alocacaoParticipante', DB.familias, f => `${f.nome} (${f.qtd} pessoas)`);
  const financeiroForm = document.getElementById('formFinanceiro');
  if (financeiroForm) {
    financeiroForm[0].value = DB.financeiro.orcado;
    financeiroForm[1].value = DB.financeiro.realizado;
  }

  document.getElementById('lista-participantes-edicao').innerHTML = buildTable('Famílias', ['Responsável', 'Pessoas', 'Cidade', 'Ações'],
    DB.familias.map(f => [f.nome, f.qtd, f.cidade, `<button class="btn-no btn-small" onclick="removerFamilia(${f.id})">Remover</button>`]),
    'Nenhum participante cadastrado.');

  document.getElementById('equipes-edicao').innerHTML = [
    buildTable('Equipes', ['Equipe', 'Responsável', 'Membros', 'Ações'],
      DB.equipes.map(eq => [eq.nome, eq.responsavel, eq.membros || '—', `<button class="btn-no btn-small" onclick="removerEquipe(${eq.id})">Excluir</button>`]),
      'Nenhuma equipe cadastrada.'),
    buildTable('Projetos', ['Projeto', 'Equipe', 'Status'],
      DB.projetos.map(p => [p.nome, (DB.equipes.find(e => e.id === p.equipeId) || {}).nome || '—', p.status]),
      'Nenhum projeto cadastrado.'),
    buildTable('Tarefas', ['Tarefa', 'Projeto', 'Status'],
      DB.tarefas.map(t => [t.titulo, (DB.projetos.find(p => p.id === t.projetoId) || {}).nome || '—', t.status]),
      'Nenhuma tarefa registrada.')
  ].join('');

  document.getElementById('edicao-transporte').innerHTML = [
    buildTable('Ônibus', ['Origem', 'Passageiros', 'Empresa', 'Data/Hora', 'Ações'],
      DB.onibus.map(o => [o.cidade, o.qtd, o.empresa, formatarDataHora(o.data), `<button class="btn-no btn-small" onclick=\"removerOnibus(${o.id})\">Remover</button>`]),
      'Nenhum ônibus cadastrado.'),
    buildTable('Voos', ['Passageiro', 'Voo', 'Data/Hora', 'Ações'],
      DB.voos.map(v => [v.passageiro, v.voo, formatarDataHora(v.data), `<button class="btn-no btn-small" onclick=\"removerVoo(${v.id})\">Remover</button>`]),
      'Nenhum voo cadastrado.')
  ].join('');

  document.getElementById('edicao-alojamento').innerHTML = buildTable('Quartos', ['Quarto', 'Camas e tipo', 'Ocupação', 'Ações'],
    DB.quartos.map(q => {
      const ocupantes = (q.ocupantes || []).map(id => {
        const familia = DB.familias.find(f => f.id === id);
        const nome = familia ? `${familia.nome} (${familia.qtd}p)` : 'Participante removido';
        return `<span class="tag-ocupante">${nome}<button title="Remover" onclick="desvincularParticipante(${q.id}, ${id})">×</button></span>`;
      }).join('');
      const ocupacao = `${ocupacaoQuarto(q)}/${capacidadeQuarto(q)} pessoas` + (ocupantes ? `<div>${ocupantes}</div>` : '<div class="ocupantes">Sem participantes.</div>');
      return [q.nome, `${q.camas} • ${descricaoTipoQuarto(q)}`, ocupacao, `<button class="btn-no btn-small" onclick="removerQuarto(${q.id})">Remover</button>`];
    }),
    'Nenhum quarto cadastrado.');

  document.getElementById('cronograma-edicao').innerHTML = buildTable('Atividades', ['Data/Hora', 'Atividade', 'Responsável', 'Ações'],
    DB.cronograma.map(e => [formatarDataHora(e.data), e.titulo, e.responsavel, `<button class="btn-no btn-small" onclick="removerCronograma(${e.id})">Remover</button>`]),
    'Cronograma vazio.');

  document.getElementById('cardapio-edicao').innerHTML = buildTable('Refeições', ['Data', 'Tipo', 'Cardápio', 'Ações'],
    DB.refeicoes.map(r => [r.data, r.tipo, r.descricao, `<button class="btn-no btn-small" onclick="removerRefeicao(${r.id})">Remover</button>`]),
    'Nenhuma refeição planejada.');

  document.getElementById('compras-edicao').innerHTML = [
    buildTable('Solicitações', ['Item', 'Qtd', 'Centro', 'Ações'],
      DB.solicitacoes.map(s => [s.item, s.qtd, s.centro, `<button class="btn-no btn-small" onclick="removerSolicitacao(${s.id})">Remover</button>`]),
      'Sem solicitações.'),
    buildTable('Aprovações', ['Item', 'Qtd', 'Valor', 'Ações'],
      DB.aprovacoes.map(a => [a.item, a.qtd, `R$ ${a.valor.toFixed(2)}`, `<button class="btn-no btn-small" onclick="removerAprovacao(${a.id})">Remover</button>`]),
      'Sem aprovações.'),
    buildTable('Pedidos', ['Item', 'Fornecedor', 'Ações'],
      DB.pedidos.map(p => [p.item, p.fornecedor, `<button class="btn-no btn-small" onclick="removerPedido(${p.id})">Remover</button>`]),
      'Sem pedidos registrados.')
  ].join('');

  document.getElementById('palestras-edicao').innerHTML = buildTable('Palestras', ['Tema', 'Palestrante', 'Ações'],
    DB.palestras.map(p => [p.tema, p.palestrante, `<button class="btn-no btn-small" onclick="removerPalestra(${p.id})">Remover</button>`]),
    'Nenhuma palestra cadastrada.');

  document.getElementById('kids-edicao').innerHTML = buildTable('Atividades Kids', ['Atividade', 'Responsável', 'Ações'],
    DB.kids.map(k => [k.atividade, k.responsavel, `<button class="btn-no btn-small" onclick="removerKids(${k.id})">Remover</button>`]),
    'Sem atividades kids.');

  document.getElementById('financeiro-edicao').innerHTML = buildTable('Centros de custo', ['Centro', 'Orçado', 'Realizado', 'Ações'],
    DB.financeiro.centros.map(c => [c.nome, `R$ ${c.orcado.toFixed(2)}`, `R$ ${c.realizado.toFixed(2)}`, `<button class="btn-no btn-small" onclick="removerCentro(${c.id})">Remover</button>`]),
    'Nenhum centro cadastrado.');
}

// =============================================
// CADASTROS (exemplo participantes e transporte)
// =============================================
document.getElementById('formFamilia').onsubmit = e => {
  e.preventDefault();
  const [nome, qtd, cidade] = [e.target[0].value, +e.target[1].value, e.target[2].value];
  DB.familias.push({ id: Date.now(), nome, qtd, cidade });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formEquipe').onsubmit = e => {
  e.preventDefault();
  const [nome, responsavel, membros] = [e.target[0].value, e.target[1].value, e.target[2].value];
  DB.equipes.push({ id: Date.now(), nome, responsavel, membros });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formProjeto').onsubmit = e => {
  e.preventDefault();
  const [nome, equipeId, prazo, status] = [e.target[0].value, e.target[1].value, e.target[2].value, e.target[3].value];
  if (!equipeId) return alert('Selecione uma equipe para vincular o projeto.');
  DB.projetos.push({ id: Date.now(), nome, equipeId: Number(equipeId), prazo, status });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formTarefa').onsubmit = e => {
  e.preventDefault();
  const [titulo, projetoId, status] = [e.target[0].value, e.target[1].value, e.target[2].value];
  if (!projetoId) return alert('Selecione um projeto para a tarefa.');
  DB.tarefas.push({ id: Date.now(), titulo, projetoId: Number(projetoId), status });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formOnibus').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.onibus.push({id:Date.now(), cidade:i[0].value, qtd:+i[1].value, empresa:i[2].value, data:i[3].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formVoo').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.voos.push({id:Date.now(), passageiro:i[0].value, voo:i[1].value, data:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

document.getElementById('formQuarto').onsubmit = e => {
  e.preventDefault();
  const i = e.target.elements;
  const tipo = document.getElementById('tipoCama').value;
  const andares = tipo === 'Beliche' ? Number(document.getElementById('andaresBeliche').value || 2) : null;
  const pos = proximaPosicaoLivre();
  if (!pos) return alert('Mapa cheio: não há mais células livres para novos quartos.');
  DB.quartos.push({ id: Date.now(), nome: i[0].value, camas: +i[1].value, tipo, andares, ocupantes: [], pos });
  e.target.reset();
  if (typeof toggleAndares === 'function') toggleAndares();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formAlocacao').onsubmit = e => {
  e.preventDefault();
  const quartoId = Number(document.getElementById('alocacaoQuarto').value);
  const familiaId = Number(document.getElementById('alocacaoParticipante').value);
  const quarto = DB.quartos.find(q => q.id === quartoId);
  const familia = DB.familias.find(f => f.id === familiaId);
  if (!quarto || !familia) return alert('Selecione um quarto e um participante válidos.');
  if (!quarto.ocupantes) quarto.ocupantes = [];
  if (quarto.ocupantes.includes(familiaId)) return alert('Esse participante já está vinculado ao quarto.');
  if (ocupacaoQuarto(quarto) + familia.qtd > capacidadeQuarto(quarto)) return alert('Capacidade insuficiente para essa família neste quarto.');
  quarto.ocupantes.push(familiaId);
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

const tipoCamaSelect = document.getElementById('tipoCama');
const andaresInput = document.getElementById('andaresBeliche');
let toggleAndares = null;
if (tipoCamaSelect && andaresInput) {
  toggleAndares = () => {
    const isBeliche = tipoCamaSelect.value === 'Beliche';
    andaresInput.style.display = isBeliche ? 'block' : 'none';
    andaresInput.disabled = !isBeliche;
  };
  tipoCamaSelect.addEventListener('change', toggleAndares);
  toggleAndares();
}

document.getElementById('formCronograma').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.cronograma.push({id:Date.now(), data:i[0].value, titulo:i[1].value, responsavel:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

document.getElementById('formRefeicao').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.refeicoes.push({id:Date.now(), data:i[0].value, tipo:i[1].value, descricao:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

document.getElementById('formSolicitacao').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.solicitacoes.push({id:Date.now(), item:i[0].value, qtd:+i[1].value, centro:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formAprovacao').onsubmit = e => { e.preventDefault(); const i = e.target.elements; if(!i[0].value) return alert('Escolha uma solicitação.'); const solicitacao = DB.solicitacoes.find(s=>s.id===Number(i[0].value)); DB.aprovacoes.push({id:Date.now(), item:solicitacao.item, qtd:solicitacao.qtd, valor:+i[1].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formPedido').onsubmit = e => { e.preventDefault(); const i = e.target.elements; if(!i[0].value) return alert('Escolha uma aprovação.'); const aprovacao = DB.aprovacoes.find(a=>a.id===Number(i[0].value)); DB.pedidos.push({id:Date.now(), item:aprovacao.item, fornecedor:i[1].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

document.getElementById('formPalestra').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.palestras.push({id:Date.now(), data:i[0].value, tema:i[1].value, palestrante:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formKids').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.kids.push({id:Date.now(), data:i[0].value, atividade:i[1].value, responsavel:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formFinanceiro').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.financeiro.orcado = +i[0].value; DB.financeiro.realizado = +i[1].value; atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formCentro').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.financeiro.centros.push({id:Date.now(), nome:i[0].value, orcado:+i[1].value, realizado:+i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

window.removerFamilia = id => { DB.familias = DB.familias.filter(f=>f.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerEquipe = id => { DB.equipes = DB.equipes.filter(e=>e.id!==id); DB.projetos = DB.projetos.filter(p=>p.equipeId!==id); DB.tarefas = DB.tarefas.filter(t=>DB.projetos.some(p=>p.id===t.projetoId)); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerOnibus = id => { DB.onibus = DB.onibus.filter(o=>o.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerVoo = id => { DB.voos = DB.voos.filter(v=>v.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.desvincularParticipante = (quartoId, familiaId) => {
  const quarto = DB.quartos.find(q => q.id === quartoId);
  if (!quarto || !quarto.ocupantes) return;
  quarto.ocupantes = quarto.ocupantes.filter(id => id !== familiaId);
  atualizarLeitura(); atualizarEdicao(); salvar();
};
window.removerQuarto = id => { DB.quartos = DB.quartos.filter(q=>q.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerCronograma = id => { DB.cronograma = DB.cronograma.filter(c=>c.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerRefeicao = id => { DB.refeicoes = DB.refeicoes.filter(r=>r.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerSolicitacao = id => { DB.solicitacoes = DB.solicitacoes.filter(s=>s.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerAprovacao = id => { DB.aprovacoes = DB.aprovacoes.filter(a=>a.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerPedido = id => { DB.pedidos = DB.pedidos.filter(p=>p.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerPalestra = id => { DB.palestras = DB.palestras.filter(p=>p.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerKids = id => { DB.kids = DB.kids.filter(k=>k.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerCentro = id => { DB.financeiro.centros = DB.financeiro.centros.filter(c=>c.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };

// =============================================
// INICIALIZAÇÃO
// =============================================
atualizarContaUI();
atualizarLeitura();
atualizarEdicao();
</script>
</body>
</html>
