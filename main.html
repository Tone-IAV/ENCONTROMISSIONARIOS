<? function include(filename) { return HtmlService.createHtmlOutputFromFile(filename).getContent(); } ?>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gest√£o do Encontro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --base:#0f172a;
      --accent:#0f766e;
      --accent-strong:#2563eb;
      --surface:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#f5f5f4;
      --pill:#e0f2fe;
      --warning:#f97316;
    }

    * { box-sizing:border-box; }
    body { margin:0; font-family:"Inter", system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--base); }
    header { background:#0f3d2e; color:white; padding:1.5rem 1rem; text-align:center; }
    header h1 { margin:0 0 0.25rem; font-size:1.5rem; }
    header p { margin:0; color:#d1fae5; font-size:0.95rem; }

    nav { background:#134e3a; position:sticky; top:0; z-index:10; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    nav ul { margin:0; padding:0.75rem 1rem; list-style:none; display:flex; flex-wrap:wrap; gap:0.5rem; }
    nav a { color:white; text-decoration:none; padding:0.55rem 0.85rem; border-radius:0.6rem; font-weight:700; font-size:0.95rem; display:inline-block; }
    nav a.active { background:var(--surface); color:#134e3a; }
    nav a:focus-visible { outline:2px solid white; outline-offset:2px; }

    main { max-width:1100px; margin:0 auto; padding:1.5rem 1rem 2.5rem; }

    .section-card { background:var(--surface); border:1px solid var(--line); border-radius:0.9rem; padding:1rem 1.1rem; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom:1rem; }
    .section-card h2 { margin:0 0 0.35rem; font-size:1.25rem; }
    .section-card h3 { margin:0 0 0.25rem; font-size:1.05rem; }
    .small-note { color:var(--muted); font-size:0.95rem; margin:0 0 0.65rem; }
    .eyebrow { text-transform:uppercase; letter-spacing:0.08em; font-size:0.85rem; color:var(--muted); margin:0 0 0.35rem; font-weight:700; }

    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:0.85rem; }
    label { display:flex; flex-direction:column; gap:0.35rem; font-weight:650; color:var(--base); }
    input, select, textarea { width:100%; padding:0.65rem 0.75rem; border:1px solid var(--line); border-radius:0.55rem; font-size:1rem; background:var(--surface); }
    textarea { min-height:110px; resize:vertical; }
    button { padding:0.65rem 1rem; border:none; border-radius:0.55rem; background:var(--accent); color:white; font-weight:800; cursor:pointer; transition:background 0.15s ease; }
    button:hover { background:#0a5f59; }

    .list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:0.65rem; }
    .list li { background:#f8fafc; border:1px solid var(--line); border-radius:0.65rem; padding:0.75rem 0.85rem; line-height:1.4; }

    .inline { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; }
    .inline.gap-sm { gap:0.35rem; }
    .stacked { display:flex; flex-direction:column; gap:0.85rem; }
    .view { display:none; }
    .view.active { display:block; }

    .stat-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:0.75rem; margin:0.75rem 0; }
    .stat-card { background:#ecfdf3; border:1px solid #bbf7d0; border-radius:0.75rem; padding:0.75rem 0.85rem; }
    .stat-card span { color:var(--muted); font-size:0.9rem; display:block; margin-bottom:0.3rem; }
    .stat-card strong { font-size:1.3rem; }

    .primary-btn { padding:0.75rem 1rem; border:none; border-radius:0.65rem; background:var(--accent-strong); color:white; font-weight:800; cursor:pointer; transition:transform 0.1s ease, box-shadow 0.2s; box-shadow:0 10px 30px rgba(37,99,235,0.18); }
    .primary-btn:hover { transform:translateY(-1px); }
    .ghost-btn { padding:0.7rem 0.95rem; border:1px solid var(--line); border-radius:0.65rem; background:var(--surface); color:var(--base); font-weight:700; cursor:pointer; }
    .ghost-btn:hover { background:#f8fafc; }
    .participants-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    .category-shell { display:flex; flex-direction:column; gap:0.75rem; }
    .category-tabs { display:flex; gap:0.5rem; flex-wrap:wrap; }
    .category-tab { padding:0.65rem 0.85rem; border:1px solid var(--line); border-radius:0.65rem; background:var(--surface); cursor:pointer; display:flex; gap:0.5rem; align-items:center; font-weight:700; }
    .category-tab .chip { background:var(--pill); color:#1d4ed8; padding:0.15rem 0.45rem; border-radius:999px; font-size:0.8rem; border:1px solid #bfdbfe; }
    .category-tab.active { border-color:var(--accent-strong); box-shadow:0 10px 30px rgba(37,99,235,0.12); }
    .category-summary { display:flex; gap:0.75rem; flex-wrap:wrap; }
    .summary-pill { padding:0.55rem 0.9rem; border-radius:999px; background:#ecfdf3; border:1px solid #bbf7d0; font-weight:700; color:#065f46; }
    .participants-board { display:flex; flex-direction:column; gap:0.5rem; }
    .board-head { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    .search-field input { border:1px solid var(--line); border-radius:0.55rem; padding:0.65rem 0.75rem; min-width:260px; }
    .participants-table { border:1px solid var(--line); border-radius:0.85rem; overflow:hidden; }
    .participants-header, .participant-row { display:grid; grid-template-columns:2fr 0.8fr 1fr 1fr 0.6fr; padding:0.65rem 0.85rem; align-items:center; }
    .participants-header { background:#f8fafc; font-weight:750; color:var(--muted); }
    .participants-rows { display:flex; flex-direction:column; }
    .participant-row { border-top:1px solid var(--line); gap:0.35rem; cursor:pointer; }
    .participant-row:hover { background:#f9fafb; }
    .align-right { text-align:right; }
    .member-count { display:inline-flex; align-items:center; justify-content:center; padding:0.25rem 0.6rem; background:#eef2ff; color:#4f46e5; border-radius:999px; font-weight:800; }
    .category-tag { display:inline-flex; align-items:center; gap:0.35rem; padding:0.35rem 0.55rem; border-radius:0.55rem; background:#eff6ff; color:#1d4ed8; font-weight:750; border:1px solid #dbeafe; }
    .category-tag .totals { color:#2563eb; font-size:0.85rem; }
    .family-link { font-size:0.9rem; color:var(--muted); display:flex; gap:0.35rem; align-items:center; }
    .family-branch { border-left:2px solid var(--line); margin-left:1rem; padding-left:1rem; display:flex; flex-direction:column; gap:0.35rem; }
    .family-member { display:flex; justify-content:space-between; align-items:center; padding:0.45rem 0.65rem; background:#f8fafc; border:1px dashed var(--line); border-radius:0.65rem; }
    .family-member strong { display:flex; gap:0.35rem; align-items:center; }

    .detail-shell { display:grid; grid-template-columns:280px 1fr; gap:0.8rem; }
    .family-panel { border:1px solid var(--line); border-radius:0.85rem; padding:0.85rem; background:#f8fafc; display:flex; flex-direction:column; gap:0.65rem; }
    .family-list { display:flex; flex-direction:column; gap:0.4rem; }
    .family-chip { padding:0.55rem 0.7rem; border-radius:0.65rem; background:var(--surface); border:1px solid var(--line); cursor:pointer; }
    .family-chip.active { border-color:var(--accent-strong); background:#eef2ff; }
    .detail-panel { border:1px solid var(--line); border-radius:0.85rem; padding:1rem; background:var(--surface); min-height:200px; }
    .detail-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    .detail-meta { display:flex; gap:0.5rem; flex-wrap:wrap; }
    .token-box { padding:0.65rem 0.85rem; border-radius:0.75rem; background:#f8fafc; border:1px solid var(--line); text-align:center; }
    .data-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:0.75rem; margin-top:0.85rem; }
    .data-card { border:1px solid var(--line); border-radius:0.75rem; padding:0.65rem 0.8rem; background:#f9fafb; }
    .history-list { list-style:none; margin:0.5rem 0 0; padding:0; display:flex; flex-direction:column; gap:0.35rem; }
    .empty-detail { color:var(--muted); }

    .modal { position:fixed; inset:0; background:rgba(15,23,42,0.55); display:none; align-items:flex-start; justify-content:center; padding:2rem 1rem; overflow:auto; z-index:50; }
    .modal[aria-hidden="false"] { display:flex; }
    .modal-content { background:var(--surface); border-radius:1rem; padding:1rem; max-width:780px; width:100%; box-shadow:0 20px 70px rgba(0,0,0,0.18); }
    .modal-content.wide { max-width:960px; }
    .modal-head { display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:0.75rem; }
    .modal-actions { display:flex; justify-content:flex-end; gap:0.5rem; }
    .family-grid { display:flex; flex-direction:column; gap:0.5rem; }
    .family-card { border:1px dashed var(--line); padding:0.65rem; border-radius:0.75rem; background:#f8fafc; }
    .section-divider { display:flex; justify-content:space-between; align-items:center; gap:1rem; padding:0.5rem 0; border-top:1px solid var(--line); border-bottom:1px solid var(--line); }
    .custom-section { display:flex; flex-direction:column; gap:0.65rem; }
    .custom-block { border:1px solid var(--line); border-radius:0.75rem; padding:0.65rem; background:#f9fafb; }
    .builder-sections { display:flex; flex-direction:column; gap:0.75rem; }
    .builder-section { border:1px solid var(--line); border-radius:0.85rem; padding:0.75rem; background:#f8fafc; display:flex; flex-direction:column; gap:0.65rem; }
    .builder-fields { display:flex; flex-direction:column; gap:0.5rem; }
    .builder-field { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:0.5rem; align-items:flex-end; }
    .chip { display:inline-flex; align-items:center; padding:0.25rem 0.55rem; border-radius:999px; background:#eef2ff; color:#4338ca; font-weight:700; }
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    @media (max-width:960px) {
      .participants-header, .board-head { flex-direction:column; align-items:flex-start; }
      .detail-shell { grid-template-columns:1fr; }
      .participants-header .inline, .board-head .inline { width:100%; }
      .participant-row, .participants-header { grid-template-columns:1.5fr 0.8fr 1fr 1fr; }
      .participant-row span:last-child, .participants-header span:last-child { display:none; }
    }

    @media (max-width:720px) {
      nav ul { overflow-x:auto; }
      nav a { white-space:nowrap; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Gest√£o do Encontro</h1>
    <p>Layout simplificado, pronto para receber dados reais.</p>
  </header>

  <nav>
    <ul>
      <li><a href="#conta" class="nav-link active">Conta</a></li>
      <li><a href="#dashboard" class="nav-link">Dashboard</a></li>
      <li><a href="#equipes" class="nav-link">Equipes</a></li>
      <li><a href="#participantes" class="nav-link">Participantes</a></li>
      <li><a href="#embarque-checkin" class="nav-link">Embarque</a></li>
      <li><a href="#transporte" class="nav-link">Transporte</a></li>
      <li><a href="#alojamento" class="nav-link">Alojamento</a></li>
      <li><a href="#cronograma" class="nav-link">Cronograma</a></li>
      <li><a href="#cardapio" class="nav-link">Card√°pio</a></li>
      <li><a href="#compras" class="nav-link">Compras</a></li>
      <li><a href="#palestras" class="nav-link">Palestras</a></li>
      <li><a href="#kids" class="nav-link">Kids</a></li>
      <li><a href="#financeiro" class="nav-link">Financeiro</a></li>
    </ul>
  </nav>

  <main>
    <?!= include('conta'); ?>
    <?!= include('dashboard'); ?>
    <?!= include('equipes'); ?>
    <?!= include('participantes'); ?>
    <?!= include('embarque-checkin'); ?>
    <?!= include('transporte'); ?>
    <?!= include('alojamento'); ?>
    <?!= include('cronograma'); ?>
    <?!= include('cardapio'); ?>
    <?!= include('compras'); ?>
    <?!= include('palestras'); ?>
    <?!= include('kids'); ?>
    <?!= include('financeiro'); ?>
  </main>

  <script>
    const navLinks = Array.from(document.querySelectorAll('.nav-link'));
    const views = Array.from(document.querySelectorAll('.view'));

    const activateView = (hash) => {
      const target = document.querySelector(hash);
      if (!target) return;
      navLinks.forEach(link => link.classList.toggle('active', link.getAttribute('href') === hash));
      views.forEach(view => view.classList.toggle('active', '#' + view.id === hash));
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    navLinks.forEach(link => link.addEventListener('click', (event) => {
      event.preventDefault();
      activateView(link.getAttribute('href'));
    }));

    if (views.length) {
      views[0].classList.add('active');
    }

    const setupForm = (form) => {
      const listId = form.dataset.listTarget;
      const target = document.getElementById(listId);
      if (!listId || !target) return;
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const data = new FormData(form);
        const parts = [];
        data.forEach((value, key) => {
          if (value) parts.push(`${key}: ${value}`);
        });
        if (!parts.length) return;
        const item = document.createElement('li');
        item.textContent = parts.join(' ‚Ä¢ ');
        target.appendChild(item);
        form.reset();
      });
    };

    document.querySelectorAll('form[data-list-target]').forEach(setupForm);

    const state = {
      categories: [],
      participants: [],
      selectedCategory: 'todos',
      editingId: null,
      selectedDetailId: null,
    };

    const defaults = ['Mission√°rio', 'Pastor Enviador', 'Preletor', 'Equipe', 'Convidado'];

    const els = {
      categoryTabs: document.getElementById('categoryTabs'),
      categoryTotals: document.getElementById('categoryTotals'),
      participantsList: document.getElementById('participantsList'),
      participantSearch: document.getElementById('participantSearch'),
      familyList: document.getElementById('familyList'),
      detailPanel: document.getElementById('participantDetail'),
      indicatorGrid: document.getElementById('indicatorGrid'),
      participantModal: document.getElementById('participantModal'),
      participantForm: document.getElementById('participantForm'),
      participantCategory: document.getElementById('participantCategory'),
      membersContainer: document.getElementById('membersContainer'),
      customFieldsContainer: document.getElementById('customFieldsContainer'),
      formBuilderModal: document.getElementById('formBuilderModal'),
      builderCategorySelect: document.getElementById('builderCategorySelect'),
      builderCategoryName: document.getElementById('builderCategoryName'),
      builderSections: document.getElementById('builderSections'),
      builderForm: document.getElementById('builderForm'),
      indicatorsModal: document.getElementById('indicatorsModal'),
      participantModalTitle: document.getElementById('participantModalTitle'),
    };

    const uid = () => (crypto.randomUUID ? crypto.randomUUID() : `id-${Date.now()}-${Math.random().toString(16).slice(2)}`);
    const slugify = (text) => text.toLowerCase().replace(/[^a-z0-9√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß√±]+/gi, '-').replace(/^-+|-+$/g, '');

    const openModal = (modal) => { modal.setAttribute('aria-hidden', 'false'); };
    const closeModal = (modal) => { modal.setAttribute('aria-hidden', 'true'); };

    document.querySelectorAll('[data-close-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = document.getElementById(btn.dataset.closeModal);
        if (target) closeModal(target);
      });
    });

    const initCategories = () => {
      state.categories = [{ id: 'todos', name: 'Todos', sections: [] }];
      defaults.forEach(name => state.categories.push({ id: slugify(name), name, sections: [] }));
    };

    const resetCategoryCounts = () => {
      state.categories.forEach(cat => {
        cat.families = 0;
        cat.individuals = 0;
      });
      state.participants.forEach(participant => {
        const cat = state.categories.find(c => c.id === participant.categoria);
        if (cat) {
          cat.families += 1;
          cat.individuals += 1 + participant.membros.length;
        }
      });
      const todos = state.categories.find(cat => cat.id === 'todos');
      if (todos) {
        todos.families = state.participants.length;
        todos.individuals = state.participants.reduce((total, item) => total + 1 + item.membros.length, 0);
      }
    };

    const renderCategoryTabs = () => {
      els.categoryTabs.innerHTML = '';
      state.categories.forEach(cat => {
        if (cat.id === 'todos' || cat.id) {
          const tab = document.createElement('button');
          tab.type = 'button';
          tab.className = `category-tab ${state.selectedCategory === cat.id ? 'active' : ''}`;
          tab.dataset.category = cat.id;
          tab.innerHTML = `
            <span>${cat.name}</span>
            <span class="chip">Fam√≠lias: ${cat.families || 0}</span>
            <span class="chip">Individuais: ${cat.individuals || 0}</span>
          `;
          tab.addEventListener('click', () => {
            state.selectedCategory = cat.id;
            renderAll();
          });
          els.categoryTabs.appendChild(tab);
        }
      });
    };

    const renderCategoryTotals = () => {
      const category = state.categories.find(cat => cat.id === state.selectedCategory);
      const totals = {
        families: category ? category.families || 0 : 0,
        individuals: category ? category.individuals || 0 : 0,
        categories: state.categories.length - 1,
        configured: state.categories.filter(cat => cat.id !== 'todos' && cat.sections.length).length,
      };
      els.categoryTotals.innerHTML = `
        <span class="summary-pill">Fam√≠lias: ${totals.families}</span>
        <span class="summary-pill">Individuais: ${totals.individuals}</span>
        <span class="summary-pill">Categorias: ${totals.categories}</span>
        <span class="summary-pill">Formul√°rios configurados: ${totals.configured}</span>
      `;
    };

    const renderParticipants = () => {
      els.participantsList.innerHTML = '';
      const query = (els.participantSearch.value || '').toLowerCase();
      const filtered = state.participants.filter(item => {
        const matchesCategory = state.selectedCategory === 'todos' || item.categoria === state.selectedCategory;
        const text = `${item.titular} ${item.cidade} ${item.categoria}`.toLowerCase();
        const matchesQuery = !query || text.includes(query);
        return matchesCategory && matchesQuery;
      });

      if (!filtered.length) {
        const empty = document.createElement('div');
        empty.className = 'participant-row';
        empty.innerHTML = `<span style="grid-column:1/-1;">Nenhum inscrito encontrado para este filtro.</span>`;
        els.participantsList.appendChild(empty);
        return;
      }

      filtered.forEach(item => {
        const row = document.createElement('div');
        row.className = 'participant-row';
        row.role = 'row';
        row.dataset.id = item.id;
        row.innerHTML = `
          <span><strong>${item.titular}</strong><span class="family-link">Titular / Representante</span></span>
          <span><span class="member-count">${item.membros.length}</span></span>
          <span><span class="category-tag">${(state.categories.find(cat => cat.id === item.categoria) || {}).name || 'Categoria'}</span></span>
          <span>${item.cidade}</span>
          <span class="align-right">üëÅÔ∏è</span>
        `;
        row.addEventListener('click', () => openDetail(item.id));
        els.participantsList.appendChild(row);

        if (item.membros.length) {
          const branch = document.createElement('div');
          branch.className = 'family-branch';
          item.membros.forEach(member => {
            const memberRow = document.createElement('div');
            memberRow.className = 'family-member';
            memberRow.innerHTML = `
              <strong>‚Ü≥ ${member.nome}</strong>
              <span>${member.vinculo || 'Membro'} ¬∑ ${member.contato || 'Contato n√£o informado'}</span>
            `;
            branch.appendChild(memberRow);
          });
          els.participantsList.appendChild(branch);
        }
      });
    };

    const renderFamilyPanel = (participant) => {
      els.familyList.innerHTML = '';
      if (!participant) return;
      const titular = document.createElement('button');
      titular.type = 'button';
      titular.className = `family-chip ${state.selectedDetailId === participant.id ? 'active' : ''}`;
      titular.textContent = participant.titular;
      titular.addEventListener('click', () => openDetail(participant.id));
      els.familyList.appendChild(titular);

      participant.membros.forEach(member => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'family-chip';
        chip.textContent = `${member.nome} ‚Ä¢ ${member.vinculo || 'Membro'}`;
        chip.addEventListener('click', () => openDetail(participant.id));
        els.familyList.appendChild(chip);
      });
    };

    const buildDataCard = (label, value) => `
      <div class="data-card">
        <span class="small-note">${label}</span>
        <strong>${value || '-'}</strong>
      </div>
    `;

    const openDetail = (id) => {
      state.selectedDetailId = id;
      const participant = state.participants.find(item => item.id === id);
      if (!participant) return;
      renderFamilyPanel(participant);
      const category = state.categories.find(cat => cat.id === participant.categoria);
      const sectionFields = participant.customFields || {};
      const fieldsRendered = [];

      if (category && category.sections.length) {
        category.sections.forEach(section => {
          section.fields.forEach(field => {
            const value = sectionFields[field.id] || '';
            fieldsRendered.push(buildDataCard(`${section.title} ‚Ä¢ ${field.label}`, value || 'N√£o informado'));
          });
        });
      }

      els.detailPanel.innerHTML = `
        <div class="detail-header">
          <div>
            <p class="eyebrow">${category ? category.name : 'Categoria'}</p>
            <h3>${participant.titular}</h3>
            <div class="detail-meta">
              <span class="chip">Fam√≠lia: ${participant.membros.length + 1} pessoas</span>
              <span class="chip">Cidade: ${participant.cidade || '-'}</span>
            </div>
          </div>
          <div class="inline gap-sm">
            <div class="token-box">
              <span class="small-note">Token de acesso</span>
              <strong>${participant.token}</strong>
            </div>
            <button class="ghost-btn" type="button" id="editParticipant">Editar dados</button>
          </div>
        </div>
        <div class="data-grid">
          ${buildDataCard('Contato principal', participant.contato)}
          ${buildDataCard('Observa√ß√µes', participant.observacoes)}
          ${buildDataCard('Categoria', category ? category.name : 'N√£o definido')}
          ${buildDataCard('V√≠nculos', `${participant.membros.length} membros`)}
          ${fieldsRendered.join('')}
        </div>
        <div class="data-card">
          <span class="small-note">Hist√≥rico</span>
          <ul class="history-list">
            ${participant.historico.map(item => `<li>‚Ä¢ ${item}</li>`).join('')}
          </ul>
        </div>
      `;

      const editButton = document.getElementById('editParticipant');
      if (editButton) {
        editButton.addEventListener('click', () => openParticipantModal(participant.id));
      }
    };

    const clearDetail = () => {
      els.familyList.innerHTML = '';
      els.detailPanel.innerHTML = '<div class="empty-detail"><p class="small-note">Selecione um participante para abrir dados completos, editar ou adicionar informa√ß√µes.</p></div>';
    };

    const addMemberField = (data = {}) => {
      const card = document.createElement('div');
      card.className = 'family-card';
      card.innerHTML = `
        <div class="form-grid">
          <label>Nome do membro
            <input name="membroNome" type="text" placeholder="Nome completo" value="${data.nome || ''}">
          </label>
          <label>V√≠nculo com o titular
            <input name="membroVinculo" type="text" placeholder="Ex: C√¥njuge, Filho(a)" value="${data.vinculo || ''}">
          </label>
          <label>Contato
            <input name="membroContato" type="text" placeholder="Telefone ou e-mail" value="${data.contato || ''}">
          </label>
        </div>
        <div class="inline gap-sm" style="justify-content:flex-end;">
          <button type="button" class="ghost-btn remove-member">Remover</button>
        </div>
      `;
      card.querySelector('.remove-member').addEventListener('click', () => card.remove());
      els.membersContainer.appendChild(card);
    };

    const renderCustomFieldsForForm = (categoryId, values = {}) => {
      els.customFieldsContainer.innerHTML = '';
      const category = state.categories.find(cat => cat.id === categoryId);
      if (!category || !category.sections.length) {
        const empty = document.createElement('div');
        empty.className = 'custom-block';
        empty.innerHTML = '<span class="small-note">Nenhum campo personalizado configurado para esta categoria.</span>';
        els.customFieldsContainer.appendChild(empty);
        return;
      }

      category.sections.forEach(section => {
        const block = document.createElement('div');
        block.className = 'custom-block';
        block.innerHTML = `
          <p class="eyebrow">${section.sector || section.title}</p>
          <h4>${section.title}</h4>
          <p class="small-note">${section.description || ''}</p>
        `;
        section.fields.forEach(field => {
          const wrapper = document.createElement('label');
          wrapper.textContent = field.label;
          wrapper.classList.add('stacked');
          let input;
          if (field.type === 'textarea') {
            input = document.createElement('textarea');
          } else if (field.type === 'select') {
            input = document.createElement('select');
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Selecione';
            input.appendChild(placeholder);
            (field.options || []).forEach(option => {
              const opt = document.createElement('option');
              opt.value = option;
              opt.textContent = option;
              input.appendChild(opt);
            });
          } else {
            input = document.createElement('input');
            input.type = field.type || 'text';
          }
          input.required = !!field.required;
          input.dataset.fieldId = field.id;
          if (field.type !== 'file') {
            input.value = values[field.id] || '';
          }
          wrapper.appendChild(input);
          if (field.decision) {
            const decision = document.createElement('span');
            decision.className = 'small-note';
            decision.textContent = `Decis√£o por resposta: ${field.decision}`;
            wrapper.appendChild(decision);
          }
          block.appendChild(wrapper);
        });
        els.customFieldsContainer.appendChild(block);
      });
    };

    const collectCustomFieldValues = () => {
      const values = {};
      els.customFieldsContainer.querySelectorAll('[data-field-id]').forEach(input => {
        if (input.type === 'file') {
          values[input.dataset.fieldId] = input.files && input.files.length ? input.files[0].name : '';
        } else {
          values[input.dataset.fieldId] = input.value;
        }
      });
      return values;
    };

    const populateCategorySelects = () => {
      const options = state.categories.filter(cat => cat.id !== 'todos');
      els.participantCategory.innerHTML = options.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
      els.builderCategorySelect.innerHTML = [
        `<option value="">Nova categoria</option>`,
        ...options.map(cat => `<option value="${cat.id}">${cat.name}</option>`)
      ].join('');
      if (els.participantCategory.options.length) {
        els.participantCategory.value = els.participantCategory.options[0].value;
      }
    };

    const openParticipantModal = (id = null) => {
      state.editingId = id;
      els.participantForm.reset();
      els.membersContainer.innerHTML = '';
      const participant = id ? state.participants.find(item => item.id === id) : null;
      if (participant) {
        els.participantModalTitle.textContent = 'Editar participante';
        els.participantCategory.value = participant.categoria;
        els.participantForm.elements.titular.value = participant.titular;
        els.participantForm.elements.cidade.value = participant.cidade;
        els.participantForm.elements.contato.value = participant.contato;
        els.participantForm.elements.observacoes.value = participant.observacoes || '';
        participant.membros.forEach(member => addMemberField(member));
        renderCustomFieldsForForm(participant.categoria, participant.customFields);
      } else {
        els.participantModalTitle.textContent = 'Registrar titular e membros';
        renderCustomFieldsForForm(els.participantCategory.value);
      }
      openModal(els.participantModal);
    };

    const saveParticipant = (event) => {
      event.preventDefault();
      const formData = new FormData(els.participantForm);
      const categoria = formData.get('categoria');
      const titular = formData.get('titular');
      const cidade = formData.get('cidade');
      const contato = formData.get('contato');
      const observacoes = formData.get('observacoes');
      const membros = Array.from(els.membersContainer.querySelectorAll('.family-card')).map(card => ({
        nome: card.querySelector('input[name="membroNome"]').value.trim(),
        vinculo: card.querySelector('input[name="membroVinculo"]').value.trim(),
        contato: card.querySelector('input[name="membroContato"]').value.trim(),
      })).filter(m => m.nome);
      const customFields = collectCustomFieldValues();

      const existing = state.participants.find(item => item.id === state.editingId);
      const stamp = new Date().toLocaleString('pt-BR');
      const historico = existing ? [...existing.historico, `Registro atualizado em ${stamp}`] : [`Inscri√ß√£o criada em ${stamp}`];

      const payload = {
        id: state.editingId || uid(),
        categoria,
        titular,
        cidade,
        contato,
        membros,
        observacoes,
        customFields,
        token: (existing && existing.token) || uid().slice(0, 8).toUpperCase(),
        historico,
      };

      if (state.editingId) {
        state.participants = state.participants.map(item => item.id === state.editingId ? { ...payload } : item);
      } else {
        state.participants.push(payload);
      }

      state.editingId = null;
      resetCategoryCounts();
      renderAll();
      closeModal(els.participantModal);
      clearDetail();
    };

    const addSectionCard = (data = {}) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'builder-section';
      wrapper.dataset.id = data.id || uid();
      wrapper.innerHTML = `
        <div class="form-grid">
          <label>T√≠tulo da se√ß√£o
            <input type="text" class="section-title" placeholder="Ex: Sa√∫de, Log√≠stica" value="${data.title || ''}" required>
          </label>
          <label>Setor respons√°vel
            <input type="text" class="section-sector" placeholder="Setor respons√°vel" value="${data.sector || ''}">
          </label>
          <label>Descri√ß√£o / Orienta√ß√µes
            <input type="text" class="section-description" placeholder="Detalhes para a equipe" value="${data.description || ''}">
          </label>
        </div>
        <div class="builder-fields"></div>
        <div class="inline gap-sm" style="justify-content:space-between;">
          <button type="button" class="ghost-btn add-field">+ Adicionar campo</button>
          <button type="button" class="ghost-btn remove-section">Remover se√ß√£o</button>
        </div>
      `;
      const fieldsWrap = wrapper.querySelector('.builder-fields');
      const addFieldBtn = wrapper.querySelector('.add-field');
      const removeSectionBtn = wrapper.querySelector('.remove-section');

      addFieldBtn.addEventListener('click', () => addFieldRow(fieldsWrap));
      removeSectionBtn.addEventListener('click', () => wrapper.remove());

      (data.fields || []).forEach(field => addFieldRow(fieldsWrap, field));
      els.builderSections.appendChild(wrapper);
    };

    const addFieldRow = (container, data = {}) => {
      const row = document.createElement('div');
      row.className = 'builder-field';
      row.dataset.id = data.id || uid();
      row.innerHTML = `
        <input type="text" class="field-label" placeholder="Pergunta ou r√≥tulo" value="${data.label || ''}" required>
        <select class="field-type">
          <option value="text" ${data.type === 'text' ? 'selected' : ''}>Texto</option>
          <option value="textarea" ${data.type === 'textarea' ? 'selected' : ''}>Par√°grafo</option>
          <option value="select" ${data.type === 'select' ? 'selected' : ''}>Lista</option>
          <option value="number" ${data.type === 'number' ? 'selected' : ''}>N√∫mero</option>
          <option value="date" ${data.type === 'date' ? 'selected' : ''}>Data</option>
          <option value="file" ${data.type === 'file' ? 'selected' : ''}>Arquivo</option>
        </select>
        <label class="inline" style="justify-content:flex-start;">
          <input type="checkbox" class="field-required" ${data.required ? 'checked' : ''}>
          <span>Obrigat√≥rio</span>
        </label>
        <input type="text" class="field-options" placeholder="Op√ß√µes (separadas por v√≠rgula)" value="${(data.options || []).join(', ')}">
        <input type="text" class="field-decision" placeholder="Decis√£o por resposta (opcional)" value="${data.decision || ''}">
        <button type="button" class="ghost-btn remove-field">Remover</button>
      `;
      row.querySelector('.remove-field').addEventListener('click', () => row.remove());
      container.appendChild(row);
    };

    const loadBuilderCategory = (categoryId) => {
      els.builderSections.innerHTML = '';
      if (!categoryId) {
        els.builderCategoryName.value = '';
        return;
      }
      const cat = state.categories.find(item => item.id === categoryId);
      if (!cat) return;
      els.builderCategoryName.value = cat.name;
      (cat.sections || []).forEach(section => addSectionCard(section));
    };

    const saveBuilder = (event) => {
      event.preventDefault();
      const selectedId = els.builderCategorySelect.value;
      const name = els.builderCategoryName.value.trim();
      if (!name) return;
      const sections = Array.from(els.builderSections.querySelectorAll('.builder-section')).map(section => {
        const fields = Array.from(section.querySelectorAll('.builder-field')).map(field => ({
          id: field.dataset.id,
          label: field.querySelector('.field-label').value.trim(),
          type: field.querySelector('.field-type').value,
          required: field.querySelector('.field-required').checked,
          options: field.querySelector('.field-options').value.split(',').map(v => v.trim()).filter(Boolean),
          decision: field.querySelector('.field-decision').value.trim(),
        })).filter(field => field.label);
        return {
          id: section.dataset.id,
          title: section.querySelector('.section-title').value.trim(),
          sector: section.querySelector('.section-sector').value.trim(),
          description: section.querySelector('.section-description').value.trim(),
          fields,
        };
      }).filter(section => section.title);

      if (selectedId) {
        state.categories = state.categories.map(cat => cat.id === selectedId ? { ...cat, name, sections } : cat);
      } else {
        state.categories.push({ id: slugify(name) || uid(), name, sections });
      }

      populateCategorySelects();
      resetCategoryCounts();
      renderAll();
      closeModal(els.formBuilderModal);
    };

    const renderIndicators = () => {
      const totalFamilies = state.participants.length;
      const totalIndividuals = state.participants.reduce((total, item) => total + 1 + item.membros.length, 0);
      const configured = state.categories.filter(cat => cat.id !== 'todos' && cat.sections.length).length;
      els.indicatorGrid.innerHTML = `
        <div class="stat-card"><span>Total de fam√≠lias</span><strong>${totalFamilies}</strong></div>
        <div class="stat-card"><span>Total de indiv√≠duos</span><strong>${totalIndividuals}</strong></div>
        <div class="stat-card"><span>Categorias ativas</span><strong>${state.categories.length - 1}</strong></div>
        <div class="stat-card"><span>Formul√°rios personalizados</span><strong>${configured}</strong></div>
      `;
    };

    const renderAll = () => {
      resetCategoryCounts();
      renderCategoryTabs();
      renderCategoryTotals();
      renderParticipants();
      renderIndicators();
      if (state.selectedDetailId) {
        openDetail(state.selectedDetailId);
      } else {
        clearDetail();
      }
    };

    document.getElementById('openParticipantForm').addEventListener('click', () => openParticipantModal());
    document.getElementById('openFormBuilder').addEventListener('click', () => {
      els.builderSections.innerHTML = '';
      const targetCategory = state.selectedCategory !== 'todos' ? state.selectedCategory : '';
      els.builderCategorySelect.value = targetCategory;
      els.builderCategoryName.value = '';
      loadBuilderCategory(targetCategory);
      openModal(els.formBuilderModal);
    });
    document.getElementById('addSection').addEventListener('click', () => addSectionCard());
    document.getElementById('addMember').addEventListener('click', () => addMemberField());
    document.getElementById('openIndicators').addEventListener('click', () => openModal(els.indicatorsModal));
    document.getElementById('refreshIndicators').addEventListener('click', renderIndicators);

    els.participantCategory.addEventListener('change', (event) => {
      renderCustomFieldsForForm(event.target.value);
    });

    els.participantForm.addEventListener('submit', saveParticipant);
    els.builderForm.addEventListener('submit', saveBuilder);
    els.builderCategorySelect.addEventListener('change', (event) => loadBuilderCategory(event.target.value));
    els.participantSearch.addEventListener('input', renderParticipants);

    initCategories();
    populateCategorySelects();
    renderCustomFieldsForForm(els.participantCategory.value);
    renderAll();
  </script>
</body>
</html>
