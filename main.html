<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gestão do Encontro - Visualização Leitura + Edição</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --p:#1e40af; --s:#3b82f6; --ok:#10b981; --no:#ef4444; --bg:#f8fafc; }
  * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui,sans-serif; }
  body { background:var(--bg); color:#1f2937; line-height:1.6; }
  header { background:var(--p); color:white; padding:2rem; text-align:center; }
  nav { background:#172554; padding:1rem; position:sticky; top:0; z-index:1000; }
  nav ul { display:flex; flex-wrap:wrap; justify-content:center; gap:1rem; list-style:none; }
  nav a { color:white; text-decoration:none; padding:0.8rem 1.4rem; border-radius:8px; font-weight:600; }
  nav a:hover, nav a.active { background:#1e40af; }

  .container { width:100%; margin:0 auto; padding:1.5rem; }
  .view { display:none; }
  .view.active { display:block; }

  .modo-leitura { background:#fff; border-radius:12px; padding:2rem; box-shadow:0 6px 25px rgba(0,0,0,0.1); margin-bottom:2rem; }
  .modo-edicao { background:#f0f9ff; border:2px dashed #0ea5e9; border-radius:12px; padding:2rem; margin-bottom:2rem; }

  .card { background:white; border-radius:10px; padding:1.5rem; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin-bottom:1rem; }
  .grid-3 { display:grid; gap:1.5rem; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); }
  .section-grid { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); align-items:start; }
  .card-full { grid-column:1 / -1; }
  .stacked { display:flex; flex-direction:column; gap:0.75rem; }
  .field-row { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); }
  .caption { color:#475569; font-size:0.95rem; }

  button { padding:0.8rem 1.4rem; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
  .btn-editar { background:#f59e0b; color:white; }
  .btn-salvar { background:var(--ok); color:white; }
  .btn-cancelar { background:var(--no); color:white; }
  .btn-no { background:var(--no); color:white; }
  .btn-small { padding:0.4rem 0.8rem; font-size:0.9rem; }

  input, select, textarea { width:100%; padding:0.9rem; border:1px solid #ccc; border-radius:8px; margin:0.5rem 0; font-size:1rem; }
  table { width:100%; border-collapse:collapse; margin:1.5rem 0; font-size:0.95rem; }
  th, td { padding:0.85rem 1rem; text-align:left; border-bottom:1px solid #e5e7eb; vertical-align:top; }
  th { background:#f1f5f9; font-weight:700; }
  .table-group { background:white; border-radius:12px; padding:1rem 1.2rem; box-shadow:0 4px 12px rgba(0,0,0,0.05); margin:1rem 0; }
  .table-group h3 { margin-bottom:0.5rem; color:#0f172a; }
  .nota-dependencia { background:#ecfeff; border:1px dashed #06b6d4; padding:0.8rem 1rem; border-radius:10px; margin-top:0.5rem; color:#0f172a; }

    .mapa-wrapper { background:white; border-radius:14px; padding:1rem; box-shadow:0 4px 15px rgba(0,0,0,0.08); margin:1rem 0 2rem; }
    .mapa-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1rem; flex-wrap:wrap; }
    .mapa-viewport { border:1px solid #e2e8f0; border-radius:12px; padding:0.5rem; overflow:auto; background:#f8fafc; min-height:520px; }
    .mapa-rodape { margin-top:0.5rem; color:#475569; font-size:0.95rem; }
    .mapa-zoom { display:flex; align-items:center; gap:0.5rem; background:#e0f2fe; padding:0.4rem 0.75rem; border-radius:10px; }
    .mapa-zoom input[type="range"] { width:140px; }
    .mapa-acoes { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; }
    .painel-quarto { border:2px solid #bfdbfe; background:#eff6ff; }
    .painel-quarto h4 { margin-bottom:0.25rem; }
    .painel-quarto .pill { background:#dbeafe; }
    .tipo-cama-builder { background:#f8fafc; border:1px dashed #cbd5e1; padding:0.75rem; border-radius:10px; margin-top:0.5rem; }
    .tipo-cama-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:0.6rem; align-items:end; }
    .tipos-cama-lista { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.5rem; }
    .tipos-cama-lista .pill { background:#eef2ff; }
    .quarto-card.selecionado { outline:3px solid var(--s); }

    .mapa-planta { display:flex; gap:1rem; flex-wrap:wrap; }
    .painel-familias { min-width:280px; flex:1; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:1rem; height:100%; }
    .lista-familias { display:flex; flex-direction:column; gap:0.5rem; margin-top:0.75rem; max-height:420px; overflow:auto; }
    .familia-chip { padding:0.65rem 0.9rem; background:white; border:1px dashed #94a3b8; border-radius:10px; cursor:grab; display:flex; justify-content:space-between; align-items:center; }
    .familia-chip small { color:#475569; }
    .familia-chip:hover { border-color:var(--s); }
    .planta-editor { flex:2; min-width:320px; width:100%; }
    .planta-canvas { position:relative; width:100%; min-width:min(100%, 900px); min-height:520px; background-image:linear-gradient(90deg, rgba(0,0,0,0.04) 1px, transparent 1px), linear-gradient(180deg, rgba(0,0,0,0.04) 1px, transparent 1px); background-size:32px 32px; border:1px dashed #cbd5e1; border-radius:12px; transform-origin: top left; transition: transform .15s ease; }
    .planta-canvas-inner { position:relative; width:100%; min-height:600px; transform-origin: top left; transition: transform .15s ease; }
    .planta-shape { position:absolute; border-radius:12px; padding:0.75rem; box-shadow:0 10px 30px rgba(15,23,42,0.12); border:2px solid #e2e8f0; background:white; cursor:grab; transition:border-color .2s, box-shadow .2s; }
    .planta-shape:hover { border-color:var(--s); box-shadow:0 10px 30px rgba(59,130,246,0.15); }
    .planta-shape.arrastando { opacity:0.8; }
    .shape-espaco { background:#f1f5f9; border-style:dashed; }
    .shape-espaco h4 { margin-bottom:0.25rem; }
    .shape-quarto h4 { margin-bottom:0.25rem; }
    .shape-quarto .ocupantes { margin-top:0.4rem; display:flex; flex-wrap:wrap; gap:0.35rem; font-size:0.9rem; }
    .shape-quarto .ocupantes span { background:#e0f2fe; padding:0.25rem 0.5rem; border-radius:999px; }
    .shape-quarto .status { font-weight:700; color:#0f172a; font-size:0.95rem; }
    .shape-quarto.disponivel { border-color:var(--ok); background:#f0fdf4; }
    .shape-quarto.cheio { border-color:var(--no); background:#fff1f2; }
    .shape-quarto.drop-target { outline:3px solid #3b82f6; }
    .shape-quarto.selecionado { outline:3px solid #2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.25); }
    .controle-desenho { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .btn-ghost { background:transparent; color:#0f172a; border:1px dashed #cbd5e1; }
    .btn-ghost.active { border-color:#3b82f6; color:#1d4ed8; background:#e0f2fe; }

  .kpi { font-size:3.2rem; font-weight:900; color:var(--p); }
  .section-actions { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; margin:1rem 0; }
  .btn-secondary { background:#0ea5e9; color:white; }
  .pill { display:inline-flex; align-items:center; gap:0.5rem; padding:0.6rem 1rem; background:#e0f2fe; border-radius:999px; font-size:0.95rem; }
  .hidden { display:none !important; }
  .view-toggle { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; margin:1rem 0; }
  .view-toggle button { background:#e2e8f0; color:#0f172a; border:1px solid #cbd5e1; }
  .view-toggle button.active { background:#1e3a8a; color:#fff; border-color:#1e3a8a; }
  .subnav { display:flex; gap:0.5rem; flex-wrap:wrap; margin:1rem 0 1.25rem; }
  .subtab { border:1px solid #cbd5e1; background:#e2e8f0; color:#0f172a; padding:0.55rem 0.9rem; border-radius:10px; cursor:pointer; font-weight:700; }
  .subtab.active { background:#1e3a8a; color:white; border-color:#1e3a8a; }
  .subview { display:none; }
  .subview.active { display:block; }
  .table-controls { display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center; margin-bottom:0.75rem; }
  .table-controls input { width:220px; max-width:100%; }
  .table-controls select { width:190px; max-width:100%; }
  .table-scroll { overflow:auto; }
  .sortable { cursor:pointer; }
  .sortable span { font-size:0.85rem; color:#64748b; margin-left:0.35rem; }
  .sortable.active { color:#1d4ed8; }
  .participante-row.selected { background:#eef2ff; }
  .totalizador { display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; }
  .detalhe-card { background:white; border-radius:12px; padding:1rem; box-shadow:0 6px 18px rgba(15,23,42,0.18); margin-top:1rem; position:relative; }
  .detalhe-overlay { position:fixed; inset:0; background:rgba(15,23,42,0.35); display:flex; align-items:center; justify-content:center; padding:1rem; z-index:2000; }
  .detalhe-shell { width:min(980px, 96vw); max-height:90vh; overflow:auto; }
  .detalhe-fechar { position:absolute; top:0.75rem; right:0.75rem; background:transparent; border:none; font-size:1.2rem; cursor:pointer; }
  .detalhe-grid { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); }
  .detalhe-campo strong { display:block; color:#0f172a; margin-bottom:0.25rem; }
  .detalhe-campo span { color:#475569; }
  .detalhe-acoes { display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end; margin-top:0.75rem; }

  .acoes-compactas { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; margin:0.75rem 0 1rem; }
  .acoes-compactas button { background:#0ea5e9; color:white; border:1px solid #0ea5e9; }
  .acoes-compactas .btn-ghost { background:white; color:#0f172a; border:1px dashed #cbd5e1; }
  .modal-shell { background:white; padding:1.2rem; border-radius:14px; width:min(720px, 96vw); box-shadow:0 12px 40px rgba(15,23,42,0.3); position:relative; }
  .modal-shell h3 { margin-bottom:0.25rem; }
  .modal-shell form { display:flex; flex-direction:column; gap:0.5rem; }
  .modal-shell .field-row { margin:0; }

  /* Quartos integrados (importado de quartos.html) */
  #quartos-integrados { margin-top:1.25rem; border:1px solid #e2e8f0; border-radius:14px; background:white; box-shadow:0 8px 30px rgba(15,23,42,0.08); }
  #quartos-integrados header { display:flex; justify-content:space-between; align-items:center; gap:1rem; padding:1rem 1.25rem; background:#0f172a; color:white; border-radius:14px 14px 0 0; }
  #quartos-integrados header h3 { font-size:1.05rem; }
  #quartos-integrados header span { color:#cbd5e1; font-size:0.9rem; }
  #quartos-integrados .badge { background:#1f2937; border-radius:999px; padding:0.2rem 0.75rem; font-size:0.75rem; color:#d1d5db; }
  .qa-layout { display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:1rem; padding:1rem; width:100%; }
  .qa-panel { border:1px solid #e2e8f0; border-radius:12px; padding:0.85rem; background:#f8fafc; display:flex; flex-direction:column; gap:0.65rem; min-height:0; }
  .qa-panel h4 { font-size:0.95rem; display:flex; align-items:center; justify-content:space-between; }
  .qa-panel small { color:#475569; }
  .qa-stack { display:flex; flex-direction:column; gap:0.45rem; }
  .qa-row { display:flex; gap:0.4rem; align-items:center; }
  .qa-row.wrap { flex-wrap:wrap; }
  .qa-input { width:100%; padding:0.55rem 0.7rem; border-radius:10px; border:1px solid #d6e0ea; font-size:0.9rem; }
  .qa-input:focus { outline:2px solid #dbeafe; border-color:#2563eb; }
  .qa-btn { border:none; border-radius:999px; padding:0.5rem 0.95rem; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:0.25rem; }
  .qa-btn.primary { background:#2563eb; color:white; }
  .qa-btn.secondary { background:#dbeafe; color:#1d4ed8; }
  .qa-btn.danger { background:#fee2e2; color:#b91c1c; }
  .qa-btn.small { padding:0.35rem 0.7rem; font-size:0.82rem; }
  .qa-space-list { display:flex; flex-direction:column; gap:0.35rem; max-height:220px; overflow:auto; }
  .qa-space { border:1px solid #e2e8f0; padding:0.5rem; border-radius:10px; background:#fff; display:flex; gap:0.45rem; align-items:center; cursor:pointer; }
  .qa-space.active { border-color:#2563eb; background:#eef2ff; }
  .qa-space-color { width:14px; height:14px; border-radius:4px; flex-shrink:0; }
  .qa-canvas { position:relative; flex:1; border:1px dashed #cbd5e1; border-radius:12px; background-image:linear-gradient(90deg, #e5e7eb 1px, transparent 1px), linear-gradient(180deg, #e5e7eb 1px, transparent 1px); background-size:26px 26px; overflow:auto; min-height:420px; }
    .qa-canvas-inner { position:relative; width:min(1400px, 100%); height:900px; }
  .qa-label { position:sticky; top:0; left:0; padding:0.35rem 0.6rem; font-size:0.82rem; background:rgba(15,23,42,0.9); color:white; border-bottom-right-radius:10px; z-index:2; }
  .qa-room { position:absolute; min-width:110px; min-height:70px; padding:0.45rem; background:#e5e7eb; border:1px solid #94a3b8; border-radius:10px; box-shadow:0 2px 6px rgba(15,23,42,0.18); display:flex; flex-direction:column; gap:0.18rem; cursor:grab; font-size:0.82rem; }
  .qa-room.selected { outline:2px solid #2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.18); }
  .qa-room .qa-room-head { display:flex; align-items:center; gap:0.35rem; font-weight:700; }
  .qa-room .qa-room-tag { padding:0.1rem 0.5rem; border-radius:999px; background:#fff; font-size:0.72rem; }
  .qa-room .qa-room-info { color:#475569; font-size:0.78rem; }
  .qa-room.drop-target { outline:2px dashed #2563eb; }
  .qa-family-search { position:sticky; top:0; background:#f8fafc; padding-bottom:0.35rem; z-index:2; }
  .qa-family-list { flex:1; overflow:auto; display:flex; flex-direction:column; gap:0.35rem; }
  .qa-family { border:1px solid #e2e8f0; border-radius:10px; padding:0.45rem 0.55rem; background:#fff; display:flex; flex-direction:column; gap:0.2rem; cursor:grab; }
  .qa-family.assigned { opacity:0.6; }
  .qa-family small { color:#475569; }
  .qa-details { border-top:1px solid #e2e8f0; padding-top:0.45rem; display:flex; flex-direction:column; gap:0.35rem; font-size:0.88rem; }
  .qa-chip { border-radius:999px; background:#e5e7eb; padding:0.15rem 0.55rem; font-size:0.78rem; }

  /* Equipes & Projetos */
  .projeto-hero { background:white; border-radius:14px; padding:1.2rem 1.4rem; box-shadow:0 8px 28px rgba(15,23,42,0.08); display:flex; justify-content:space-between; gap:1rem; flex-wrap:wrap; align-items:flex-start; }
  .projeto-hero h2 { margin:0.2rem 0; }
  .hero-meta { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center; }
  .status-badge { padding:0.35rem 0.75rem; border-radius:999px; font-weight:700; background:#e2e8f0; color:#0f172a; }
  .status-andamento { background:#fef9c3; color:#854d0e; }
  .status-concluido { background:#dcfce7; color:#166534; }
  .status-atrasado { background:#fee2e2; color:#b91c1c; }
  .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; margin:1rem 0 1.5rem; }
  .kpi-card { background:white; border-radius:12px; padding:1rem 1.1rem; box-shadow:0 8px 26px rgba(15,23,42,0.06); display:flex; flex-direction:column; gap:0.3rem; }
  .kpi-card strong { font-size:1.7rem; color:#0f172a; }
  .kpi-card small { color:#475569; }
  .kpi-trend { display:flex; gap:0.35rem; align-items:center; font-weight:700; }
  .kpi-trend.ok { color:#16a34a; }
  .kpi-trend.risk { color:#b91c1c; }
  .projeto-tabs { margin:0.5rem 0 1rem; }
  .projeto-view { display:none; }
  .projeto-view.active { display:block; }
  .kanban-board { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem; }
  .kanban-col { background:white; border-radius:12px; padding:0.9rem; box-shadow:0 10px 24px rgba(15,23,42,0.07); display:flex; flex-direction:column; gap:0.6rem; }
  .kanban-col h4 { display:flex; justify-content:space-between; align-items:center; font-size:1rem; }
  .kanban-item { border:1px solid #e2e8f0; border-radius:10px; padding:0.65rem 0.75rem; background:#f8fafc; display:flex; flex-direction:column; gap:0.35rem; }
  .kanban-tags { display:flex; gap:0.35rem; flex-wrap:wrap; }
  .tag { background:#e2e8f0; padding:0.2rem 0.65rem; border-radius:999px; font-size:0.85rem; }
  .tag.prioridade-alta { background:#fee2e2; color:#b91c1c; }
  .tag.prioridade-media { background:#fef3c7; color:#92400e; }
  .tag.prioridade-baixa { background:#dcfce7; color:#166534; }
  .timeline { display:flex; flex-direction:column; gap:0.75rem; }
  .timeline-item { background:white; border:1px solid #e2e8f0; border-radius:12px; padding:0.85rem; box-shadow:0 8px 18px rgba(15,23,42,0.05); display:flex; gap:0.75rem; justify-content:space-between; flex-wrap:wrap; }
  .arquivo-card { border:1px dashed #cbd5e1; background:#f8fafc; border-radius:12px; padding:0.85rem; display:flex; justify-content:space-between; align-items:flex-start; gap:0.7rem; }
  .arquivo-meta { color:#475569; font-size:0.92rem; }
  .financeiro-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:0.85rem; }
  .alertas-lista { display:flex; flex-direction:column; gap:0.45rem; }
  .alerta { background:#fff7ed; border:1px solid #fdba74; color:#9a3412; padding:0.65rem 0.75rem; border-radius:10px; display:flex; gap:0.5rem; align-items:center; }

  /* Responsividade e uso total da largura */
  @media (max-width: 1200px) {
    .container { padding:1rem; }
    nav ul { justify-content:flex-start; overflow-x:auto; padding-bottom:0.5rem; }
    nav li { flex-shrink:0; }
    .mapa-viewport { min-height:420px; }
  }

  @media (max-width: 960px) {
    header { padding:1.5rem 1rem; }
    .mapa-planta { flex-direction:column; }
    .painel-familias { width:100%; }
    .planta-editor { width:100%; }
    .planta-canvas { min-width:0; }
    .mapa-viewport { min-height:360px; }
  }

  @media (max-width: 720px) {
    nav ul { gap:0.5rem; }
    nav a { padding:0.6rem 1rem; }
    .section-actions { width:100%; justify-content:flex-start; }
    .qa-layout { grid-template-columns:1fr; }
    .qa-canvas-inner { width:100%; height:640px; }
    .mapa-viewport { min-height:320px; }
  }
</style>
</head>
<body>

<header>
  <h1>Gestão do Grande Encontro de Missionários</h1>
  <p>700–1.500 pessoas • Visualização e edição contínuas em cada módulo</p>
</header>

<nav>
  <ul>
    <li><a href="#conta" class="nav-link active">Conta</a></li>
    <li><a href="#dashboard" class="nav-link">Dashboard</a></li>
    <li><a href="#equipes" class="nav-link">Equipes & Projetos</a></li>
    <li><a href="#participantes" class="nav-link">Participantes</a></li>
    <li><a href="#transporte" class="nav-link">Transporte</a></li>
    <li><a href="#alojamento" class="nav-link">Alojamento</a></li>
    <li><a href="#cronograma" class="nav-link">Cronograma</a></li>
    <li><a href="#cardapio" class="nav-link">Cardápio</a></li>
    <li><a href="#compras" class="nav-link">Compras</a></li>
    <li><a href="#palestras" class="nav-link">Palestras</a></li>
    <li><a href="#kids" class="nav-link">Kids</a></li>
    <li><a href="#financeiro" class="nav-link">Financeiro</a></li>
  </ul>
</nav>

<div class="container">
<main>

<!-- CONTA -->
<section id="conta" class="view active">
  <div class="card">
    <h2>Conta do Usuário</h2>
    <p id="contaDescricao">Cadastre um usuário para acessar as edições. Todas as ações são registradas em log em formato JSON e os dados são mantidos somente durante a sessão atual.</p>

    <div id="acoesConta" class="section-actions">
      <button type="button" class="btn-salvar" data-modo-conta="cadastro">Criar nova conta</button>
      <button type="button" class="btn-secondary" data-modo-conta="login">Já tenho conta</button>
    </div>

    <div id="blocoCadastro" class="card">
      <h3>Novo cadastro</h3>
      <form id="formCadastro">
        <input type="text" placeholder="Nome completo" required>
        <input type="email" placeholder="E-mail" required>
        <input type="text" placeholder="Usuário" required>
        <input type="password" placeholder="Senha" required>
        <button type="submit" class="btn-salvar">Registrar</button>
      </form>
    </div>

    <div id="blocoLogin" class="card hidden">
      <h3>Login</h3>
      <form id="formLogin">
        <input type="text" placeholder="Usuário" required>
        <input type="password" placeholder="Senha" required>
        <div class="section-actions">
          <button type="submit" class="btn-secondary">Entrar</button>
          <button type="button" id="btnLogout" class="btn-no hidden">Sair</button>
        </div>
      </form>
    </div>

    <div id="blocoSessao" class="card hidden">
      <h3>Dados da sessão</h3>
      <div id="sessaoUsuario" class="pill">Nenhum usuário autenticado</div>
      <div id="perfilSelecionado"></div>
      <div class="section-actions" id="acoesSessao"></div>
    </div>
  </div>
  <div class="modo-edicao" id="usuariosCard">
    <h3>Usuários cadastrados</h3>
    <div id="usuariosLista"></div>
  </div>
  <div class="modo-leitura" id="logCard">
    <h3>Log de alterações</h3>
    <div id="logAlteracoes"></div>
  </div>
</section>

<!-- DASHBOARD -->
<section id="dashboard" class="view">
  <div class="modo-leitura">
    <h2>Dashboard Executivo</h2>
    <div class="grid-3">
      <div class="card"><h3>Participantes</h3><div class="kpi" id="paxTotal">0</div></div>
      <div class="card"><h3>Ônibus</h3><div class="kpi" id="onibusTotal">0</div></div>
      <div class="card"><h3>Voos</h3><div class="kpi" id="voosTotal">0</div></div>
      <div class="card"><h3>Quartos Ocupados</h3><div class="kpi" id="quartosInfo">0 / 0</div></div>
      <div class="card"><h3>Orçado</h3><div class="kpi">R$ <span id="orcado">0,00</span></div></div>
      <div class="card"><h3>Realizado</h3><div class="kpi">R$ <span id="realizado">0,00</span></div></div>
    </div>
  </div>

  <div class="modo-edicao">
    <h2>Editar Dashboard</h2>
    <p>Os dados são atualizados automaticamente com base nos cadastros.</p>
  </div>
</section>

<!-- EQUIPES E PROJETOS -->
<section id="equipes" class="view">
  <div class="modo-leitura">
    <div class="projeto-hero">
      <div>
        <p class="caption">Painel de projetos</p>
        <h2 id="projetoTitulo">Selecione um projeto</h2>
        <div class="hero-meta">
          <span class="status-badge" id="projetoStatusBadge">Sem status</span>
          <span class="pill" id="projetoPrazoBadge">Prazo não definido</span>
        </div>
      </div>
      <div class="stacked" style="min-width:220px;">
        <label class="caption">Alternar projeto</label>
        <select id="projetoSelect"></select>
        <span class="pill" id="projetoEquipeBadge">Equipe não atribuída</span>
      </div>
    </div>

    <div class="acoes-compactas" aria-label="Ações rápidas de projeto">
      <button type="button" onclick="abrirTarefaModal('self')">+ Tarefa para mim</button>
      <button type="button" onclick="abrirTarefaModal('membro')">+ Tarefa para equipe</button>
      <button type="button" class="btn-ghost" onclick="abrirAnexoModal()">Anexar evidência/nota</button>
      <button type="button" class="btn-ghost" onclick="abrirCustoModal()">Vincular custo</button>
      <span class="caption">Abra somente o que precisa: detalhes e formulários aparecem sob demanda.</span>
    </div>

    <div class="kpi-grid" id="projetoIndicadores"></div>

    <div class="subnav projeto-tabs" id="projetoTabNav">
      <button type="button" class="subtab active" data-projeto-tab="resumo">Visão geral</button>
      <button type="button" class="subtab" data-projeto-tab="tarefas">Tarefas</button>
      <button type="button" class="subtab" data-projeto-tab="equipe">Equipe</button>
      <button type="button" class="subtab" data-projeto-tab="arquivos">Arquivos & Anexos</button>
      <button type="button" class="subtab" data-projeto-tab="financeiro">Financeiro</button>
      <button type="button" class="subtab" data-projeto-tab="cronograma">Cronograma</button>
    </div>

    <div class="projeto-view active" id="tab-resumo">
      <div class="section-grid" id="resumoGeral"></div>
    </div>

    <div class="projeto-view" id="tab-tarefas">
      <div class="kanban-board" id="kanbanBoard"></div>
    </div>

    <div class="projeto-view" id="tab-equipe">
      <div class="section-grid" id="painelEquipe"></div>
    </div>

    <div class="projeto-view" id="tab-arquivos">
      <div class="section-grid" id="painelArquivos"></div>
    </div>

    <div class="projeto-view" id="tab-financeiro">
      <div class="section-grid" id="painelFinanceiro"></div>
    </div>

    <div class="projeto-view" id="tab-cronograma">
      <div class="section-grid" id="painelCronograma"></div>
    </div>

    <div id="tarefaOverlay" class="detalhe-overlay hidden">
      <div class="modal-shell">
        <button class="detalhe-fechar" onclick="fecharOverlay('tarefaOverlay')">✕</button>
        <h3>Nova tarefa rápida</h3>
        <p class="caption">Escolha o projeto, selecione uma pessoa já cadastrada e defina prazo e prioridade.</p>
        <form id="formTarefaModal">
          <label>Projeto
            <select id="modalProjeto" name="modalProjeto"></select>
          </label>
          <label>Título da tarefa
            <input name="titulo" type="text" required placeholder="Ex: Solicitar orçamento para refeições">
          </label>
          <div class="field-row">
            <label>Responsável
              <select id="modalResponsavel" name="modalResponsavel" required></select>
            </label>
            <label>Prazo
              <input name="prazo" type="date" required>
            </label>
          </div>
          <div class="field-row">
            <label>Prioridade
              <select name="prioridade">
                <option value="alta">Alta</option>
                <option value="media" selected>Média</option>
                <option value="baixa">Baixa</option>
              </select>
            </label>
            <label>Status inicial
              <select name="status">
                <option value="backlog">A fazer</option>
                <option value="fazendo">Em progresso</option>
                <option value="pronto">Concluído</option>
              </select>
            </label>
          </div>
          <textarea name="detalhes" placeholder="Observações, necessidades ou anexos esperados"></textarea>
          <div class="detalhe-acoes">
            <button type="button" class="btn-cancelar" onclick="fecharOverlay('tarefaOverlay')">Cancelar</button>
            <button type="submit" class="btn-salvar">Salvar tarefa</button>
          </div>
        </form>
      </div>
    </div>

    <div id="anexoOverlay" class="detalhe-overlay hidden">
      <div class="modal-shell">
        <button class="detalhe-fechar" onclick="fecharOverlay('anexoOverlay')">✕</button>
        <h3>Anexar evidência ou nota</h3>
        <p class="caption">Relacione arquivos a um projeto ou tarefa existente.</p>
        <form id="formAnexoModal">
          <label>Projeto
            <select id="modalProjetoAnexo" name="modalProjetoAnexo"></select>
          </label>
          <label>Tarefa (opcional)
            <select id="modalTarefaAnexo" name="modalTarefaAnexo"></select>
          </label>
          <label>Descrição do arquivo
            <input name="descricao" type="text" required placeholder="Ex: Orçamento do fornecedor X">
          </label>
          <div class="field-row">
            <label>Tipo
              <select name="tipo">
                <option>PDF</option>
                <option>Imagem</option>
                <option>Planilha</option>
                <option>Recibo</option>
              </select>
            </label>
            <label>Tamanho
              <input name="tamanho" type="text" placeholder="1.2 MB">
            </label>
          </div>
          <textarea name="observacao" placeholder="O que este arquivo comprova ou libera?"></textarea>
          <div class="detalhe-acoes">
            <button type="button" class="btn-cancelar" onclick="fecharOverlay('anexoOverlay')">Cancelar</button>
            <button type="submit" class="btn-salvar">Salvar anexo</button>
          </div>
        </form>
      </div>
    </div>

    <div id="custoOverlay" class="detalhe-overlay hidden">
      <div class="modal-shell">
        <button class="detalhe-fechar" onclick="fecharOverlay('custoOverlay')">✕</button>
        <h3>Vincular custo ao plano</h3>
        <p class="caption">Somente abra quando precisar informar um gasto ou estimativa ligada a uma tarefa.</p>
        <form id="formCustoModal">
          <label>Projeto
            <select id="modalProjetoCusto" name="modalProjetoCusto"></select>
          </label>
          <label>Tarefa relacionada (opcional)
            <select id="modalTarefaCusto" name="modalTarefaCusto"></select>
          </label>
          <div class="field-row">
            <label>Categoria
              <input name="categoria" type="text" required placeholder="Ex: Alimentação, Hospedagem">
            </label>
            <label>Valor realizado
              <input name="valor" type="number" min="0" step="0.01" required>
            </label>
          </div>
          <textarea name="justificativa" placeholder="Justifique o gasto ou descreva o plano de ação sem custo."></textarea>
          <div class="detalhe-acoes">
            <button type="button" class="btn-cancelar" onclick="fecharOverlay('custoOverlay')">Cancelar</button>
            <button type="submit" class="btn-salvar">Registrar custo</button>
          </div>
        </form>
      </div>
    </div>

    <div id="detalheTarefaOverlay" class="detalhe-overlay hidden">
      <div class="modal-shell">
        <button class="detalhe-fechar" onclick="fecharOverlay('detalheTarefaOverlay')">✕</button>
        <div id="detalheTarefaConteudo"></div>
      </div>
    </div>
  </div>
  <div class="modo-edicao">
    <h2>Gerenciar Equipes e Projetos</h2>
    <div class="grid-3">
      <div class="card">
        <h3>Nova Equipe</h3>
        <form id="formEquipe">
          <input name="nomeEquipe" type="text" placeholder="Nome da equipe" required>
          <input name="responsavelEquipe" type="text" placeholder="Responsável" required>
          <textarea name="membrosEquipe" placeholder="Membros (separados por vírgula)"></textarea>
          <button type="submit" class="btn-salvar">Salvar Equipe</button>
        </form>
      </div>
      <div class="card">
        <h3>Novo Projeto</h3>
        <form id="formProjeto">
          <input name="nomeProjeto" type="text" placeholder="Nome do projeto" required>
          <select id="projetoEquipe" name="projetoEquipe" required></select>
          <input name="prazoProjeto" type="date" required>
          <select name="statusProjeto">
            <option value="pendente">Pendente</option>
            <option value="andamento">Em andamento</option>
            <option value="concluido">Concluído</option>
          </select>
          <button type="submit" class="btn-salvar">Salvar Projeto</button>
        </form>
      </div>
      <div class="card">
        <h3>Nova Tarefa (Kanban)</h3>
        <form id="formTarefa">
          <input name="tituloTarefa" type="text" placeholder="Título da tarefa" required>
          <select id="tarefaProjeto" name="tarefaProjeto" required></select>
          <input name="responsavelTarefa" type="text" placeholder="Responsável pela entrega" required>
          <input name="prazoTarefa" type="date" required>
          <select name="prioridadeTarefa">
            <option value="alta">Alta prioridade</option>
            <option value="media" selected>Média prioridade</option>
            <option value="baixa">Baixa prioridade</option>
          </select>
          <input name="etiquetaTarefa" type="text" placeholder="Etiqueta/Categoria (opcional)">
          <select name="statusTarefa">
            <option value="backlog">Backlog</option>
            <option value="fazendo">Fazendo</option>
            <option value="pronto">Pronto</option>
          </select>
          <button type="submit" class="btn-salvar">Adicionar Tarefa</button>
        </form>
      </div>
    </div>
    <div id="equipes-edicao"></div>
  </div>
</section>

<!-- PARTICIPANTES -->
<section id="participantes" class="view">
  <div class="view-toggle" id="participantesToggle">
    <button type="button" class="active" data-partview="cadastros">Cadastros</button>
    <button type="button" data-partview="lista">Lista de inscritos</button>
  </div>

  <div class="modo-leitura hidden" id="participantes-lista">
    <div class="totalizador">
      <div>
        <h2>Participantes Confirmados</h2>
        <p class="caption">Escolha se quer buscar, filtrar ou ordenar. Clique em uma linha para ver detalhes.</p>
      </div>
      <span class="pill" id="participantesTotalizador">0 pessoas</span>
    </div>
    <div class="table-controls">
      <input type="search" id="participantesBusca" placeholder="Buscar por nome, base, cidade...">
      <select id="participantesFiltro">
        <option value="todas">Todas as categorias</option>
        <option value="Família missionária">Família missionária</option>
        <option value="Equipe / Staff">Equipe / Staff</option>
        <option value="Preletor">Preletor</option>
        <option value="Convidado">Convidado</option>
        <option value="Pastor">Pastor</option>
      </select>
      <span id="participantesTotal" class="caption"></span>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-sort="categoria">Categoria <span>⇅</span></th>
            <th class="sortable" data-sort="nome">Nome / Referência <span>⇅</span></th>
            <th class="sortable" data-sort="base">Base / Igreja <span>⇅</span></th>
            <th class="sortable" data-sort="origem">Origem <span>⇅</span></th>
            <th class="sortable" data-sort="detalhe">Detalhe <span>⇅</span></th>
          </tr>
        </thead>
        <tbody id="participantesTabela"></tbody>
      </table>
    </div>
  </div>

  <div id="participanteOverlay" class="detalhe-overlay hidden">
    <div class="detalhe-shell">
      <div id="participanteDetalhes" class="detalhe-card"></div>
    </div>
  </div>

  <div class="modo-edicao" id="participantes-cadastros">
    <h2>Cadastros de participantes</h2>
    <p class="caption">Organize famílias missionárias, equipe de apoio, palestrantes, convidados e pastores com perguntas sob demanda.</p>

    <div class="subnav" aria-label="Abas de participantes">
      <button type="button" class="subtab active" data-subview="sub-missionarios">Família missionária</button>
      <button type="button" class="subtab" data-subview="sub-equipe">Equipe / Staff</button>
      <button type="button" class="subtab" data-subview="sub-preletores">Preletores</button>
      <button type="button" class="subtab" data-subview="sub-convidados">Convidados</button>
      <button type="button" class="subtab" data-subview="sub-pastores">Pastores</button>
      <button type="button" class="subtab" data-subview="sub-complementar">Campos complementares</button>
    </div>

    <div class="section-grid subview active" id="sub-missionarios">
      <div class="card card-full">
        <h3>Família missionária</h3>
        <p class="caption">Somente os campos necessários são exibidos. Confirme se há cônjuge e filhos antes de abrir os blocos.</p>
        <form id="formMissionario" class="stacked">
          <div class="field-row">
            <input name="base" type="text" placeholder="Base missionária" required>
            <input name="responsavel" type="text" placeholder="Nome completo do responsável" required>
          </div>
          <div class="field-row">
            <label>Data de nascimento
              <input name="nascimentoResponsavel" type="date" required>
            </label>
            <label>RG
              <input name="rgResponsavel" type="text" placeholder="Documento" required>
            </label>
            <label>CPF
              <input name="cpfResponsavel" type="text" placeholder="CPF" required>
            </label>
          </div>
          <div class="field-row">
            <label>Tamanho de camisa
              <select name="camisaResponsavel" required>
                <option value="">Selecione</option>
                <option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option>
              </select>
            </label>
            <label>Estado
              <select name="estado" required>
                <option value="">UF</option>
                <option>AC</option><option>AL</option><option>AM</option><option>BA</option><option>CE</option>
                <option>DF</option><option>ES</option><option>GO</option><option>MA</option><option>MG</option>
                <option>MS</option><option>MT</option><option>PA</option><option>PB</option><option>PE</option>
                <option>PI</option><option>PR</option><option>RJ</option><option>RN</option><option>RO</option>
                <option>RR</option><option>RS</option><option>SC</option><option>SE</option><option>SP</option><option>TO</option>
              </select>
            </label>
            <label>Município
              <input name="municipio" type="text" placeholder="Cidade" required>
            </label>
          </div>
          <div class="field-row">
            <label>Casado?
              <select id="casado" name="casado" required>
                <option value="nao">Não</option>
                <option value="sim">Sim</option>
              </select>
            </label>
            <label>Filhos?
              <select id="temFilhos" name="temFilhos" required>
                <option value="nao">Não</option>
                <option value="sim">Sim</option>
              </select>
            </label>
          </div>

          <div id="blocoConjuge" class="stacked hidden">
            <h4>Cônjuge</h4>
            <div class="field-row">
              <input name="conjugeNome" type="text" placeholder="Nome completo do cônjuge">
              <label>Data de nascimento
                <input name="conjugeNascimento" type="date">
              </label>
              <label>RG
                <input name="conjugeRg" type="text" placeholder="Documento">
              </label>
              <label>CPF
                <input name="conjugeCpf" type="text" placeholder="CPF">
              </label>
            </div>
            <label>Tamanho de camisa
              <select name="conjugeCamisa">
                <option value="">Selecione</option>
                <option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option>
              </select>
            </label>
          </div>

          <div id="blocoFilhos" class="stacked hidden">
            <div class="field-row">
              <label>Quantos filhos irão para o evento?
                <input id="quantosFilhos" name="quantosFilhos" type="number" min="1" value="1">
              </label>
            </div>
            <div id="filhosContainer" class="stacked"></div>
          </div>

          <button type="submit" class="btn-salvar">Salvar família missionária</button>
        </form>
      </div>
    </div>

    <div class="section-grid subview" id="sub-equipe">
      <div class="card">
        <h3>Equipe / Staff</h3>
        <form id="formEquipePessoa" class="stacked">
          <input name="base" type="text" placeholder="Base / área" required>
          <input name="nome" type="text" placeholder="Nome completo" required>
          <div class="field-row">
            <label>Data de nascimento
              <input name="nascimento" type="date" required>
            </label>
            <label>RG
              <input name="rg" type="text" placeholder="Documento" required>
            </label>
            <label>CPF
              <input name="cpf" type="text" placeholder="CPF" required>
            </label>
          </div>
          <label>Tamanho de camisa
            <select name="camisa" required>
              <option value="">Selecione</option>
              <option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option>
            </select>
          </label>
          <button type="submit" class="btn-salvar">Adicionar membro de equipe</button>
        </form>
      </div>
    </div>

    <div class="section-grid subview" id="sub-preletores">
      <div class="card">
        <h3>Preletores / Palestrantes</h3>
        <form id="formPreletor" class="stacked">
          <input name="nome" type="text" placeholder="Nome completo" required>
          <label>Tamanho de camisa
            <select name="camisa" required>
              <option value="">Selecione</option>
              <option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option>
            </select>
          </label>
          <input name="tempo" type="text" placeholder="Tempo no evento (ex: 2 dias)" required>
          <button type="submit" class="btn-salvar">Salvar palestrante</button>
        </form>
      </div>
    </div>

    <div class="section-grid subview" id="sub-convidados">
      <div class="card">
        <h3>Convidados</h3>
        <form id="formConvidado" class="stacked">
          <input name="nome" type="text" placeholder="Nome completo" required>
          <label>Tamanho de camisa
            <select name="camisa" required>
              <option value="">Selecione</option>
              <option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option>
            </select>
          </label>
          <input name="tempo" type="text" placeholder="Tempo no evento (ex: 1 dia ou 1 refeição)">
          <button type="submit" class="btn-salvar">Salvar convidado</button>
        </form>
      </div>
    </div>

    <div class="section-grid subview" id="sub-pastores">
      <div class="card card-full">
        <h3>Pastores das igrejas enviadoras</h3>
        <form id="formPastor" class="stacked">
          <div class="field-row">
            <input name="igreja" type="text" placeholder="Igreja" required>
            <label>UF
              <select name="uf" required>
                <option value="">UF</option>
                <option>AC</option><option>AL</option><option>AM</option><option>BA</option><option>CE</option>
                <option>DF</option><option>ES</option><option>GO</option><option>MA</option><option>MG</option>
                <option>MS</option><option>MT</option><option>PA</option><option>PB</option><option>PE</option>
                <option>PI</option><option>PR</option><option>RJ</option><option>RN</option><option>RO</option>
                <option>RR</option><option>RS</option><option>SC</option><option>SE</option><option>SP</option><option>TO</option>
              </select>
            </label>
            <input name="municipio" type="text" placeholder="Município" required>
          </div>
          <div class="field-row">
            <input name="nome" type="text" placeholder="Nome completo" required>
            <label>Telefone 1
              <input name="tel1" type="tel" placeholder="(DDD)">
            </label>
            <label>Telefone 2
              <input name="tel2" type="tel" placeholder="Opcional">
            </label>
          </div>
          <div class="field-row">
            <label>Data de nascimento
              <input name="nascimento" type="date">
            </label>
            <label>RG
              <input name="rg" type="text" placeholder="Documento">
            </label>
            <label>CPF
              <input name="cpf" type="text" placeholder="CPF">
            </label>
          </div>
          <div class="field-row">
            <label>Tamanho de camisa
              <select name="camisa" required>
                <option value="">Selecione</option>
                <option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option>
              </select>
            </label>
            <label>Casado?
              <select name="casado" id="pastorCasado">
                <option value="nao">Não</option>
                <option value="sim">Sim</option>
              </select>
            </label>
          </div>
          <div id="blocoConjugePastor" class="stacked hidden">
            <h4>Cônjuge</h4>
            <div class="field-row">
              <input name="conjugeNome" type="text" placeholder="Nome completo do cônjuge">
              <label>Data de nascimento
                <input name="conjugeNascimento" type="date">
              </label>
              <label>RG
                <input name="conjugeRg" type="text" placeholder="Documento">
              </label>
              <label>CPF
                <input name="conjugeCpf" type="text" placeholder="CPF">
              </label>
            </div>
            <label>Tamanho de camisa
              <select name="conjugeCamisa">
                <option value="">Selecione</option>
                <option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option>
              </select>
            </label>
          </div>
          <button type="submit" class="btn-salvar">Salvar pastor</button>
        </form>
      </div>
    </div>

    <div class="section-grid subview" id="sub-complementar">
      <div class="card card-full">
        <h3>Campos personalizados (formulário complementar)</h3>
        <p class="caption">Adicione perguntas de cuidado válidas para qualquer cadastro e registre respostas por participante ou família.</p>
        <form id="formCampoPersonalizado" class="stacked">
          <div class="field-row">
            <input name="pergunta" type="text" placeholder="Nova pergunta" required>
            <select name="tipo" required>
              <option value="texto">Resposta em texto</option>
              <option value="simnao">Sim/Não</option>
              <option value="longo">Texto longo</option>
            </select>
            <input name="ajuda" type="text" placeholder="Observação (opcional)">
          </div>
          <button type="submit" class="btn-salvar">Adicionar campo personalizado</button>
        </form>

        <div id="listaCamposPersonalizados" class="stacked"></div>

        <form id="formRespostasPersonalizadas" class="stacked">
          <input name="referencia" type="text" placeholder="Para qual cadastro? Ex: Família Silva" required>
          <div id="respostasDinamicas" class="stacked"></div>
          <button type="submit" class="btn-salvar">Salvar formulário complementar</button>
        </form>
        <div id="listaRespostasPersonalizadas"></div>
      </div>
    </div>

  </div>
</section>
<!-- TRANSPORTE -->
<section id="transporte" class="view">
  <div class="modo-leitura">
    <h2>Transporte Organizado</h2>
    <div id="leitura-transporte"></div>
  </div>
  <div class="modo-edicao">
    <h2>Adicionar Transporte</h2>
    <form id="formOnibus">
      <input type="text" placeholder="Cidade de origem" required>
      <input type="number" placeholder="Passageiros" required>
      <input type="text" placeholder="Empresa/Motorista" required>
      <input type="datetime-local" required>
      <button type="submit" class="btn-salvar">Adicionar Ônibus</button>
    </form>
    <form id="formVoo" style="margin-top:1rem;">
      <input type="text" placeholder="Passageiro" required>
      <input type="text" placeholder="Voo (ex: G3 1234)" required>
      <input type="datetime-local" required>
      <button type="submit" class="btn-salvar">Adicionar Voo</button>
    </form>
    <div id="edicao-transporte"></div>
  </div>
</section>

<!-- ALOJAMENTO -->
<section id="alojamento" class="view">
  <div class="modo-leitura">
    <h2>Alojamentos</h2>
    <p>Distribua as famílias em quartos usando o painel interativo abaixo.</p>
    <div id="quartos-integrados">
      <header>
        <div>
          <h3>Distribuição de Quartos (protótipo integrado)</h3>
          <span>Conteúdo do quartos.html agora conectado às famílias cadastradas.</span>
        </div>
        <div class="badge">Mapa rápido</div>
      </header>
      <div class="qa-layout">
        <section class="qa-panel" id="qaSpacesPanel">
          <div class="qa-stack">
            <h4>Espaços / prédios <small>Monte blocos para organizar os quartos.</small></h4>
            <div class="qa-row">
              <input id="qaSpaceName" type="text" class="qa-input" placeholder="Nome do espaço" />
              <input id="qaSpaceColor" type="color" value="#2563eb" class="qa-input" style="width:70px; padding:0;" />
            </div>
            <button id="qaAddSpaceBtn" class="qa-btn primary">+ Adicionar espaço</button>
            <div class="qa-space-list" id="qaSpaceList"></div>
          </div>

          <div class="qa-stack">
            <h4>Quartos do espaço <small>Presets ou criação manual.</small></h4>
            <div class="qa-row wrap">
              <button class="qa-btn secondary small" data-qa-preset="casal">Casal (2)</button>
              <button class="qa-btn secondary small" data-qa-preset="pequena">Família pequena (4)</button>
              <button class="qa-btn secondary small" data-qa-preset="media">Família média (6)</button>
              <button class="qa-btn secondary small" data-qa-preset="grande">Beliches grande (8)</button>
            </div>
            <div class="qa-row wrap">
              <input id="qaRoomName" type="text" class="qa-input" placeholder="Nome / nº do quarto" style="flex:1" />
              <input id="qaRoomCapacity" type="number" class="qa-input" min="1" value="4" style="width:90px" />
            </div>
            <small>Capacidade define a soma de camas; beliches usam 2 andares por padrão.</small>
            <button id="qaAddRoomBtn" class="qa-btn primary">+ Adicionar quarto</button>
          </div>
        </section>

        <section class="qa-panel" id="qaCanvasPanel">
          <h4>Mapa do espaço selecionado <small>Arraste cartões para montar a planta.</small></h4>
          <div class="qa-canvas" id="qaCanvas">
            <div class="qa-label" id="qaCanvasLabel">Nenhum espaço selecionado</div>
            <div class="qa-canvas-inner" id="qaCanvasInner"></div>
          </div>
        </section>

        <section class="qa-panel" id="qaFamiliesPanel">
          <h4>Famílias / participantes <small>Arraste para um quarto.</small></h4>
          <div class="qa-family-search qa-stack">
            <input type="text" id="qaFamilySearch" class="qa-input" placeholder="Buscar família" />
            <span class="muted" id="qaFamilyCount"></span>
          </div>
          <div class="qa-family-list" id="qaFamilyList"></div>
          <div class="qa-details" id="qaRoomDetails"></div>
        </section>
      </div>
    </div>
    <div id="leitura-alojamento"></div>
  </div>
</section>

<!-- CRONOGRAMA -->
<section id="cronograma" class="view">
  <div class="modo-leitura">
    <h2>Cronograma</h2>
    <div id="cronograma-lista"></div>
  </div>
  <div class="modo-edicao">
    <h2>Adicionar Atividade</h2>
    <form id="formCronograma">
      <input type="datetime-local" required>
      <input type="text" placeholder="Atividade" required>
      <input type="text" placeholder="Responsável" required>
      <button type="submit" class="btn-salvar">Salvar Atividade</button>
    </form>
    <div id="cronograma-edicao"></div>
  </div>
</section>

<!-- CARDÁPIO -->
<section id="cardapio" class="view">
  <div class="modo-leitura">
    <h2>Cardápio e Compras Automáticas</h2>
    <div id="cardapio-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Planejar Refeição</h2>
    <form id="formRefeicao">
      <input type="date" required>
      <select>
        <option>Café</option>
        <option>Almoço</option>
        <option>Jantar</option>
      </select>
      <textarea placeholder="Cardápio detalhado" required></textarea>
      <button type="submit" class="btn-salvar">Salvar Refeição</button>
    </form>
    <div id="cardapio-edicao"></div>
  </div>
</section>

<!-- COMPRAS -->
<section id="compras" class="view">
  <div class="modo-leitura">
    <h2>Solicitações, Aprovações e Pedidos</h2>
    <div id="compras-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Fluxo de Compras</h2>
    <div class="grid-3">
      <div class="card">
        <h3>Solicitar Compra</h3>
        <form id="formSolicitacao">
          <input type="text" placeholder="Item" required>
          <input type="number" placeholder="Quantidade" min="1" required>
          <input type="text" placeholder="Centro de Custo" required>
          <button type="submit" class="btn-salvar">Nova Solicitação</button>
        </form>
      </div>
      <div class="card">
        <h3>Aprovação Orçamentária</h3>
        <form id="formAprovacao">
          <select id="aprovacaoSolicitacao" required></select>
          <input type="number" placeholder="Valor aprovado" min="0" step="0.01" required>
          <button type="submit" class="btn-salvar">Aprovar</button>
        </form>
      </div>
      <div class="card">
        <h3>Registrar Pedido</h3>
        <form id="formPedido">
          <select id="pedidoAprovado" required></select>
          <input type="text" placeholder="Fornecedor" required>
          <button type="submit" class="btn-salvar">Registrar Pedido</button>
        </form>
      </div>
    </div>
    <div id="compras-edicao"></div>
  </div>
</section>

<!-- PALESTRAS -->
<section id="palestras" class="view">
  <div class="modo-leitura">
    <h2>Palestras</h2>
    <div id="palestras-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Programar Palestra</h2>
    <form id="formPalestra">
      <input type="datetime-local" required>
      <input type="text" placeholder="Tema" required>
      <input type="text" placeholder="Palestrante" required>
      <button type="submit" class="btn-salvar">Salvar</button>
    </form>
    <div id="palestras-edicao"></div>
  </div>
</section>

<!-- KIDS -->
<section id="kids" class="view">
  <div class="modo-leitura">
    <h2>Programação Kids</h2>
    <div id="kids-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Adicionar Atividade Kids</h2>
    <form id="formKids">
      <input type="datetime-local" required>
      <input type="text" placeholder="Atividade" required>
      <input type="text" placeholder="Responsável" required>
      <button type="submit" class="btn-salvar">Salvar</button>
    </form>
    <div id="kids-edicao"></div>
  </div>
</section>

<!-- FINANCEIRO -->
<section id="financeiro" class="view">
  <div class="modo-leitura">
    <h2>Financeiro</h2>
    <div id="financeiro-leitura"></div>
  </div>
  <div class="modo-edicao">
    <h2>Atualizar Financeiro</h2>
    <div class="grid-3">
      <div class="card">
        <h3>Totais</h3>
        <form id="formFinanceiro">
          <input type="number" placeholder="Orçado" min="0" step="0.01" required>
          <input type="number" placeholder="Realizado" min="0" step="0.01" required>
          <button type="submit" class="btn-salvar">Salvar Totais</button>
        </form>
      </div>
      <div class="card">
        <h3>Novo Centro de Custo</h3>
        <form id="formCentro">
          <input type="text" placeholder="Centro" required>
          <input type="number" placeholder="Orçado" min="0" step="0.01" required>
          <input type="number" placeholder="Realizado" min="0" step="0.01" required>
          <button type="submit" class="btn-salvar">Adicionar Centro</button>
        </form>
      </div>
    </div>
    <div id="financeiro-edicao"></div>
  </div>
</section>

</main>
</div>

<script>
// =============================================
// DADOS + PERSISTÊNCIA
// =============================================
const DB = {
  usuarios: [],
  logs: [],
  sessao: null,
  familias: [],
  missionarios: [],
  equipePessoas: [],
  preletores: [],
  convidados: [],
  pastores: [],
  onibus: [],
  voos: [],
  equipes: [],
  projetos: [],
  tarefas: [],
  quartos: [],
  espacos: [],
  cronograma: [],
  refeicoes: [],
  solicitacoes: [],
  aprovacoes: [],
  pedidos: [],
  palestras: [],
  kids: [],
  anexos: [],
  custosProjetos: [],
  marcos: [],
  notificacoesProjetos: [],
  respostasTarefas: [],
  camposPersonalizados: [
    { id: 1, pergunta: 'Você ou alguém da sua família possui algum tipo de alergia?', tipo: 'texto', ajuda: 'Qual tipo de alergia?' },
    { id: 2, pergunta: 'Você ou alguém da sua família possui alguma restrição alimentar?', tipo: 'longo', ajuda: 'Liste as restrições alimentares.' },
    { id: 3, pergunta: 'Você ou alguém da sua família faz uso de algum medicamento?', tipo: 'longo', ajuda: 'Quais medicamentos e horários?' }
  ],
  respostasPersonalizadas: [],
  financeiro: { orcado: 0, realizado: 0, centros: [] }
};

const coresEspaco = ['#e0f2fe', '#ede9fe', '#dcfce7', '#fef9c3'];
let mapaZoom = 1;
let quartoSelecionadoId = null;
let quartoEditandoId = null;
let modoDesenho = null;
let inicioDesenho = null;
let previewDesenho = null;
let projetoSelecionadoId = null;
const tabelaParticipantesState = { filtro: 'todas', busca: '', sortBy: 'categoria', direction: 'asc' };
let participanteSelecionado = null;
let detalheEditando = false;
const categoriaLabels = {
  missionario: 'Família missionária',
  equipe: 'Equipe / Staff',
  preletor: 'Preletor',
  convidado: 'Convidado',
  pastor: 'Pastor'
};

function seedProjetosDemo() {
  if (DB.projetos.length) return;
  const equipesSeed = [
    { id: 101, nome: 'Coordenação Geral', responsavel: 'Ana Ribeiro', membros: 'Ana, Lucas, Tiago, Fernanda' },
    { id: 102, nome: 'Logística & Hospedagem', responsavel: 'Marcelo Dias', membros: 'Marcelo, Camila, Pedro' },
    { id: 103, nome: 'Comunicação & Conteúdo', responsavel: 'Helena Souza', membros: 'Helena, João, Carla' }
  ];
  DB.equipes.push(...equipesSeed);

  const projetosSeed = [
    { id: 201, nome: 'Encontro Nacional 2024', equipeId: 101, prazo: '2024-10-20', status: 'andamento' },
    { id: 202, nome: 'Treinamento de Voluntários', equipeId: 103, prazo: '2024-10-05', status: 'andamento' },
    { id: 203, nome: 'Expansão de Hospedagem', equipeId: 102, prazo: '2024-09-30', status: 'pendente' }
  ];
  DB.projetos.push(...projetosSeed);
  projetoSelecionadoId = projetosSeed[0].id;

  DB.tarefas.push(
    { id: 301, titulo: 'Planejar logística de ônibus', projetoId: 201, status: 'fazendo', responsavel: 'Marcelo Dias', prazo: '2024-09-18', prioridade: 'alta', etiqueta: 'Transporte' },
    { id: 302, titulo: 'Fechar fornecedores de refeições', projetoId: 201, status: 'backlog', responsavel: 'Ana Ribeiro', prazo: '2024-09-22', prioridade: 'media', etiqueta: 'Alimentação' },
    { id: 303, titulo: 'Roteiro de comunicação pré-evento', projetoId: 202, status: 'fazendo', responsavel: 'Helena Souza', prazo: '2024-09-15', prioridade: 'media', etiqueta: 'Comunicação' },
    { id: 304, titulo: 'Definir mapa de alojamento', projetoId: 203, status: 'backlog', responsavel: 'Camila Lopes', prazo: '2024-09-25', prioridade: 'alta', etiqueta: 'Alojamento' },
    { id: 305, titulo: 'Treinar equipe de recepção', projetoId: 202, status: 'pronto', responsavel: 'João Martins', prazo: '2024-09-10', prioridade: 'baixa', etiqueta: 'Pessoas' }
  );

  DB.anexos.push(
    { id: 401, projetoId: 201, nome: 'Briefing do evento', tipo: 'PDF', dono: 'Ana Ribeiro', data: '2024-08-30', tamanho: '1.2 MB' },
    { id: 402, projetoId: 201, nome: 'Planilha de orçamento', tipo: 'Planilha', dono: 'Lucas Prado', data: '2024-09-05', tamanho: '860 KB' },
    { id: 403, projetoId: 202, nome: 'Guia de treinamento', tipo: 'Apresentação', dono: 'Helena Souza', data: '2024-09-08', tamanho: '2.5 MB' }
  );

  DB.custosProjetos.push(
    { id: 501, projetoId: 201, categoria: 'Infraestrutura', previsto: 18000, realizado: 9200 },
    { id: 502, projetoId: 201, categoria: 'Alimentação', previsto: 12000, realizado: 3600 },
    { id: 503, projetoId: 202, categoria: 'Treinamento', previsto: 6000, realizado: 2500 },
    { id: 504, projetoId: 203, categoria: 'Hospedagem', previsto: 15000, realizado: 0 }
  );

  DB.marcos.push(
    { id: 601, projetoId: 201, titulo: 'Kick-off com equipes', data: '2024-09-01', responsavel: 'Ana Ribeiro', tipo: 'milestone' },
    { id: 602, projetoId: 201, titulo: 'Fechamento de fornecedores', data: '2024-09-22', responsavel: 'Lucas Prado', tipo: 'marco' },
    { id: 603, projetoId: 202, titulo: 'Treinamento online', data: '2024-09-12', responsavel: 'Helena Souza', tipo: 'entrega' },
    { id: 604, projetoId: 203, titulo: 'Liberar novos quartos', data: '2024-09-28', responsavel: 'Marcelo Dias', tipo: 'marco' }
  );

  DB.notificacoesProjetos.push(
    { id: 701, projetoId: 201, mensagem: 'Fornecedor de alimentação pendente de contrato.', severidade: 'alerta' },
    { id: 702, projetoId: 201, mensagem: 'Prazo de transporte se aproxima em 3 dias.', severidade: 'alerta' },
    { id: 703, projetoId: 202, mensagem: 'Treinamento concluído para 80% da equipe.', severidade: 'ok' }
  );
}

seedProjetosDemo();

function layoutPadraoQuarto(idx = 0) {
  const coluna = idx % 4;
  const linha = Math.floor(idx / 4);
  return {
    x: 60 + coluna * 220,
    y: 40 + linha * 180,
    width: 200,
    height: 120
  };
}

function garantirLayout(quarto, idx = 0) {
  if (!quarto.layout) quarto.layout = layoutPadraoQuarto(idx);
  quarto.layout.width = Math.max(quarto.layout.width || 0, 140);
  quarto.layout.height = Math.max(quarto.layout.height || 0, 90);
}

function registrarArrasto(elemento, onUpdate) {
  elemento.addEventListener('mousedown', e => {
    if (modoDesenho || e.button !== 0) return;
    const start = {
      x: e.clientX,
      y: e.clientY,
      left: parseFloat(elemento.style.left) || 0,
      top: parseFloat(elemento.style.top) || 0
    };
    elemento.classList.add('arrastando');

    const mover = ev => {
      const dx = (ev.clientX - start.x) / mapaZoom;
      const dy = (ev.clientY - start.y) / mapaZoom;
      const novoX = Math.max(0, start.left + dx);
      const novoY = Math.max(0, start.top + dy);
      onUpdate(novoX, novoY);
      elemento.style.left = `${novoX}px`;
      elemento.style.top = `${novoY}px`;
    };

    const soltar = () => {
      document.removeEventListener('mousemove', mover);
      document.removeEventListener('mouseup', soltar);
      elemento.classList.remove('arrastando');
      salvar();
    };

    document.addEventListener('mousemove', mover);
    document.addEventListener('mouseup', soltar);
  });
}

function vincularFamiliaAoQuarto(quartoId, familiaId) {
  const quarto = DB.quartos.find(q => q.id === quartoId);
  const familia = DB.familias.find(f => f.id === familiaId);
  if (!quarto || !familia) return;
  if (!quarto.ocupantes) quarto.ocupantes = [];
  if (quarto.ocupantes.includes(familiaId)) return alert('Essa família já está no quarto.');
  if (ocupacaoQuarto(quarto) + familia.qtd > capacidadeQuarto(quarto)) return alert('Capacidade insuficiente para essa família.');
  quarto.ocupantes.push(familiaId);
  quartoSelecionadoId = quartoId;
  atualizarLeitura();
  atualizarEdicao();
  salvar();
}

function capacidadeQuarto(quarto) {
  if (!quarto) return 0;
  return tiposDeCama(quarto).reduce((total, tipo) => {
    if (tipo.tipo === 'Casal') return total + (tipo.quantidade || 0) * 2;
    if (tipo.tipo === 'Beliche') return total + (tipo.quantidade || 0) * (tipo.andares || 2);
    return total + (tipo.quantidade || 0);
  }, 0);
}

function ocupacaoQuarto(quarto) {
  if (!quarto || !quarto.ocupantes) return 0;
  return quarto.ocupantes.reduce((total, familiaId) => {
    const familia = DB.familias.find(f => f.id === familiaId);
    return total + (familia ? familia.qtd : 0);
  }, 0);
}

function descricaoTipoQuarto(quarto) {
  const tipos = tiposDeCama(quarto);
  if (!tipos.length) return '—';
  return tipos.map(t => {
    if (t.tipo === 'Beliche') return `${t.quantidade || 0} beliches (${t.andares || 2} andares)`;
    if (t.tipo === 'Casal') return `${t.quantidade || 0} cama(s) de casal`;
    return `${t.quantidade || 0} cama(s) de solteiro`;
  }).join(' • ');
}

function vagasDisponiveis(quarto) {
  return Math.max(capacidadeQuarto(quarto) - ocupacaoQuarto(quarto), 0);
}

function tiposDeCama(quarto) {
  if (!quarto) return [];
  if (Array.isArray(quarto.tiposCama) && quarto.tiposCama.length) return quarto.tiposCama;
  if (quarto.tipo) return [{ tipo: quarto.tipo, quantidade: quarto.camas || 0, andares: quarto.andares }];
  return [];
}

function renderPainelQuarto(quarto) {
  const painel = document.getElementById('painel-quarto');
  if (!painel) return;
  if (!quarto) {
    painel.innerHTML = '<p>Selecione um quarto no mapa para ver detalhes, editar ou remover.</p>';
    painel.classList.add('hidden');
    return;
  }
  painel.classList.remove('hidden');
  const ocupantes = (quarto.ocupantes || []).map(id => {
    const familia = DB.familias.find(f => f.id === id);
    return familia ? `<span class="pill">${familia.nome} (${familia.qtd}p)</span>` : '<span class="pill">Removido</span>';
  }).join('');
  const camas = tiposDeCama(quarto).map(t => `<span class="pill">${t.quantidade} x ${t.tipo}${t.tipo === 'Beliche' ? ` (${t.andares || 2} andares)` : ''}</span>`).join('');
  painel.innerHTML = `
    <h4>${quarto.nome}</h4>
    <p><strong>Capacidade:</strong> ${capacidadeQuarto(quarto)} vagas • <strong>Ocupação:</strong> ${ocupacaoQuarto(quarto)}</p>
    <p><strong>Camas:</strong> ${camas || '—'}</p>
    <p><strong>Ocupantes:</strong> ${ocupantes || 'Sem participantes vinculados.'}</p>
    <div class="section-actions">
      <button type="button" class="btn-secondary" onclick="entrarEdicaoQuarto(${quarto.id})">Editar quarto</button>
      <button type="button" class="btn-no" onclick="removerQuarto(${quarto.id})">Remover do mapa</button>
    </div>
  `;
}

function renderCamposFilhos(qtd = 0) {
  const container = document.getElementById('filhosContainer');
  if (!container) return;
  container.innerHTML = '';
  const total = Math.max(Number(qtd) || 0, 0);
  const opcoesCamisa = '<option value="">Selecione</option><option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option>';
  for (let i = 0; i < total; i++) {
    const bloco = document.createElement('div');
    bloco.className = 'field-row';
    bloco.innerHTML = `
      <div class="stacked" style="gap:0.35rem;">
        <strong>Filho ${i + 1}</strong>
        <input name="filho_nome_${i}" type="text" placeholder="Nome completo do filho ${i + 1}" required>
      </div>
      <label>Data de nascimento
        <input name="filho_nascimento_${i}" type="date" required>
      </label>
      <label>RG
        <input name="filho_rg_${i}" type="text" placeholder="Documento">
      </label>
      <label>CPF
        <input name="filho_cpf_${i}" type="text" placeholder="CPF">
      </label>
      <label>Tamanho de camisa
        <select name="filho_camisa_${i}">${opcoesCamisa}</select>
      </label>`;
    container.appendChild(bloco);
  }
}

function toggleBlocosFamilia() {
  const casado = document.getElementById('casado');
  const blocoConjuge = document.getElementById('blocoConjuge');
  const temFilhos = document.getElementById('temFilhos');
  const blocoFilhos = document.getElementById('blocoFilhos');
  const qtdFilhos = document.getElementById('quantosFilhos');
  const casadoSelecionado = casado && casado.value === 'sim';
  if (blocoConjuge) blocoConjuge.classList.toggle('hidden', !casadoSelecionado);
  const mostrarFilhos = casadoSelecionado && temFilhos && temFilhos.value === 'sim';
  if (blocoFilhos) blocoFilhos.classList.toggle('hidden', !mostrarFilhos);
  if (mostrarFilhos) {
    renderCamposFilhos(qtdFilhos ? qtdFilhos.value : 0);
  } else {
    renderCamposFilhos(0);
  }
}

function toggleConjugePastor() {
  const select = document.getElementById('pastorCasado');
  const bloco = document.getElementById('blocoConjugePastor');
  if (!select || !bloco) return;
  bloco.classList.toggle('hidden', select.value !== 'sim');
}

function limparFamiliaDeQuartos(id) {
  DB.quartos.forEach(q => {
    if (!q.ocupantes) return;
    q.ocupantes = q.ocupantes.filter(ocupanteId => ocupanteId !== id);
  });
}

// =============================================
// QUARTOS AVANÇADOS (quartos.html integrado)
// =============================================
const uiQuartos = { espacoAtivo: null, quartoAtivo: null };

function gerarIdQuartoEspaco() { return Date.now() + Math.floor(Math.random() * 1000); }
function tiposDeCamaPorPreset(preset, capacidade = 1) {
  if (preset === 'casal') return [{ tipo: 'Casal', quantidade: 1 }];
  if (preset === 'pequena') return [{ tipo: 'Beliche', quantidade: 2, andares: 2 }];
  if (preset === 'media') return [{ tipo: 'Beliche', quantidade: 3, andares: 2 }];
  if (preset === 'grande') return [{ tipo: 'Beliche', quantidade: 4, andares: 2 }];
  return [{ tipo: 'Solteiro', quantidade: capacidade, andares: 1 }];
}

function criarEspacoIntegrado(nome, cor) {
  const espaco = { id: gerarIdQuartoEspaco(), nome, cor, x: 30 + DB.espacos.length * 12, y: 30 + DB.espacos.length * 12, width: 200, height: 140 };
  DB.espacos.push(espaco);
  uiQuartos.espacoAtivo = espaco.id;
  return espaco.id;
}

function criarQuartoIntegrado(espacoId, nome, capacidade, preset) {
  const layout = layoutPadraoQuarto(DB.quartos.length);
  const quarto = {
    id: gerarIdQuartoEspaco(),
    nome,
    espacoId,
    tiposCama: tiposDeCamaPorPreset(preset, capacidade),
    ocupantes: [],
    layout
  };
  DB.quartos.push(quarto);
  uiQuartos.quartoAtivo = quarto.id;
  return quarto;
}

function quartosDoEspaco(id) { return DB.quartos.filter(q => q.espacoId === id); }
function familiaEstaAlocada(id) { return DB.quartos.some(q => (q.ocupantes || []).includes(id)); }

function renderEspacosIntegrados() {
  const lista = document.getElementById('qaSpaceList');
  if (!lista) return;
  lista.innerHTML = '';
  if (!DB.espacos.length) {
    lista.innerHTML = '<small class="muted">Nenhum espaço criado.</small>';
    return;
  }
  DB.espacos.forEach(espaco => {
    const card = document.createElement('div');
    card.className = 'qa-space' + (uiQuartos.espacoAtivo === espaco.id ? ' active' : '');
    card.innerHTML = `
      <span class="qa-space-color" style="background:${espaco.cor || '#94a3b8'}"></span>
      <span class="space-name">${espaco.nome}</span>
      <small>${quartosDoEspaco(espaco.id).length} quarto(s)</small>
    `;
    card.addEventListener('click', () => {
      uiQuartos.espacoAtivo = espaco.id;
      uiQuartos.quartoAtivo = null;
      renderQuartosIntegrados();
    });
    lista.appendChild(card);
  });
}

function renderCanvasIntegrado() {
  const canvas = document.getElementById('qaCanvasInner');
  const label = document.getElementById('qaCanvasLabel');
  if (!canvas || !label) return;
  canvas.innerHTML = '';
  const espaco = DB.espacos.find(e => e.id === uiQuartos.espacoAtivo);
  if (!espaco) {
    label.textContent = 'Nenhum espaço selecionado';
    return;
  }
  label.textContent = `Espaço: ${espaco.nome}`;

  const quartos = quartosDoEspaco(espaco.id);
  quartos.forEach((quarto, idx) => {
    garantirLayout(quarto, idx);
    const div = document.createElement('div');
    const ocupacao = ocupacaoQuarto(quarto);
    const capacidade = capacidadeQuarto(quarto);
    const familias = (quarto.ocupantes || []).map(id => {
      const familia = DB.familias.find(f => f.id === id);
      return familia ? familia.nome : 'Removido';
    }).filter(Boolean);
    div.className = 'qa-room' + (uiQuartos.quartoAtivo === quarto.id ? ' selected' : '');
    div.style.left = `${quarto.layout.x}px`;
    div.style.top = `${quarto.layout.y}px`;
    div.style.width = `${quarto.layout.width}px`;
    div.style.height = `${quarto.layout.height}px`;
    div.innerHTML = `
      <div class="qa-room-head">
        <span>${quarto.nome}</span>
        <span class="qa-room-tag">${ocupacao}/${capacidade}</span>
      </div>
      <div class="qa-room-info">${descricaoTipoQuarto(quarto)}</div>
      <div class="qa-room-info">${familias.length ? familias.join(', ') : 'Arraste uma família'}</div>
    `;

    div.addEventListener('click', e => {
      e.stopPropagation();
      uiQuartos.quartoAtivo = quarto.id;
      renderQuartosIntegrados();
    });

    div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('drop-target'); });
    div.addEventListener('dragleave', () => div.classList.remove('drop-target'));
    div.addEventListener('drop', e => {
      e.preventDefault();
      div.classList.remove('drop-target');
      const familiaId = Number(e.dataTransfer.getData('text/familia'));
      if (familiaId) vincularFamiliaAoQuarto(quarto.id, familiaId);
      renderQuartosIntegrados();
    });

    let arrastando = false; let inicio = null;
    div.addEventListener('mousedown', e => {
      if (e.button !== 0) return;
      arrastando = true;
      inicio = { x: e.clientX, y: e.clientY, left: quarto.layout.x, top: quarto.layout.y };
      const mover = ev => {
        if (!arrastando) return;
        const dx = ev.clientX - inicio.x;
        const dy = ev.clientY - inicio.y;
        quarto.layout.x = Math.max(10, inicio.left + dx);
        quarto.layout.y = Math.max(20, inicio.top + dy);
        div.style.left = `${quarto.layout.x}px`;
        div.style.top = `${quarto.layout.y}px`;
      };
      const soltar = () => {
        arrastando = false;
        document.removeEventListener('mousemove', mover);
        document.removeEventListener('mouseup', soltar);
        salvar();
      };
      document.addEventListener('mousemove', mover);
      document.addEventListener('mouseup', soltar);
    });

    canvas.appendChild(div);
  });

  canvas.addEventListener('click', () => {
    uiQuartos.quartoAtivo = null;
    renderQuartosIntegrados();
  }, { once: true });
}

function renderFamiliasIntegradas() {
  const lista = document.getElementById('qaFamilyList');
  const contador = document.getElementById('qaFamilyCount');
  if (!lista) return;
  const termo = (document.getElementById('qaFamilySearch')?.value || '').toLowerCase();
  const filtradas = DB.familias.filter(f => f.nome.toLowerCase().includes(termo));
  if (contador) contador.textContent = `${filtradas.length} família(s)`;
  lista.innerHTML = '';
  if (!filtradas.length) {
    lista.innerHTML = '<p class="muted">Nenhuma família encontrada.</p>';
    return;
  }
  filtradas.forEach(f => {
    const card = document.createElement('div');
    const alocada = familiaEstaAlocada(f.id);
    card.className = 'qa-family' + (alocada ? ' assigned' : '');
    card.draggable = true;
    card.innerHTML = `
      <span>${f.nome}</span>
      <small>${f.qtd} pessoa(s) • ${f.cidade || '—'}</small>
      <small class="muted">${alocada ? 'Já alocada' : 'Arraste para um quarto'}</small>
    `;
    card.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/familia', f.id);
    });
    lista.appendChild(card);
  });
}

function renderDetalhesIntegrados() {
  const container = document.getElementById('qaRoomDetails');
  if (!container) return;
  const quarto = DB.quartos.find(q => q.id === uiQuartos.quartoAtivo);
  if (!quarto || quarto.espacoId !== uiQuartos.espacoAtivo) {
    container.innerHTML = '<p class="muted">Selecione um quarto no mapa para ver detalhes.</p>';
    return;
  }
  const capacidade = capacidadeQuarto(quarto);
  const ocupacao = ocupacaoQuarto(quarto);
  const familias = (quarto.ocupantes || []).map(id => DB.familias.find(f => f.id === id)).filter(Boolean);
  container.innerHTML = `
    <div class="qa-stack">
      <div><strong>${quarto.nome}</strong> • ${descricaoTipoQuarto(quarto)}</div>
      <div class="qa-row"><span class="qa-chip">Capacidade ${capacidade}</span><span class="qa-chip">Ocupação ${ocupacao}</span></div>
      <div class="qa-stack">
        <strong>Famílias alocadas</strong>
        ${familias.length ? '<ul>' + familias.map(f => `<li class="qa-row" style="justify-content:space-between;">${f.nome} (${f.qtd}) <button class="qa-btn danger small" data-qa-remove-family="${f.id}">remover</button></li>`).join('') + '</ul>' : '<p class="muted">Nenhuma família neste quarto.</p>'}
        ${familias.length ? '<button class="qa-btn danger small" id="qaClearRoom">Remover todas</button>' : ''}
      </div>
    </div>
  `;

  container.querySelectorAll('[data-qa-remove-family]').forEach(btn => {
    btn.addEventListener('click', () => {
      const fid = Number(btn.dataset.qaRemoveFamily);
      quarto.ocupantes = (quarto.ocupantes || []).filter(id => id !== fid);
      atualizarLeitura(); atualizarEdicao(); salvar();
    });
  });
  const limpar = document.getElementById('qaClearRoom');
  if (limpar) limpar.addEventListener('click', () => { quarto.ocupantes = []; atualizarLeitura(); atualizarEdicao(); salvar(); });
}

function renderQuartosIntegrados() {
  const canvasPainel = document.getElementById('qaCanvasPanel');
  if (!canvasPainel) return;
  if (!uiQuartos.espacoAtivo && DB.espacos.length) uiQuartos.espacoAtivo = DB.espacos[0].id;
  renderEspacosIntegrados();
  renderCanvasIntegrado();
  renderFamiliasIntegradas();
  renderDetalhesIntegrados();
}

function seedQuartosIntegrados() {
  if (DB.espacos.length || DB.quartos.length) return;
  const esp1 = criarEspacoIntegrado('Monte das Oliveiras', '#dc2626');
  const esp2 = criarEspacoIntegrado('Alojamento Azul', '#2563eb');
  criarQuartoIntegrado(esp1, '32', 4, 'pequena');
  criarQuartoIntegrado(esp1, '33', 6, 'media');
  criarQuartoIntegrado(esp1, '34', 4, 'pequena');
  criarQuartoIntegrado(esp1, '35', 8, 'grande');
  criarQuartoIntegrado(esp2, '101', 4, 'pequena');
  criarQuartoIntegrado(esp2, '102', 2, 'casal');
}

function inicializarQuartosIntegrados() {
  const btnEspaco = document.getElementById('qaAddSpaceBtn');
  if (!btnEspaco) return;
  seedQuartosIntegrados();
  btnEspaco.addEventListener('click', () => {
    const nome = document.getElementById('qaSpaceName').value.trim();
    const cor = document.getElementById('qaSpaceColor').value;
    if (!nome) return alert('Dê um nome ao espaço.');
    criarEspacoIntegrado(nome, cor);
    document.getElementById('qaSpaceName').value = '';
    salvar();
    renderQuartosIntegrados();
  });

  document.querySelectorAll('[data-qa-preset]').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!uiQuartos.espacoAtivo) return alert('Crie e selecione um espaço.');
      const espaco = DB.espacos.find(e => e.id === uiQuartos.espacoAtivo);
      const nome = 'Q' + (quartosDoEspaco(espaco.id).length + 1);
      criarQuartoIntegrado(espaco.id, nome, 0, btn.dataset.qaPreset);
      salvar();
      renderQuartosIntegrados();
    });
  });

  const btnQuarto = document.getElementById('qaAddRoomBtn');
  if (btnQuarto) btnQuarto.addEventListener('click', () => {
    if (!uiQuartos.espacoAtivo) return alert('Selecione um espaço primeiro.');
    const nome = document.getElementById('qaRoomName').value.trim() || 'Quarto ' + (DB.quartos.length + 1);
    const capacidade = Number(document.getElementById('qaRoomCapacity').value || 1);
    criarQuartoIntegrado(uiQuartos.espacoAtivo, nome, capacidade, null);
    document.getElementById('qaRoomName').value = '';
    salvar();
    renderQuartosIntegrados();
  });

  const busca = document.getElementById('qaFamilySearch');
  if (busca) busca.addEventListener('input', () => renderFamiliasIntegradas());
  renderQuartosIntegrados();
}

function renderFamiliasDrag() {
  const lista = document.getElementById('listaFamiliasDrag');
  if (!lista) return;
  if (!DB.familias.length) {
    lista.innerHTML = '<small>Nenhuma família cadastrada. Use a aba Participantes para adicionar.</small>';
    return;
  }
  lista.innerHTML = DB.familias.map(f => `
    <div class="familia-chip" draggable="true" data-id="${f.id}">
      <span>${f.nome}</span>
      <small>${f.qtd}p</small>
    </div>
  `).join('');
  lista.querySelectorAll('.familia-chip').forEach(chip => {
    chip.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/familia', chip.dataset.id);
    });
  });
}

function criarShapeEspaco(espaco, idx) {
  const el = document.createElement('div');
  el.className = 'planta-shape shape-espaco';
  const cor = espaco.cor || coresEspaco[idx % coresEspaco.length];
  el.style.background = cor;
  el.style.borderColor = cor;
  el.style.left = `${espaco.x || 0}px`;
  el.style.top = `${espaco.y || 0}px`;
  el.style.width = `${espaco.width || 180}px`;
  el.style.height = `${espaco.height || 140}px`;
  el.innerHTML = `<h4>${espaco.nome || 'Espaço'}</h4><small>Área livre para acomodar vários quartos</small>`;
  registrarArrasto(el, (x, y) => { espaco.x = x; espaco.y = y; });
  return el;
}

function criarShapeQuarto(quarto, idx) {
  garantirLayout(quarto, idx);
  const el = document.createElement('div');
  const capacidade = capacidadeQuarto(quarto);
  const ocupacao = ocupacaoQuarto(quarto);
  const classe = vagasDisponiveis(quarto) > 0 ? 'disponivel' : 'cheio';
  const selecionado = quartoSelecionadoId === quarto.id ? 'selecionado' : '';
  el.className = `planta-shape shape-quarto ${classe} ${selecionado}`;
  el.style.left = `${quarto.layout.x}px`;
  el.style.top = `${quarto.layout.y}px`;
  el.style.width = `${quarto.layout.width}px`;
  el.style.height = `${quarto.layout.height}px`;
  const ocupantes = (quarto.ocupantes || []).map(id => {
    const familia = DB.familias.find(f => f.id === id);
    return familia ? `<span>${familia.nome} (${familia.qtd}p)</span>` : '';
  }).join('');
  el.innerHTML = `
    <h4>${quarto.nome}</h4>
    <small>${descricaoTipoQuarto(quarto)}</small>
    <div class="status">${ocupacao}/${capacidade} vagas usadas</div>
    <div class="ocupantes">${ocupantes || '<small>Arraste uma família para cá</small>'}</div>
  `;
  el.addEventListener('click', () => selecionarQuarto(quarto.id));
  el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('drop-target'); });
  el.addEventListener('dragleave', () => el.classList.remove('drop-target'));
  el.addEventListener('drop', e => {
    e.preventDefault();
    el.classList.remove('drop-target');
    const familiaId = Number(e.dataTransfer.getData('text/familia'));
    if (familiaId) vincularFamiliaAoQuarto(quarto.id, familiaId);
  });
  registrarArrasto(el, (x, y) => { quarto.layout.x = x; quarto.layout.y = y; });
  return el;
}

function prepararCanvasDesenho(canvas) {
  if (!canvas || canvas.dataset.desenho === '1') return;
  canvas.dataset.desenho = '1';
  const criarPreview = () => {
    previewDesenho = document.createElement('div');
    previewDesenho.className = 'planta-shape shape-espaco';
    previewDesenho.style.opacity = '0.45';
    previewDesenho.style.pointerEvents = 'none';
    canvas.appendChild(previewDesenho);
  };
  const limparPreview = () => {
    if (previewDesenho && previewDesenho.parentNode) previewDesenho.parentNode.removeChild(previewDesenho);
    previewDesenho = null;
  };
  const posCanvas = e => {
    const rect = canvas.getBoundingClientRect();
    return {
      x: (e.clientX - rect.left) / mapaZoom,
      y: (e.clientY - rect.top) / mapaZoom
    };
  };
  canvas.addEventListener('mousedown', e => {
    if (!modoDesenho || e.target.closest('.planta-shape')) return;
    inicioDesenho = posCanvas(e);
    criarPreview();
    previewDesenho.style.left = `${inicioDesenho.x}px`;
    previewDesenho.style.top = `${inicioDesenho.y}px`;
    previewDesenho.style.width = '0px';
    previewDesenho.style.height = '0px';
  });
  canvas.addEventListener('mousemove', e => {
    if (!inicioDesenho || !previewDesenho) return;
    const pos = posCanvas(e);
    const x = Math.min(pos.x, inicioDesenho.x);
    const y = Math.min(pos.y, inicioDesenho.y);
    const w = Math.abs(pos.x - inicioDesenho.x);
    const h = Math.abs(pos.y - inicioDesenho.y);
    previewDesenho.style.left = `${x}px`;
    previewDesenho.style.top = `${y}px`;
    previewDesenho.style.width = `${w}px`;
    previewDesenho.style.height = `${h}px`;
  });
  canvas.addEventListener('mouseup', e => {
    if (!inicioDesenho) return;
    const pos = posCanvas(e);
    const x = Math.min(pos.x, inicioDesenho.x);
    const y = Math.min(pos.y, inicioDesenho.y);
    const width = Math.abs(pos.x - inicioDesenho.x);
    const height = Math.abs(pos.y - inicioDesenho.y);
    inicioDesenho = null;
    limparPreview();
    if (width < 30 || height < 30 || !modoDesenho) return;
    if (modoDesenho === 'espaco') {
      DB.espacos.push({ id: Date.now(), nome: `Espaço ${DB.espacos.length + 1}`, x, y, width, height, cor: coresEspaco[DB.espacos.length % coresEspaco.length] });
    } else if (modoDesenho === 'quarto') {
      const novoId = Date.now();
      DB.quartos.push({ id: novoId, nome: `Quarto desenhado ${DB.quartos.length + 1}`, tiposCama: [{ tipo: 'Solteiro', quantidade: 2 }], ocupantes: [], layout: { x, y, width, height } });
      quartoSelecionadoId = novoId;
    }
    renderMapa();
    atualizarEdicao();
    salvar();
  });
}

function renderMapa() {
  const canvas = document.getElementById('mapa-alojamento');
  if (!canvas) return;
  renderFamiliasDrag();
  canvas.innerHTML = '';
  if (!DB.espacos.length && !DB.quartos.length) {
    const vazio = document.createElement('div');
    vazio.style.padding = '1rem';
    vazio.innerHTML = '<small>Desenhe um espaço ou um quarto para iniciar o mapa.</small>';
    canvas.appendChild(vazio);
  }
  (DB.espacos || []).forEach((e, idx) => canvas.appendChild(criarShapeEspaco(e, idx)));
  DB.quartos.forEach((q, idx) => canvas.appendChild(criarShapeQuarto(q, idx)));
  prepararCanvasDesenho(canvas);
  atualizarZoom(mapaZoom);
  renderPainelQuarto(DB.quartos.find(q => q.id === quartoSelecionadoId) || null);
}

function salvar() { /* Dados ficam apenas na sessão atual em formato JSON. */ }
function carregar() { /* Sem persistência em disco. */ }
carregar();

// =============================================
// NAVEGAÇÃO
// =============================================
document.querySelectorAll('.nav-link').forEach(l => {
  l.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('.nav-link').forEach(x => x.classList.remove('active'));
    l.classList.add('active');
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelector(l.getAttribute('href')).classList.add('active');
    atualizarContaUI();
    atualizarLeitura();
    atualizarEdicao();
  });
});

function inicializarSubtabs() {
  const tabs = Array.from(document.querySelectorAll('[data-subview]'));
  const subviews = Array.from(document.querySelectorAll('.subview'));
  if (!tabs.length || !subviews.length) return;
  const ativar = alvo => {
    subviews.forEach(view => view.classList.toggle('active', view.id === alvo));
    tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.subview === alvo));
  };
  tabs.forEach(tab => tab.addEventListener('click', () => {
    ativar(tab.dataset.subview);
    const area = document.getElementById('participantes');
    if (area) window.scrollTo({ top: area.offsetTop - 24, behavior: 'smooth' });
  }));
  ativar(tabs[0].dataset.subview);
}

function inicializarTabsProjetos() {
  const tabs = Array.from(document.querySelectorAll('[data-projeto-tab]'));
  const views = Array.from(document.querySelectorAll('.projeto-view'));
  if (!tabs.length || !views.length) return;
  const ativar = alvo => {
    views.forEach(v => v.classList.toggle('active', v.id === `tab-${alvo}`));
    tabs.forEach(t => t.classList.toggle('active', t.dataset.projetoTab === alvo));
  };
  tabs.forEach(tab => tab.addEventListener('click', () => ativar(tab.dataset.projetoTab)));
  ativar(tabs[0].dataset.projetoTab);

  const selectProjeto = document.getElementById('projetoSelect');
  if (selectProjeto) {
    selectProjeto.addEventListener('change', () => {
      projetoSelecionadoId = Number(selectProjeto.value);
      atualizarLeitura();
    });
  }
}

function inicializarTabelaParticipantes() {
  const busca = document.getElementById('participantesBusca');
  const filtro = document.getElementById('participantesFiltro');
  if (busca) busca.addEventListener('input', e => { tabelaParticipantesState.busca = e.target.value; renderTabelaParticipantes(); });
  if (filtro) filtro.addEventListener('change', e => { tabelaParticipantesState.filtro = e.target.value; renderTabelaParticipantes(); });
  document.querySelectorAll('#participantes-lista .sortable').forEach(th => th.addEventListener('click', () => {
    const campo = th.dataset.sort;
    if (tabelaParticipantesState.sortBy === campo) {
      tabelaParticipantesState.direction = tabelaParticipantesState.direction === 'asc' ? 'desc' : 'asc';
    } else {
      tabelaParticipantesState.sortBy = campo;
      tabelaParticipantesState.direction = 'asc';
    }
    renderTabelaParticipantes();
  }));
  renderTabelaParticipantes();
}

function inicializarToggleParticipantes() {
  const botoes = document.querySelectorAll('#participantesToggle [data-partview]');
  const cadastros = document.getElementById('participantes-cadastros');
  const lista = document.getElementById('participantes-lista');
  if (!botoes.length || !cadastros || !lista) return;
  botoes.forEach(btn => btn.addEventListener('click', () => {
    botoes.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const alvo = btn.dataset.partview;
    cadastros.classList.toggle('hidden', alvo !== 'cadastros');
    lista.classList.toggle('hidden', alvo !== 'lista');
    if (alvo === 'lista') renderTabelaParticipantes();
  }));
}

function inicializarOverlayParticipante() {
  const overlay = document.getElementById('participanteOverlay');
  if (!overlay) return;
  overlay.addEventListener('click', e => {
    if (e.target === overlay) fecharDetalheParticipante();
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') fecharDetalheParticipante();
  });
}

function atualizarZoom(valor) {
  mapaZoom = Math.min(1.5, Math.max(0.5, valor));
  const container = document.getElementById('mapa-alojamento');
  const label = document.getElementById('mapaZoomLabel');
  const range = document.getElementById('mapaZoomRange');
  if (container) container.style.transform = `scale(${mapaZoom})`;
  if (label) label.textContent = `${Math.round(mapaZoom * 100)}%`;
  if (range) range.value = Math.round(mapaZoom * 100);
}

// =============================================
// CONTA E LOGS
// =============================================
let usuarioEditando = null;
let modoConta = 'cadastro';

function registrarLog(acao, detalhe) {
  const entrada = {
    id: Date.now(),
    usuario: DB.sessao ? DB.sessao.usuario : 'anônimo',
    acao,
    detalhe,
    data: new Date().toISOString()
  };
  DB.logs.unshift(entrada);
  renderLogs();
}

function renderLogs() {
  const alvo = document.getElementById('logAlteracoes');
  if (!alvo) return;
  if (!DB.logs.length) {
    alvo.innerHTML = '<p>Nenhuma ação registrada nesta sessão.</p>';
    return;
  }
  alvo.innerHTML = DB.logs.map(log => `<pre>${JSON.stringify(log, null, 2)}</pre>`).join('');
}

function renderUsuarios() {
  const alvo = document.getElementById('usuariosLista');
  if (!alvo) return;
  if (!DB.usuarios.length) {
    alvo.innerHTML = '<p>Nenhum usuário cadastrado.</p>';
    return;
  }
  const linhas = DB.usuarios.map(u => [
    u.nome,
    u.email,
    u.usuario,
    `<button class="btn-editar btn-small" onclick="editarUsuario(${u.id})">Editar</button> <button class="btn-no btn-small" onclick="excluirUsuario(${u.id})">Excluir</button>`
  ]);
  const headers = ['Nome', 'E-mail', 'Usuário', 'Ações'];
  const corpo = linhas.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
  alvo.innerHTML = `<table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${corpo}</tbody></table>`;
}

function atualizarSessaoVisual() {
  const sessao = document.getElementById('sessaoUsuario');
  const perfil = document.getElementById('perfilSelecionado');
  const btnLogout = document.getElementById('btnLogout');
  const acoesSessao = document.getElementById('acoesSessao');
  if (DB.sessao) {
    sessao.textContent = `Logado como ${DB.sessao.nome}`;
    perfil.innerHTML = `<p><strong>E-mail:</strong> ${DB.sessao.email}<br><strong>Usuário:</strong> ${DB.sessao.usuario}</p>`;
    btnLogout.classList.remove('hidden');
    acoesSessao.innerHTML = `
      <button class="btn-editar btn-small" type="button" onclick="editarMinhaConta()">Editar meus dados</button>
      <button class="btn-secondary btn-small" type="button" onclick="executarLogout()">Sair</button>
      <button class="btn-no btn-small" type="button" onclick="excluirMinhaConta()">Excluir conta</button>
    `;
  } else {
    sessao.textContent = 'Nenhum usuário autenticado';
    perfil.textContent = '';
    btnLogout.classList.add('hidden');
    acoesSessao.innerHTML = '';
  }
}

function atualizarContaUI() {
  atualizarSessaoVisual();
  renderUsuarios();
  renderLogs();
  const autenticado = Boolean(DB.sessao);
  const descricao = document.getElementById('contaDescricao');
  const blocos = {
    cadastro: document.getElementById('blocoCadastro'),
    login: document.getElementById('blocoLogin'),
    sessao: document.getElementById('blocoSessao'),
    acoes: document.getElementById('acoesConta'),
    usuarios: document.getElementById('usuariosCard'),
    log: document.getElementById('logCard'),
  };
  if (autenticado) {
    blocos.acoes.classList.add('hidden');
    blocos.cadastro.classList.add('hidden');
    blocos.login.classList.add('hidden');
    blocos.sessao.classList.remove('hidden');
    descricao.textContent = 'Sessão autenticada. Edite ou exclua sua conta e continue navegando pelos módulos.';
    blocos.usuarios.classList.remove('hidden');
    blocos.log.classList.remove('hidden');
  } else {
    blocos.sessao.classList.add('hidden');
    blocos.acoes.classList.remove('hidden');
    blocos.usuarios.classList.add('hidden');
    blocos.log.classList.add('hidden');
    const modoAtual = DB.usuarios.length ? modoConta : 'cadastro';
    modoConta = modoAtual;
    descricao.textContent = modoAtual === 'cadastro'
      ? 'Crie sua conta para começar. Os dados ficam somente nesta sessão.'
      : 'Acesse com seu usuário para editar os módulos.';
    blocos.cadastro.classList.toggle('hidden', modoAtual !== 'cadastro');
    blocos.login.classList.toggle('hidden', modoAtual !== 'login');
  }
}

window.editarUsuario = id => {
  const usuario = DB.usuarios.find(u => u.id === id);
  if (!usuario) return;
  usuarioEditando = usuario.id;
  const form = document.getElementById('formCadastro');
  form[0].value = usuario.nome;
  form[1].value = usuario.email;
  form[2].value = usuario.usuario;
  form[3].value = usuario.senha;
  form.querySelector('button[type="submit"]').textContent = 'Atualizar dados';
};

window.editarMinhaConta = () => {
  if (!DB.sessao) return;
  modoConta = 'cadastro';
  atualizarContaUI();
  editarUsuario(DB.sessao.id);
};

window.excluirMinhaConta = () => {
  if (!DB.sessao) return;
  excluirUsuario(DB.sessao.id);
};

window.excluirUsuario = id => {
  const usuario = DB.usuarios.find(u => u.id === id);
  DB.usuarios = DB.usuarios.filter(u => u.id !== id);
  if (DB.sessao && DB.sessao.id === id) {
    DB.sessao = null;
  }
  registrarLog('excluir_usuario', { usuario: usuario ? usuario.usuario : id });
  usuarioEditando = null;
  atualizarContaUI();
};

document.getElementById('formCadastro').onsubmit = e => {
  e.preventDefault();
  const [nome, email, usuario, senha] = [e.target[0].value, e.target[1].value, e.target[2].value, e.target[3].value];
  if (usuarioEditando) {
    const atual = DB.usuarios.find(u => u.id === usuarioEditando);
    if (atual) {
      atual.nome = nome; atual.email = email; atual.usuario = usuario; atual.senha = senha;
      registrarLog('editar_usuario', { usuario });
    }
  } else {
    DB.usuarios.push({ id: Date.now(), nome, email, usuario, senha });
    registrarLog('criar_usuario', { usuario });
  }
  usuarioEditando = null;
  e.target.reset();
  e.target.querySelector('button[type="submit"]').textContent = 'Registrar';
  atualizarContaUI();
};

document.getElementById('formLogin').onsubmit = e => {
  e.preventDefault();
  const [usuario, senha] = [e.target[0].value, e.target[1].value];
  const encontrado = DB.usuarios.find(u => u.usuario === usuario && u.senha === senha);
  if (!encontrado) return alert('Usuário ou senha inválidos.');
  DB.sessao = { id: encontrado.id, nome: encontrado.nome, email: encontrado.email, usuario: encontrado.usuario };
  registrarLog('login', { usuario });
  atualizarContaUI();
};

function salvarTarefaRapida(e) {
  e.preventDefault();
  const fd = new FormData(e.target);
  const projetoId = Number(fd.get('projeto') || fd.get('modalProjeto')) || Number(document.getElementById('modalProjeto')?.value);
  if (!projetoId) return alert('Escolha um projeto.');
  const nova = {
    id: Date.now(),
    projetoId,
    titulo: fd.get('titulo'),
    responsavel: fd.get('responsavel') || fd.get('modalResponsavel'),
    prazo: fd.get('prazo'),
    prioridade: fd.get('prioridade'),
    etiqueta: fd.get('etiqueta') || 'Demanda',
    status: fd.get('status') || fd.get('novoStatus') || 'backlog',
    criadaPor: DB.sessao ? DB.sessao.nome : 'Usuário'
  };
  DB.tarefas.unshift(nova);
  DB.notificacoesProjetos.push({ id: Date.now(), projetoId, mensagem: `Nova tarefa: ${nova.titulo}`, severidade: 'ok' });
  registrarLog('criar_tarefa', { projetoId, titulo: nova.titulo });
  fecharOverlay('tarefaOverlay');
  e.target.reset();
  renderPainelProjetos(); atualizarLeitura(); salvar();
}

function responderTarefa(e, id) {
  e.preventDefault();
  const tarefa = DB.tarefas.find(t => t.id === id);
  if (!tarefa) return;
  const fd = new FormData(e.target);
  const comentario = fd.get('comentario');
  const evidencia = fd.get('evidencia');
  const novoStatus = fd.get('novoStatus');
  const novoResp = fd.get('novoResponsavel');
  const souResponsavel = DB.sessao && tarefa.responsavel && tarefa.responsavel.toLowerCase().includes(DB.sessao.nome.toLowerCase());
  if (souResponsavel) {
    tarefa.status = novoStatus;
    tarefa.responsavel = novoResp;
  }
  DB.respostasTarefas.unshift({ id: Date.now(), tarefaId: id, comentario, evidencia, usuario: DB.sessao ? DB.sessao.nome : 'Usuário', data: new Date().toISOString() });
  if (evidencia) {
    DB.anexos.push({ id: Date.now(), projetoId: tarefa.projetoId, tarefaId: tarefa.id, nome: evidencia, tipo: 'Evidência', tamanho: '', data: new Date().toLocaleDateString('pt-BR'), dono: DB.sessao ? DB.sessao.nome : 'Usuário' });
  }
  registrarLog('responder_tarefa', { tarefa: tarefa.titulo });
  renderPainelProjetos();
  abrirDetalheTarefa(id);
  salvar();
}

function salvarAnexoModal(e) {
  e.preventDefault();
  const fd = new FormData(e.target);
  const projetoId = Number(fd.get('modalProjetoAnexo')) || projetoSelecionadoId;
  DB.anexos.push({
    id: Date.now(),
    projetoId,
    tarefaId: fd.get('modalTarefaAnexo') ? Number(fd.get('modalTarefaAnexo')) : undefined,
    nome: fd.get('descricao'),
    tipo: fd.get('tipo'),
    tamanho: fd.get('tamanho'),
    data: new Date().toLocaleDateString('pt-BR'),
    dono: DB.sessao ? DB.sessao.nome : 'Usuário'
  });
  registrarLog('anexar_projeto', { projetoId, nome: fd.get('descricao') });
  fecharOverlay('anexoOverlay');
  e.target.reset();
  renderPainelProjetos(); salvar();
}

function salvarCustoModal(e) {
  e.preventDefault();
  const fd = new FormData(e.target);
  const projetoId = Number(fd.get('modalProjetoCusto')) || projetoSelecionadoId;
  DB.custosProjetos.push({
    id: Date.now(),
    projetoId,
    categoria: fd.get('categoria'),
    previsto: Number(fd.get('valor')),
    realizado: Number(fd.get('valor')),
    tarefaId: fd.get('modalTarefaCusto') ? Number(fd.get('modalTarefaCusto')) : undefined,
    justificativa: fd.get('justificativa')
  });
  registrarLog('registrar_custo', { projetoId, categoria: fd.get('categoria') });
  fecharOverlay('custoOverlay');
  e.target.reset();
  renderPainelProjetos(); salvar();
}

function executarLogout() {
  if (!DB.sessao) return;
  registrarLog('logout', { usuario: DB.sessao.usuario });
  DB.sessao = null;
  atualizarContaUI();
}

document.getElementById('btnLogout').onclick = executarLogout;

document.querySelectorAll('[data-modo-conta]').forEach(botao => {
  botao.addEventListener('click', () => {
    modoConta = botao.dataset.modoConta;
    atualizarContaUI();
  });
});

// =============================================
// ATUALIZAR TELAS
// =============================================
function formatarDataHora(valor) {
  return new Date(valor).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
}

function calcularTotalParticipantes() {
  const totalMissionarios = DB.missionarios.reduce((s, f) => s + (f.totalPessoas || f.qtd || 0), 0);
  const totalEquipe = DB.equipePessoas.length;
  const totalPreletores = DB.preletores.length;
  const totalConvidados = DB.convidados.length;
  const totalPastores = DB.pastores.reduce((s, p) => s + 1 + (p.conjuge ? 1 : 0), 0);
  return totalMissionarios + totalEquipe + totalPreletores + totalConvidados + totalPastores;
}

function atualizarLeitura() {
  const total = calcularTotalParticipantes();

  document.getElementById('paxTotal').textContent = total;
  const totalBadge = document.getElementById('participantesTotalizador');
  if (totalBadge) totalBadge.textContent = `${total} pessoas`;
  document.getElementById('onibusTotal').textContent = DB.onibus.length;
  document.getElementById('voosTotal').textContent = DB.voos.length;
  const quartosOcupados = DB.quartos.filter(q => ocupacaoQuarto(q) > 0).length;
  const capacidadeTotal = DB.quartos.reduce((s, q) => s + capacidadeQuarto(q), 0);
  const vagasUsadas = DB.quartos.reduce((s, q) => s + ocupacaoQuarto(q), 0);
  document.getElementById('quartosInfo').innerHTML = `${quartosOcupados} / ${DB.quartos.length} quartos • ${vagasUsadas}/${capacidadeTotal} vagas`;
  document.getElementById('orcado').textContent = DB.financeiro.orcado.toFixed(2).replace('.', ',');
  document.getElementById('realizado').textContent = DB.financeiro.realizado.toFixed(2).replace('.', ',');

  const buildTable = (titulo, headers, rows, vazio) => {
    const corpo = rows.length
      ? rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')
      : `<tr><td colspan="${headers.length}">${vazio}</td></tr>`;
    return `
      <div class="table-group">
        <h3>${titulo}</h3>
        <table>
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
          <tbody>${corpo}</tbody>
        </table>
      </div>`;
  };

  renderPainelProjetos();

  document.getElementById('leitura-transporte').innerHTML = [
    buildTable(`Ônibus (${DB.onibus.length})`, ['Origem', 'Passageiros', 'Empresa', 'Data/Hora'],
      DB.onibus.map(o => [o.cidade, `${o.qtd}`, o.empresa, formatarDataHora(o.data)]),
      'Nenhum ônibus cadastrado.'),
    buildTable(`Voos (${DB.voos.length})`, ['Passageiro', 'Voo', 'Data/Hora'],
      DB.voos.map(v => [v.passageiro, v.voo, formatarDataHora(v.data)]),
      'Nenhum voo cadastrado.')
  ].join('');

    renderQuartosIntegrados();

    document.getElementById('leitura-alojamento').innerHTML = buildTable('Quartos e ocupação', ['Quarto', 'Capacidade total', 'Tipo de cama', 'Ocupação'],
    DB.quartos.map(q => {
      const ocupantes = (q.ocupantes || []).map(id => {
        const familia = DB.familias.find(f => f.id === id);
        return familia ? `${familia.nome} (${familia.qtd}p)` : 'Participante removido';
      }).join('<br>') || 'Sem participantes vinculados.';
      return [q.nome, `${capacidadeQuarto(q)} vagas`, descricaoTipoQuarto(q), `${ocupacaoQuarto(q)}/${capacidadeQuarto(q)} pessoas<br><small>${ocupantes}</small>`];
    }),
    'Nenhum quarto cadastrado.');

  const eventos = [...DB.cronograma].sort((a, b) => new Date(a.data) - new Date(b.data));
  document.getElementById('cronograma-lista').innerHTML = buildTable('Cronograma', ['Data', 'Atividade', 'Responsável'],
    eventos.map(e => [formatarDataHora(e.data), e.titulo, e.responsavel]),
    'Cronograma vazio.');

  document.getElementById('cardapio-leitura').innerHTML = buildTable('Refeições planejadas', ['Data', 'Tipo', 'Cardápio'],
    DB.refeicoes.map(r => [r.data, r.tipo, `${r.descricao}<br><small>Lista automática: frutas, proteínas, bebidas</small>`]),
    'Nenhuma refeição planejada.');

  document.getElementById('compras-leitura').innerHTML = [
    buildTable('Solicitações', ['Item', 'Quantidade', 'Centro de custo'],
      DB.solicitacoes.map(s => [s.item, s.qtd, s.centro]),
      'Sem solicitações.'),
    buildTable('Aprovações', ['Item', 'Qtd', 'Valor aprovado'],
      DB.aprovacoes.map(a => [a.item, a.qtd, `R$ ${a.valor.toFixed(2)}`]),
      'Sem aprovações.'),
    buildTable('Pedidos', ['Item', 'Fornecedor'],
      DB.pedidos.map(p => [p.item, p.fornecedor]),
      'Sem pedidos registrados.')
  ].join('');

  document.getElementById('palestras-leitura').innerHTML = buildTable('Palestras', ['Data/Hora', 'Tema', 'Palestrante'],
    DB.palestras.map(p => [formatarDataHora(p.data), p.tema, p.palestrante]),
    'Nenhuma palestra cadastrada.');

  document.getElementById('kids-leitura').innerHTML = buildTable('Programação Kids', ['Data/Hora', 'Atividade', 'Responsável'],
    DB.kids.map(k => [formatarDataHora(k.data), k.atividade, k.responsavel]),
    'Sem atividades kids.');

  const fluxoPagamentos = DB.aprovacoes.reduce((s, a) => s + a.valor, 0);
  const centros = DB.financeiro.centros;
  document.getElementById('financeiro-leitura').innerHTML = `
    <div class="card">
      <strong>Orçado:</strong> R$ ${DB.financeiro.orcado.toFixed(2)}<br>
      <strong>Realizado:</strong> R$ ${DB.financeiro.realizado.toFixed(2)}<br>
      <small>Pagamentos lançados pelos módulos somam R$ ${fluxoPagamentos.toFixed(2)}.</small>
    </div>
    ${buildTable('Centros de Custo', ['Centro', 'Orçado', 'Realizado'],
      centros.map(c => [c.nome, `R$ ${c.orcado.toFixed(2)}`, `R$ ${c.realizado.toFixed(2)}`]),
      'Nenhum centro cadastrado.')}
    <p class="nota-dependencia">A maioria das informações é derivada dos cadastros de participantes. O financeiro consolida pagamentos informados pelos módulos de compras, logística e alimentação.</p>
  `;

  renderTabelaParticipantes();
}

function setSelectOptions(selectId, items, labelFn) {
  const select = document.getElementById(selectId);
  if (!select) return;
  select.innerHTML = '<option value="" disabled selected>Selecione</option>' + items.map(i => `<option value="${i.id}">${labelFn(i)}</option>`).join('');
}

function pessoasDisponiveis() {
  const nomes = new Set();
  DB.equipes.forEach(eq => {
    if (eq.responsavel) nomes.add(eq.responsavel);
    (eq.membros || '').split(',').map(m => m.trim()).filter(Boolean).forEach(m => nomes.add(m));
  });
  DB.equipePessoas.forEach(p => nomes.add(p.nome));
  DB.usuarios.forEach(u => nomes.add(u.nome));
  return Array.from(nomes).map(nome => ({ id: nome, nome }));
}

function fecharOverlay(id) {
  const el = document.getElementById(id);
  if (el) el.classList.add('hidden');
}

function abrirTarefaModal(modo = 'membro') {
  setSelectOptions('modalProjeto', DB.projetos, p => p.nome);
  setSelectOptions('modalResponsavel', pessoasDisponiveis(), p => p.nome);
  const projetoAtual = obterProjetoAtual();
  const modal = document.getElementById('tarefaOverlay');
  const selectProjeto = document.getElementById('modalProjeto');
  const selectResp = document.getElementById('modalResponsavel');
  if (selectProjeto && projetoAtual) selectProjeto.value = String(projetoAtual.id);
  if (modo === 'self' && DB.sessao && selectResp) {
    const opcao = [...selectResp.options].find(o => o.textContent === DB.sessao.nome);
    if (opcao) selectResp.value = opcao.value;
  }
  if (modal) modal.classList.remove('hidden');
}

function abrirAnexoModal() {
  setSelectOptions('modalProjetoAnexo', DB.projetos, p => p.nome);
  const projetoAtual = obterProjetoAtual();
  const selectProjeto = document.getElementById('modalProjetoAnexo');
  if (selectProjeto && projetoAtual) selectProjeto.value = String(projetoAtual.id);
  preencherTarefasPorProjeto('modalTarefaAnexo', projetoAtual ? projetoAtual.id : null);
  const modal = document.getElementById('anexoOverlay');
  if (modal) modal.classList.remove('hidden');
}

function abrirCustoModal() {
  setSelectOptions('modalProjetoCusto', DB.projetos, p => p.nome);
  const projetoAtual = obterProjetoAtual();
  const selectProjeto = document.getElementById('modalProjetoCusto');
  if (selectProjeto && projetoAtual) selectProjeto.value = String(projetoAtual.id);
  preencherTarefasPorProjeto('modalTarefaCusto', projetoAtual ? projetoAtual.id : null);
  const modal = document.getElementById('custoOverlay');
  if (modal) modal.classList.remove('hidden');
}

function preencherTarefasPorProjeto(selectId, projetoId = null) {
  const select = document.getElementById(selectId);
  if (!select) return;
  const projetoEscolhido = projetoId
    || Number(document.getElementById('modalProjetoAnexo')?.value)
    || Number(document.getElementById('modalProjetoCusto')?.value)
    || (obterProjetoAtual()?.id);
  const tarefas = projetoEscolhido ? DB.tarefas.filter(t => t.projetoId === projetoEscolhido) : [];
  select.innerHTML = '<option value="">Sem vínculo</option>' + tarefas.map(t => `<option value="${t.id}">${t.titulo}</option>`).join('');
}

function obterProjetoAtual() {
  if (!DB.projetos.length) return null;
  if (!projetoSelecionadoId || !DB.projetos.some(p => p.id === projetoSelecionadoId)) {
    projetoSelecionadoId = DB.projetos[0].id;
  }
  return DB.projetos.find(p => p.id === projetoSelecionadoId) || null;
}

function indicadorStatus(status) {
  if (status === 'concluido') return { label: 'Concluído', classe: 'status-concluido' };
  if (status === 'andamento') return { label: 'Em andamento', classe: 'status-andamento' };
  if (status === 'pendente') return { label: 'Pendente', classe: '' };
  return { label: status || 'Sem status', classe: '' };
}

function calcularIndicadoresProjeto(projeto) {
  const tarefas = DB.tarefas.filter(t => t.projetoId === projeto.id);
  const concluidas = tarefas.filter(t => t.status === 'pronto').length;
  const progresso = tarefas.length ? Math.round((concluidas / tarefas.length) * 100) : 0;
  const pendentes = tarefas.filter(t => t.status !== 'pronto').length;
  const proximas = tarefas
    .filter(t => t.prazo)
    .sort((a, b) => new Date(a.prazo) - new Date(b.prazo))
    .slice(0, 2);
  const custos = DB.custosProjetos.filter(c => c.projetoId === projeto.id);
  const orcado = custos.reduce((s, c) => s + c.previsto, 0);
  const realizado = custos.reduce((s, c) => s + c.realizado, 0);
  return { tarefas, concluidas, progresso, pendentes, proximas, orcado, realizado };
}

function renderPainelProjetos() {
  const headerTitulo = document.getElementById('projetoTitulo');
  const statusBadge = document.getElementById('projetoStatusBadge');
  const prazoBadge = document.getElementById('projetoPrazoBadge');
  const equipeBadge = document.getElementById('projetoEquipeBadge');
  const kpiArea = document.getElementById('projetoIndicadores');
  const resumoArea = document.getElementById('resumoGeral');
  const kanbanBoard = document.getElementById('kanbanBoard');
  const painelEquipe = document.getElementById('painelEquipe');
  const painelArquivos = document.getElementById('painelArquivos');
  const painelFinanceiro = document.getElementById('painelFinanceiro');
  const painelCronograma = document.getElementById('painelCronograma');
  const selectProjeto = document.getElementById('projetoSelect');
  if (!headerTitulo || !kpiArea) return;

  setSelectOptions('projetoSelect', DB.projetos, p => p.nome);
  const projeto = obterProjetoAtual();

  if (!projeto) {
    headerTitulo.textContent = 'Cadastre um projeto para começar';
    kpiArea.innerHTML = '<div class="card">Nenhum projeto disponível.</div>';
    [resumoArea, kanbanBoard, painelEquipe, painelArquivos, painelFinanceiro, painelCronograma].forEach(el => { if (el) el.innerHTML = ''; });
    return;
  }

  if (selectProjeto) selectProjeto.value = String(projeto.id);
  const equipe = DB.equipes.find(e => e.id === projeto.equipeId);
  const statusInfo = indicadorStatus(projeto.status);
  headerTitulo.textContent = projeto.nome;
  if (statusBadge) {
    statusBadge.textContent = statusInfo.label;
    statusBadge.className = `status-badge ${statusInfo.classe}`.trim();
  }
  if (prazoBadge) prazoBadge.textContent = projeto.prazo ? `Prazo: ${new Date(projeto.prazo).toLocaleDateString('pt-BR')}` : 'Prazo não definido';
  if (equipeBadge) equipeBadge.textContent = equipe ? `Equipe: ${equipe.nome}` : 'Equipe não atribuída';

  const { tarefas, progresso, pendentes, proximas, orcado, realizado } = calcularIndicadoresProjeto(projeto);
  const entregasTexto = proximas.length ? proximas.map(t => `${t.titulo} • ${new Date(t.prazo).toLocaleDateString('pt-BR')}`).join('<br>') : 'Sem entregas próximas.';
  const saldo = orcado - realizado;

  kpiArea.innerHTML = `
    <div class="kpi-card"><small>Tarefas pendentes</small><strong>${pendentes}</strong><div class="kpi-trend risk">⚠️ Priorize entregas críticas</div></div>
    <div class="kpi-card"><small>Próximas entregas</small><strong>${proximas.length}</strong><div class="kpi-trend ok">${entregasTexto}</div></div>
    <div class="kpi-card"><small>Orçamento usado</small><strong>R$ ${realizado.toLocaleString('pt-BR')}</strong><div class="kpi-trend ${saldo < 0 ? 'risk' : 'ok'}">${saldo < 0 ? 'Estouro previsto' : 'Dentro do limite'}</div></div>
    <div class="kpi-card"><small>Progresso geral</small><strong>${progresso}%</strong><div class="kpi-trend ok">${progresso >= 70 ? 'Ritmo saudável' : 'Monitorar próximos marcos'}</div></div>`;

  if (resumoArea) {
    const notificacoes = DB.notificacoesProjetos.filter(n => n.projetoId === projeto.id);
    resumoArea.innerHTML = `
      <div class="card">
        <h3>Resumo executivo</h3>
        <p class="caption">Status, próximos passos e riscos rápidos.</p>
        <div class="stacked">
          <div><strong>Progresso:</strong> ${progresso}% concluído com ${tarefas.length} tarefas.</div>
          <div><strong>Próximas entregas:</strong><br>${entregasTexto}</div>
          <div><strong>Equipe responsável:</strong> ${equipe ? `${equipe.responsavel} (${equipe.nome})` : 'Não atribuída'}.</div>
        </div>
      </div>
      <div class="card">
        <h3>Alertas e notificações</h3>
        <div class="alertas-lista">
          ${notificacoes.length ? notificacoes.map(n => `<div class="alerta">${n.severidade === 'ok' ? '✅' : '⚠️'} ${n.mensagem}</div>`).join('') : '<p class="caption">Sem alertas no momento.</p>'}
        </div>
      </div>
      <div class="card card-full">
        <h3>Checklist rápido</h3>
        <p class="caption">Use esta lista para confirmar se os pilares do projeto estão caminhando.</p>
        <div class="field-row">
          <div class="pill">Cronograma validado</div>
          <div class="pill">Orçamento alinhado</div>
          <div class="pill">Equipe com responsáveis</div>
          <div class="pill">Arquivos-chave anexados</div>
        </div>
      </div>`;
  }

  if (kanbanBoard) {
    const colunas = [
      { chave: 'backlog', titulo: 'A fazer' },
      { chave: 'fazendo', titulo: 'Em progresso' },
      { chave: 'pronto', titulo: 'Concluído' }
    ];
    kanbanBoard.innerHTML = colunas.map(col => {
      const itens = tarefas.filter(t => t.status === col.chave);
      const cards = itens.length ? itens.map(t => `
        <div class="kanban-item">
          <strong>${t.titulo}</strong>
          <div class="kanban-tags">
            <span class="tag prioridade-${t.prioridade || 'media'}">${(t.prioridade || 'media').toUpperCase()}</span>
            ${t.etiqueta ? `<span class="tag">${t.etiqueta}</span>` : ''}
          </div>
          <small>Responsável: ${t.responsavel || 'Definir'} · Prazo: ${t.prazo ? new Date(t.prazo).toLocaleDateString('pt-BR') : '—'}</small>
          <div class="detalhe-acoes">
            <button class="btn-secondary btn-small" type="button" onclick="abrirDetalheTarefa(${t.id})">Abrir detalhes</button>
          </div>
        </div>`).join('') : '<p class="caption">Nada aqui ainda.</p>';
      return `<div class="kanban-col"><h4>${col.titulo} <span class="pill">${itens.length}</span></h4>${cards}</div>`;
    }).join('');
  }

  if (painelEquipe) {
    const equipeMembros = (equipe?.membros || '').split(',').map(s => s.trim()).filter(Boolean);
    painelEquipe.innerHTML = `
      <div class="card">
        <h3>Responsável</h3>
        <p class="caption">${equipe ? equipe.responsavel : 'Definir'}</p>
      </div>
      <div class="card card-full">
        <h3>Distribuição de tarefas</h3>
        <div class="field-row">
          ${equipeMembros.length ? equipeMembros.map(m => {
            const carga = tarefas.filter(t => (t.responsavel || '').toLowerCase().includes(m.toLowerCase())).length;
            return `<div class="pill">${m} • ${carga} tarefa(s)</div>`;
          }).join('') : '<p class="caption">Adicione membros para acompanhar a carga.</p>'}
        </div>
      </div>`;
  }

  if (painelArquivos) {
    const anexos = DB.anexos.filter(a => a.projetoId === projeto.id);
    painelArquivos.innerHTML = anexos.length ? anexos.map(a => `
      <div class="arquivo-card">
        <div>
          <strong>${a.nome}</strong><br>
          <span class="arquivo-meta">${a.tipo} • ${a.tamanho || '—'} • ${a.data || ''}${a.tarefaId ? ` • Tarefa ${a.tarefaId}` : ''}</span>
        </div>
        <span class="pill">${a.dono}</span>
      </div>`).join('') : '<div class="card">Nenhum arquivo anexado.</div>';
  }

  if (painelFinanceiro) {
    const centros = DB.custosProjetos.filter(c => c.projetoId === projeto.id);
    painelFinanceiro.innerHTML = `
      <div class="financeiro-grid">
        <div class="card"><h3>Orçado</h3><strong>R$ ${orcado.toLocaleString('pt-BR')}</strong><p class="caption">Planejado por categorias.</p></div>
        <div class="card"><h3>Realizado</h3><strong>R$ ${realizado.toLocaleString('pt-BR')}</strong><p class="caption">Atualize sempre que um custo for confirmado.</p></div>
        <div class="card"><h3>Saldo</h3><strong>R$ ${(orcado - realizado).toLocaleString('pt-BR')}</strong><p class="caption">Controle para evitar estouros.</p></div>
      </div>
      <div class="card card-full">
        <h3>Centros de custo</h3>
        <div class="field-row">
          ${centros.length ? centros.map(c => `<div class="pill">${c.categoria}: R$ ${c.realizado.toLocaleString('pt-BR')} / R$ ${c.previsto.toLocaleString('pt-BR')}</div>`).join('') : '<p class="caption">Nenhum centro cadastrado.</p>'}
        </div>
      </div>`;
  }

  if (painelCronograma) {
    const marcos = DB.marcos.filter(m => m.projetoId === projeto.id).sort((a, b) => new Date(a.data) - new Date(b.data));
    painelCronograma.innerHTML = marcos.length ? `<div class="timeline">${marcos.map(m => `
      <div class="timeline-item">
        <div>
          <strong>${m.titulo}</strong><br>
          <small>${new Date(m.data).toLocaleDateString('pt-BR')} · ${m.tipo || 'Marco'}</small>
        </div>
        <span class="pill">Resp.: ${m.responsavel || 'Definir'}</span>
      </div>`).join('')}</div>` : '<div class="card">Nenhum marco cadastrado.</div>';
  }
}

function abrirDetalheTarefa(id) {
  const tarefa = DB.tarefas.find(t => t.id === id);
  if (!tarefa) return;
  const projeto = DB.projetos.find(p => p.id === tarefa.projetoId);
  const anexos = DB.anexos.filter(a => a.tarefaId === id);
  const respostas = DB.respostasTarefas.filter(r => r.tarefaId === id);
  const souResponsavel = DB.sessao && tarefa.responsavel && tarefa.responsavel.toLowerCase().includes(DB.sessao.nome.toLowerCase());
  const alvo = document.getElementById('detalheTarefaConteudo');
  const overlay = document.getElementById('detalheTarefaOverlay');
  const responsaveis = pessoasDisponiveis();
  const opcoesResponsavel = responsaveis.map(r => `<option value="${r.nome}" ${tarefa.responsavel === r.nome ? 'selected' : ''}>${r.nome}</option>`).join('');
  if (!alvo || !overlay) return;
  alvo.innerHTML = `
    <div class="detalhe-card">
      <button class="detalhe-fechar" onclick="fecharOverlay('detalheTarefaOverlay')">✕</button>
      <h3>${tarefa.titulo}</h3>
      <div class="detalhe-grid">
        <div class="detalhe-campo"><strong>Projeto</strong><span>${projeto ? projeto.nome : '—'}</span></div>
        <div class="detalhe-campo"><strong>Responsável</strong><span>${tarefa.responsavel || 'Definir'}</span></div>
        <div class="detalhe-campo"><strong>Prazo</strong><span>${tarefa.prazo ? new Date(tarefa.prazo).toLocaleDateString('pt-BR') : '—'}</span></div>
        <div class="detalhe-campo"><strong>Prioridade</strong><span>${tarefa.prioridade || 'média'}</span></div>
        <div class="detalhe-campo"><strong>Status</strong><span>${tarefa.status}</span></div>
      </div>
      <div class="stacked">
        <strong>Últimas interações</strong>
        ${respostas.length ? respostas.map(r => `<div class="nota-dependencia">${new Date(r.data).toLocaleString('pt-BR')} • ${r.usuario}: ${r.comentario || 'Sem comentário'} ${r.evidencia ? `<br><small>Anexo: ${r.evidencia}</small>` : ''}</div>`).join('') : '<p class="caption">Ninguém respondeu ainda.</p>'}
      </div>
      <div class="stacked">
        <strong>Anexos vinculados</strong>
        ${anexos.length ? anexos.map(a => `<div class="arquivo-card"><div><strong>${a.nome}</strong><br><span class="arquivo-meta">${a.tipo} • ${a.tamanho || '—'} • ${a.data || ''}</span></div><span class="pill">${a.dono}</span></div>`).join('') : '<p class="caption">Nenhuma evidência enviada.</p>'}
      </div>
      <form onsubmit="responderTarefa(event, ${id})" class="stacked">
        <div class="field-row">
          <label>Novo status
            <select name="novoStatus" ${souResponsavel ? '' : 'disabled'}>
              <option value="backlog" ${tarefa.status === 'backlog' ? 'selected' : ''}>A fazer</option>
              <option value="fazendo" ${tarefa.status === 'fazendo' ? 'selected' : ''}>Em progresso</option>
              <option value="pronto" ${tarefa.status === 'pronto' ? 'selected' : ''}>Concluído</option>
            </select>
          </label>
          <label>Responsável
            <select name="novoResponsavel" ${souResponsavel ? '' : 'disabled'}>${opcoesResponsavel}</select>
          </label>
        </div>
        <textarea name="comentario" placeholder="Deixe um retorno para quem abriu a demanda"></textarea>
        <input name="evidencia" type="text" placeholder="Link ou nome do arquivo evidência (opcional)">
        <div class="detalhe-acoes">
          ${souResponsavel ? '<span class="pill">Você pode editar esta tarefa</span>' : '<span class="pill">Somente o responsável pode mudar status</span>'}
          <button type="submit" class="btn-salvar">Enviar resposta</button>
        </div>
      </form>
    </div>`;
  overlay.classList.remove('hidden');
}

function coletarParticipantesParaTabela() {
  const linhas = [];
  DB.missionarios.forEach(f => {
    linhas.push({
      id: f.id,
      chave: 'missionario',
      categoria: 'Família missionária',
      nome: f.responsavel.nome,
      base: f.base || '—',
      origem: `${f.municipio}/${f.estado}`,
      detalhe: `${f.totalPessoas} pessoas${f.filhos?.length ? ` (${f.filhos.length} filho(s))` : ''}`
    });
  });
  DB.equipePessoas.forEach(p => linhas.push({
    id: p.id,
    chave: 'equipe',
    categoria: 'Equipe / Staff',
    nome: p.nome,
    base: p.base || '—',
    origem: p.nascimento || '—',
    detalhe: `RG ${p.rg || '—'} · CPF ${p.cpf || '—'}`
  }));
  DB.preletores.forEach(p => linhas.push({
    id: p.id,
    chave: 'preletor',
    categoria: 'Preletor',
    nome: p.nome,
    base: '—',
    origem: p.camisa || '—',
    detalhe: p.tempo || 'Tempo não informado'
  }));
  DB.convidados.forEach(c => linhas.push({
    id: c.id,
    chave: 'convidado',
    categoria: 'Convidado',
    nome: c.nome,
    base: '—',
    origem: c.camisa || '—',
    detalhe: c.tempo || 'Tempo não informado'
  }));
  DB.pastores.forEach(p => linhas.push({
    id: p.id,
    chave: 'pastor',
    categoria: 'Pastor',
    nome: p.nome,
    base: p.igreja || '—',
    origem: `${p.municipio}/${p.uf}`,
    detalhe: p.casado && p.conjuge ? `Casado · Cônjuge: ${p.conjuge.nome || '—'}` : 'Sem cônjuge informado'
  }));
  return linhas;
}

function renderTabelaParticipantes() {
  const corpo = document.getElementById('participantesTabela');
  const totalSpan = document.getElementById('participantesTotal');
  const totalBadge = document.getElementById('participantesTotalizador');
  if (!corpo) return;

  const filtro = tabelaParticipantesState.filtro;
  const busca = tabelaParticipantesState.busca.toLowerCase();
  const linhasFiltradas = coletarParticipantesParaTabela().filter(l => {
    const correspondeFiltro = filtro === 'todas' || l.categoria === filtro;
    const termos = `${l.nome} ${l.base} ${l.origem} ${l.detalhe}`.toLowerCase();
    const correspondeBusca = !busca || termos.includes(busca);
    return correspondeFiltro && correspondeBusca;
  });

  linhasFiltradas.sort((a, b) => {
    const prop = tabelaParticipantesState.sortBy;
    const dir = tabelaParticipantesState.direction === 'asc' ? 1 : -1;
    return String(a[prop] || '').localeCompare(String(b[prop] || ''), 'pt', { sensitivity: 'base' }) * dir;
  });

  corpo.innerHTML = linhasFiltradas.length
    ? linhasFiltradas.map(l => `<tr class="participante-row${participanteSelecionado && participanteSelecionado.id===l.id ? ' selected' : ''}" data-id="${l.id}" data-chave="${l.chave}"><td>${l.categoria}</td><td>${l.nome}</td><td>${l.base}</td><td>${l.origem}</td><td>${l.detalhe}</td></tr>`).join('')
    : '<tr><td colspan="5">Nenhum participante encontrado com os filtros atuais.</td></tr>';

  if (totalSpan) totalSpan.textContent = `${linhasFiltradas.length} de ${coletarParticipantesParaTabela().length} exibidos`;
  if (totalBadge) totalBadge.textContent = `${calcularTotalParticipantes()} pessoas`;

  const headers = document.querySelectorAll('#participantes-lista .sortable');
  headers.forEach(th => {
    th.classList.toggle('active', th.dataset.sort === tabelaParticipantesState.sortBy);
    const indicador = th.querySelector('span');
    if (indicador && th.dataset.sort === tabelaParticipantesState.sortBy) {
      indicador.textContent = tabelaParticipantesState.direction === 'asc' ? '↑' : '↓';
    } else if (indicador) {
      indicador.textContent = '⇅';
    }
  });

  document.querySelectorAll('#participantesTabela tr[data-id]').forEach(tr => {
    tr.addEventListener('click', () => {
      participanteSelecionado = { id: Number(tr.dataset.id), chave: tr.dataset.chave };
      detalheEditando = false;
      renderDetalheParticipante();
      renderTabelaParticipantes();
    });
  });
}

function renderCampoDetalhe(label, value, name, type = 'text', options = null) {
  if (detalheEditando) {
    if (options) {
      return `<label class="detalhe-campo"><strong>${label}</strong><select name="${name}">${options.map(opt => `<option value="${opt.value}" ${String(value).toLowerCase() === String(opt.value).toLowerCase() ? 'selected' : ''}>${opt.label}</option>`).join('')}</select></label>`;
    }
    return `<label class="detalhe-campo"><strong>${label}</strong><input name="${name}" type="${type}" value="${value || ''}"></label>`;
  }
  return `<div class="detalhe-campo"><strong>${label}</strong><span>${value || '—'}</span></div>`;
}

function obterParticipantePorChave(chave, id) {
  if (chave === 'missionario') return DB.missionarios.find(f => f.id === id);
  if (chave === 'equipe') return DB.equipePessoas.find(e => e.id === id);
  if (chave === 'preletor') return DB.preletores.find(p => p.id === id);
  if (chave === 'convidado') return DB.convidados.find(c => c.id === id);
  if (chave === 'pastor') return DB.pastores.find(p => p.id === id);
  return null;
}

function renderDetalheParticipante() {
  const painel = document.getElementById('participanteDetalhes');
  const overlay = document.getElementById('participanteOverlay');
  if (!painel || !overlay) return;

  if (!participanteSelecionado) {
    overlay.classList.add('hidden');
    painel.innerHTML = '';
    return;
  }

  const registro = obterParticipantePorChave(participanteSelecionado.chave, participanteSelecionado.id);
  if (!registro) {
    participanteSelecionado = null;
    overlay.classList.add('hidden');
    return;
  }

  overlay.classList.remove('hidden');
  const chave = participanteSelecionado.chave;
  const titulo = categoriaLabels[chave] || 'Participante';

  let camposHTML = '';
  let datasetExtras = '';

  if (chave === 'missionario') {
    const filhos = registro.filhos || [];
    datasetExtras = `data-filhos="${filhos.length}"`;
    camposHTML = `
      <div class="detalhe-grid">
        ${renderCampoDetalhe('Base missionária', registro.base, 'base')}
        ${renderCampoDetalhe('Responsável', registro.responsavel?.nome, 'responsavel_nome')}
        ${renderCampoDetalhe('Nascimento', registro.responsavel?.nascimento, 'responsavel_nascimento', 'date')}
        ${renderCampoDetalhe('RG', registro.responsavel?.rg, 'responsavel_rg')}
        ${renderCampoDetalhe('CPF', registro.responsavel?.cpf, 'responsavel_cpf')}
        ${renderCampoDetalhe('Camisa', registro.responsavel?.camisa, 'responsavel_camisa')}
        ${renderCampoDetalhe('Estado', registro.estado, 'estado')}
        ${renderCampoDetalhe('Município', registro.municipio, 'municipio')}
        ${renderCampoDetalhe('Casado', registro.casado ? 'sim' : 'nao', 'casado', 'select', [
          { label: 'Sim', value: 'sim' },
          { label: 'Não', value: 'nao' }
        ])}
      </div>
      ${(detalheEditando || registro.casado) ? `
      <div class="detalhe-grid">
        ${renderCampoDetalhe('Cônjuge - Nome', registro.conjuge?.nome, 'conjuge_nome')}
        ${renderCampoDetalhe('Cônjuge - Nascimento', registro.conjuge?.nascimento, 'conjuge_nascimento', 'date')}
        ${renderCampoDetalhe('Cônjuge - RG', registro.conjuge?.rg, 'conjuge_rg')}
        ${renderCampoDetalhe('Cônjuge - CPF', registro.conjuge?.cpf, 'conjuge_cpf')}
        ${renderCampoDetalhe('Cônjuge - Camisa', registro.conjuge?.camisa, 'conjuge_camisa')}
      </div>` : ''}
      ${(detalheEditando || filhos.length) ? `<div class="detalhe-grid">${filhos.map((filho, idx) => `
        ${renderCampoDetalhe(`Filho ${idx + 1} - Nome`, filho.nome, `filho_nome_${idx}`)}
        ${renderCampoDetalhe(`Filho ${idx + 1} - Nascimento`, filho.nascimento, `filho_nascimento_${idx}`, 'date')}
        ${renderCampoDetalhe(`Filho ${idx + 1} - RG`, filho.rg, `filho_rg_${idx}`)}
        ${renderCampoDetalhe(`Filho ${idx + 1} - CPF`, filho.cpf, `filho_cpf_${idx}`)}
        ${renderCampoDetalhe(`Filho ${idx + 1} - Camisa`, filho.camisa, `filho_camisa_${idx}`)}
      `).join('')}</div>` : ''}
    `;
  }

  if (chave === 'equipe') {
    camposHTML = `
      <div class="detalhe-grid">
        ${renderCampoDetalhe('Base / Área', registro.base, 'base')}
        ${renderCampoDetalhe('Nome', registro.nome, 'nome')}
        ${renderCampoDetalhe('Nascimento', registro.nascimento, 'nascimento', 'date')}
        ${renderCampoDetalhe('RG', registro.rg, 'rg')}
        ${renderCampoDetalhe('CPF', registro.cpf, 'cpf')}
        ${renderCampoDetalhe('Camisa', registro.camisa, 'camisa')}
      </div>`;
  }

  if (chave === 'preletor' || chave === 'convidado') {
    camposHTML = `
      <div class="detalhe-grid">
        ${renderCampoDetalhe('Nome', registro.nome, 'nome')}
        ${renderCampoDetalhe('Camisa', registro.camisa, 'camisa')}
        ${renderCampoDetalhe('Tempo no evento', registro.tempo, 'tempo')}
      </div>`;
  }

  if (chave === 'pastor') {
    camposHTML = `
      <div class="detalhe-grid">
        ${renderCampoDetalhe('Igreja', registro.igreja, 'igreja')}
        ${renderCampoDetalhe('UF', registro.uf, 'uf')}
        ${renderCampoDetalhe('Município', registro.municipio, 'municipio')}
        ${renderCampoDetalhe('Nome', registro.nome, 'nome')}
        ${renderCampoDetalhe('Telefone 1', registro.tel1, 'tel1')}
        ${renderCampoDetalhe('Telefone 2', registro.tel2, 'tel2')}
        ${renderCampoDetalhe('Nascimento', registro.nascimento, 'nascimento', 'date')}
        ${renderCampoDetalhe('RG', registro.rg, 'rg')}
        ${renderCampoDetalhe('CPF', registro.cpf, 'cpf')}
        ${renderCampoDetalhe('Camisa', registro.camisa, 'camisa')}
        ${renderCampoDetalhe('Casado', registro.casado ? 'sim' : 'nao', 'casado', 'select', [
          { label: 'Sim', value: 'sim' },
          { label: 'Não', value: 'nao' }
        ])}
      </div>
      ${(detalheEditando || registro.casado) ? `<div class="detalhe-grid">
        ${renderCampoDetalhe('Cônjuge - Nome', registro.conjuge?.nome, 'conjuge_nome')}
        ${renderCampoDetalhe('Cônjuge - Nascimento', registro.conjuge?.nascimento, 'conjuge_nascimento', 'date')}
        ${renderCampoDetalhe('Cônjuge - RG', registro.conjuge?.rg, 'conjuge_rg')}
        ${renderCampoDetalhe('Cônjuge - CPF', registro.conjuge?.cpf, 'conjuge_cpf')}
        ${renderCampoDetalhe('Cônjuge - Camisa', registro.conjuge?.camisa, 'conjuge_camisa')}
      </div>` : ''}`;
  }

  painel.innerHTML = `
    <button type="button" class="detalhe-fechar" aria-label="Fechar detalhes" onclick="fecharDetalheParticipante()">×</button>
    <form id="formDetalheParticipante" data-chave="${chave}" ${datasetExtras}>
      <div class="totalizador">
        <div>
          <h3>${registro.responsavel?.nome || registro.nome || 'Participante'}</h3>
          <p class="caption">${titulo}</p>
        </div>
        <span class="pill">Registro #${participanteSelecionado.id}</span>
      </div>
      ${camposHTML}
      <div class="detalhe-acoes">
        <button type="button" class="btn-editar ${detalheEditando ? 'hidden' : ''}" onclick="entrarEdicaoDetalhe()">Editar</button>
        <button type="button" class="btn-no ${detalheEditando ? 'hidden' : ''}" onclick="removerParticipanteSelecionado()">Excluir</button>
        <button type="button" class="btn-salvar ${detalheEditando ? '' : 'hidden'}" onclick="salvarEdicaoDetalhe()">Salvar</button>
        <button type="button" class="btn-cancelar ${detalheEditando ? '' : 'hidden'}" onclick="cancelarEdicaoDetalhe()">Cancelar</button>
        <button type="button" class="btn-secondary" onclick="fecharDetalheParticipante()">Fechar</button>
      </div>
    </form>
  `;
}

function entrarEdicaoDetalhe() { detalheEditando = true; renderDetalheParticipante(); }
function cancelarEdicaoDetalhe() { detalheEditando = false; renderDetalheParticipante(); }

function removerParticipanteSelecionado() {
  if (!participanteSelecionado) return;
  const registro = obterParticipantePorChave(participanteSelecionado.chave, participanteSelecionado.id);
  const nome = registro?.responsavel?.nome || registro?.nome || 'este participante';
  if (!confirm(`Deseja realmente excluir ${nome}?`)) return;
  const { chave, id } = participanteSelecionado;
  if (chave === 'missionario') window.removerMissionario(id);
  if (chave === 'equipe') window.removerEquipePessoa(id);
  if (chave === 'preletor') window.removerPreletor(id);
  if (chave === 'convidado') window.removerConvidado(id);
  if (chave === 'pastor') window.removerPastor(id);
  participanteSelecionado = null;
  detalheEditando = false;
  renderDetalheParticipante();
  renderTabelaParticipantes();
}

function fecharDetalheParticipante() {
  participanteSelecionado = null;
  detalheEditando = false;
  renderDetalheParticipante();
  renderTabelaParticipantes();
}

function salvarEdicaoDetalhe() {
  if (!participanteSelecionado) return;
  const form = document.getElementById('formDetalheParticipante');
  if (!form) return;
  const fd = new FormData(form);
  const registro = obterParticipantePorChave(participanteSelecionado.chave, participanteSelecionado.id);
  if (!registro) return;

  switch (participanteSelecionado.chave) {
    case 'missionario': {
      registro.base = fd.get('base');
      registro.responsavel = registro.responsavel || {};
      registro.responsavel.nome = fd.get('responsavel_nome');
      registro.responsavel.nascimento = fd.get('responsavel_nascimento');
      registro.responsavel.rg = fd.get('responsavel_rg');
      registro.responsavel.cpf = fd.get('responsavel_cpf');
      registro.responsavel.camisa = fd.get('responsavel_camisa');
      registro.estado = fd.get('estado');
      registro.municipio = fd.get('municipio');
      registro.casado = fd.get('casado') === 'sim';
      if (registro.casado) {
        registro.conjuge = {
          nome: fd.get('conjuge_nome'),
          nascimento: fd.get('conjuge_nascimento'),
          rg: fd.get('conjuge_rg'),
          cpf: fd.get('conjuge_cpf'),
          camisa: fd.get('conjuge_camisa')
        };
        const filhosQtd = Number(form.dataset.filhos) || 0;
        const filhosAtualizados = [];
        for (let i = 0; i < filhosQtd; i++) {
          filhosAtualizados.push({
            nome: fd.get(`filho_nome_${i}`),
            nascimento: fd.get(`filho_nascimento_${i}`),
            rg: fd.get(`filho_rg_${i}`),
            cpf: fd.get(`filho_cpf_${i}`),
            camisa: fd.get(`filho_camisa_${i}`)
          });
        }
        registro.filhos = filhosAtualizados;
        registro.totalPessoas = 1 + 1 + filhosAtualizados.length;
      } else {
        registro.conjuge = null;
        registro.filhos = [];
        registro.totalPessoas = 1;
      }
      const familia = DB.familias.find(f => f.id === registro.id);
      if (familia) {
        familia.nome = registro.responsavel?.nome || familia.nome;
        familia.qtd = registro.totalPessoas;
        familia.cidade = `${registro.municipio}/${registro.estado}`;
        familia.base = registro.base;
      }
      break;
    }
    case 'equipe': {
      registro.base = fd.get('base');
      registro.nome = fd.get('nome');
      registro.nascimento = fd.get('nascimento');
      registro.rg = fd.get('rg');
      registro.cpf = fd.get('cpf');
      registro.camisa = fd.get('camisa');
      break;
    }
    case 'preletor':
    case 'convidado': {
      registro.nome = fd.get('nome');
      registro.camisa = fd.get('camisa');
      registro.tempo = fd.get('tempo');
      break;
    }
    case 'pastor': {
      registro.igreja = fd.get('igreja');
      registro.uf = fd.get('uf');
      registro.municipio = fd.get('municipio');
      registro.nome = fd.get('nome');
      registro.tel1 = fd.get('tel1');
      registro.tel2 = fd.get('tel2');
      registro.nascimento = fd.get('nascimento');
      registro.rg = fd.get('rg');
      registro.cpf = fd.get('cpf');
      registro.camisa = fd.get('camisa');
      registro.casado = fd.get('casado') === 'sim';
      registro.conjuge = registro.casado ? {
        nome: fd.get('conjuge_nome'),
        nascimento: fd.get('conjuge_nascimento'),
        rg: fd.get('conjuge_rg'),
        cpf: fd.get('conjuge_cpf'),
        camisa: fd.get('conjuge_camisa')
      } : null;
      break;
    }
  }

  detalheEditando = false;
  atualizarLeitura();
  atualizarEdicao();
  renderTabelaParticipantes();
  renderDetalheParticipante();
  salvar();
}

function atualizarEdicao() {
  const buildTable = (titulo, headers, rows, vazio) => {
    const corpo = rows.length
      ? rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')
      : `<tr><td colspan="${headers.length}">${vazio}</td></tr>`;
    return `
      <div class="table-group">
        <h3>${titulo}</h3>
        <table>
          <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
          <tbody>${corpo}</tbody>
        </table>
      </div>`;
  };

  setSelectOptions('projetoEquipe', DB.equipes, e => e.nome);
  setSelectOptions('tarefaProjeto', DB.projetos, p => p.nome);
  setSelectOptions('aprovacaoSolicitacao', DB.solicitacoes, s => `${s.item} (${s.qtd} un)`);
  setSelectOptions('pedidoAprovado', DB.aprovacoes, a => `${a.item} - R$ ${a.valor.toFixed(2)}`);
  setSelectOptions('alocacaoQuarto', DB.quartos, q => `${q.nome} • ${vagasDisponiveis(q)} vagas livres`);
  setSelectOptions('alocacaoParticipante', DB.familias, f => `${f.nome} (${f.qtd} pessoas)`);
  const financeiroForm = document.getElementById('formFinanceiro');
  if (financeiroForm) {
    financeiroForm[0].value = DB.financeiro.orcado;
    financeiroForm[1].value = DB.financeiro.realizado;
  }

  const listaCampos = document.getElementById('listaCamposPersonalizados');
  const respostasDinamicas = document.getElementById('respostasDinamicas');
  const listaRespostasPersonalizadas = document.getElementById('listaRespostasPersonalizadas');

  const camposHTML = buildTable('Campos personalizados', ['Pergunta', 'Tipo', 'Observação', 'Ações'],
    DB.camposPersonalizados.map(c => [c.pergunta, c.tipo, c.ajuda || '—', `<button class="btn-no btn-small" onclick="removerCampoPersonalizado(${c.id})">Remover</button>`]),
    'Nenhuma pergunta adicionada.');
  if (listaCampos) listaCampos.innerHTML = camposHTML;

  if (respostasDinamicas) {
    respostasDinamicas.innerHTML = DB.camposPersonalizados.map(c => {
      const ajuda = c.ajuda ? `<small>${c.ajuda}</small>` : '';
      let campo = `<input name="campo_${c.id}" type="text" placeholder="${c.ajuda || ''}">`;
      if (c.tipo === 'simnao') campo = `<select name="campo_${c.id}"><option value="">Selecione</option><option>Sim</option><option>Não</option></select>`;
      if (c.tipo === 'longo') campo = `<textarea name="campo_${c.id}" rows="2" placeholder="${c.ajuda || ''}"></textarea>`;
      return `<label>${c.pergunta}<br>${ajuda}${campo}</label>`;
    }).join('');
  }

  if (listaRespostasPersonalizadas) {
    listaRespostasPersonalizadas.innerHTML = buildTable('Respostas complementares', ['Referência', 'Respostas', 'Ações'],
      DB.respostasPersonalizadas.map(r => [r.referencia, r.respostas.map(resp => `<strong>${resp.pergunta}:</strong> ${resp.resposta || '—'}`).join('<br>'), `<button class="btn-no btn-small" onclick="removerRespostaPersonalizada(${r.id})">Remover</button>`]),
      'Nenhuma resposta salva.');
  }

  document.getElementById('equipes-edicao').innerHTML = [
    buildTable('Equipes', ['Equipe', 'Responsável', 'Membros', 'Ações'],
      DB.equipes.map(eq => [eq.nome, eq.responsavel, eq.membros || '—', `<button class="btn-no btn-small" onclick="removerEquipe(${eq.id})">Excluir</button>`]),
      'Nenhuma equipe cadastrada.'),
    buildTable('Projetos', ['Projeto', 'Equipe', 'Prazo', 'Status'],
      DB.projetos.map(p => [p.nome, (DB.equipes.find(e => e.id === p.equipeId) || {}).nome || '—', p.prazo || '—', p.status]),
      'Nenhum projeto cadastrado.'),
    buildTable('Tarefas', ['Tarefa', 'Projeto', 'Responsável', 'Prazo', 'Status'],
      DB.tarefas.map(t => [t.titulo, (DB.projetos.find(p => p.id === t.projetoId) || {}).nome || '—', t.responsavel || '—', t.prazo || '—', t.status]),
      'Nenhuma tarefa registrada.')
  ].join('');

  document.getElementById('edicao-transporte').innerHTML = [
    buildTable('Ônibus', ['Origem', 'Passageiros', 'Empresa', 'Data/Hora', 'Ações'],
      DB.onibus.map(o => [o.cidade, o.qtd, o.empresa, formatarDataHora(o.data), `<button class="btn-no btn-small" onclick=\"removerOnibus(${o.id})\">Remover</button>`]),
      'Nenhum ônibus cadastrado.'),
    buildTable('Voos', ['Passageiro', 'Voo', 'Data/Hora', 'Ações'],
      DB.voos.map(v => [v.passageiro, v.voo, formatarDataHora(v.data), `<button class="btn-no btn-small" onclick=\"removerVoo(${v.id})\">Remover</button>`]),
      'Nenhum voo cadastrado.')
  ].join('');

  const edicaoAlojamento = document.getElementById('edicao-alojamento');
  if (edicaoAlojamento) {
    edicaoAlojamento.innerHTML = buildTable('Quartos', ['Quarto', 'Camas e tipo', 'Ocupação', 'Ações'],
      DB.quartos.map(q => {
        const ocupantes = (q.ocupantes || []).map(id => {
          const familia = DB.familias.find(f => f.id === id);
          const nome = familia ? `${familia.nome} (${familia.qtd}p)` : 'Participante removido';
          return `<span class="tag-ocupante">${nome}<button title="Remover" onclick="desvincularParticipante(${q.id}, ${id})">×</button></span>`;
        }).join('');
        const ocupacao = `${ocupacaoQuarto(q)}/${capacidadeQuarto(q)} pessoas` + (ocupantes ? `<div>${ocupantes}</div>` : '<div class="ocupantes">Sem participantes.</div>');
        return [q.nome, `${descricaoTipoQuarto(q)}<br><small>${capacidadeQuarto(q)} vagas totais</small>`, ocupacao, `<button class="btn-no btn-small" onclick="removerQuarto(${q.id})">Remover</button>`];
      }),
      'Nenhum quarto cadastrado.');
  }

  document.getElementById('cronograma-edicao').innerHTML = buildTable('Atividades', ['Data/Hora', 'Atividade', 'Responsável', 'Ações'],
    DB.cronograma.map(e => [formatarDataHora(e.data), e.titulo, e.responsavel, `<button class="btn-no btn-small" onclick="removerCronograma(${e.id})">Remover</button>`]),
    'Cronograma vazio.');

  document.getElementById('cardapio-edicao').innerHTML = buildTable('Refeições', ['Data', 'Tipo', 'Cardápio', 'Ações'],
    DB.refeicoes.map(r => [r.data, r.tipo, r.descricao, `<button class="btn-no btn-small" onclick="removerRefeicao(${r.id})">Remover</button>`]),
    'Nenhuma refeição planejada.');

  document.getElementById('compras-edicao').innerHTML = [
    buildTable('Solicitações', ['Item', 'Qtd', 'Centro', 'Ações'],
      DB.solicitacoes.map(s => [s.item, s.qtd, s.centro, `<button class="btn-no btn-small" onclick="removerSolicitacao(${s.id})">Remover</button>`]),
      'Sem solicitações.'),
    buildTable('Aprovações', ['Item', 'Qtd', 'Valor', 'Ações'],
      DB.aprovacoes.map(a => [a.item, a.qtd, `R$ ${a.valor.toFixed(2)}`, `<button class="btn-no btn-small" onclick="removerAprovacao(${a.id})">Remover</button>`]),
      'Sem aprovações.'),
    buildTable('Pedidos', ['Item', 'Fornecedor', 'Ações'],
      DB.pedidos.map(p => [p.item, p.fornecedor, `<button class="btn-no btn-small" onclick="removerPedido(${p.id})">Remover</button>`]),
      'Sem pedidos registrados.')
  ].join('');

  document.getElementById('palestras-edicao').innerHTML = buildTable('Palestras', ['Tema', 'Palestrante', 'Ações'],
    DB.palestras.map(p => [p.tema, p.palestrante, `<button class="btn-no btn-small" onclick="removerPalestra(${p.id})">Remover</button>`]),
    'Nenhuma palestra cadastrada.');

  document.getElementById('kids-edicao').innerHTML = buildTable('Atividades Kids', ['Atividade', 'Responsável', 'Ações'],
    DB.kids.map(k => [k.atividade, k.responsavel, `<button class="btn-no btn-small" onclick="removerKids(${k.id})">Remover</button>`]),
    'Sem atividades kids.');

  document.getElementById('financeiro-edicao').innerHTML = buildTable('Centros de custo', ['Centro', 'Orçado', 'Realizado', 'Ações'],
    DB.financeiro.centros.map(c => [c.nome, `R$ ${c.orcado.toFixed(2)}`, `R$ ${c.realizado.toFixed(2)}`, `<button class="btn-no btn-small" onclick="removerCentro(${c.id})">Remover</button>`]),
    'Nenhum centro cadastrado.');

  renderTabelaParticipantes();
  renderQuartosIntegrados();
}

// =============================================
// CADASTROS (exemplo participantes e transporte)
// =============================================
const formTarefaModal = document.getElementById('formTarefaModal');
if (formTarefaModal) formTarefaModal.onsubmit = salvarTarefaRapida;
const formAnexoModal = document.getElementById('formAnexoModal');
if (formAnexoModal) formAnexoModal.onsubmit = salvarAnexoModal;
const formCustoModal = document.getElementById('formCustoModal');
if (formCustoModal) formCustoModal.onsubmit = salvarCustoModal;
const selectProjetoAnexo = document.getElementById('modalProjetoAnexo');
if (selectProjetoAnexo) selectProjetoAnexo.addEventListener('change', e => preencherTarefasPorProjeto('modalTarefaAnexo', Number(e.target.value)));
const selectProjetoCusto = document.getElementById('modalProjetoCusto');
if (selectProjetoCusto) selectProjetoCusto.addEventListener('change', e => preencherTarefasPorProjeto('modalTarefaCusto', Number(e.target.value)));

const casadoSelect = document.getElementById('casado');
const temFilhosSelect = document.getElementById('temFilhos');
const quantosFilhosInput = document.getElementById('quantosFilhos');
if (casadoSelect) casadoSelect.addEventListener('change', toggleBlocosFamilia);
if (temFilhosSelect) temFilhosSelect.addEventListener('change', toggleBlocosFamilia);
if (quantosFilhosInput) quantosFilhosInput.addEventListener('input', () => toggleBlocosFamilia());
toggleBlocosFamilia();

const pastorCasadoSelect = document.getElementById('pastorCasado');
if (pastorCasadoSelect) {
  pastorCasadoSelect.addEventListener('change', toggleConjugePastor);
  toggleConjugePastor();
}

const formMissionario = document.getElementById('formMissionario');
if (formMissionario) formMissionario.onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const casado = fd.get('casado') === 'sim';
  const temFilhos = fd.get('temFilhos') === 'sim';
  const filhosQtd = casado && temFilhos ? Math.max(Number(fd.get('quantosFilhos')) || 0, 0) : 0;
  const filhos = [];
  for (let i = 0; i < filhosQtd; i++) {
    filhos.push({
      nome: fd.get(`filho_nome_${i}`) || `Filho ${i + 1}`,
      nascimento: fd.get(`filho_nascimento_${i}`),
      rg: fd.get(`filho_rg_${i}`),
      cpf: fd.get(`filho_cpf_${i}`),
      camisa: fd.get(`filho_camisa_${i}`)
    });
  }
  const familiaId = Date.now();
  const familia = {
    id: familiaId,
    base: fd.get('base'),
    responsavel: {
      nome: fd.get('responsavel'),
      nascimento: fd.get('nascimentoResponsavel'),
      rg: fd.get('rgResponsavel'),
      cpf: fd.get('cpfResponsavel'),
      camisa: fd.get('camisaResponsavel')
    },
    estado: fd.get('estado'),
    municipio: fd.get('municipio'),
    casado,
    conjuge: casado ? {
      nome: fd.get('conjugeNome'),
      nascimento: fd.get('conjugeNascimento'),
      rg: fd.get('conjugeRg'),
      cpf: fd.get('conjugeCpf'),
      camisa: fd.get('conjugeCamisa')
    } : null,
    filhos,
    totalPessoas: 1 + (casado ? 1 : 0) + filhos.length
  };
  DB.missionarios.push(familia);
  DB.familias.push({ id: familiaId, nome: familia.responsavel.nome, qtd: familia.totalPessoas, cidade: `${familia.municipio}/${familia.estado}`, base: familia.base, tipo: 'missionario' });
  e.target.reset();
  toggleBlocosFamilia();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

const formEquipePessoa = document.getElementById('formEquipePessoa');
if (formEquipePessoa) formEquipePessoa.onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  DB.equipePessoas.push({
    id: Date.now(),
    base: fd.get('base'),
    nome: fd.get('nome'),
    nascimento: fd.get('nascimento'),
    rg: fd.get('rg'),
    cpf: fd.get('cpf'),
    camisa: fd.get('camisa')
  });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

const formPreletor = document.getElementById('formPreletor');
if (formPreletor) formPreletor.onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  DB.preletores.push({ id: Date.now(), nome: fd.get('nome'), camisa: fd.get('camisa'), tempo: fd.get('tempo') });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

const formConvidado = document.getElementById('formConvidado');
if (formConvidado) formConvidado.onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  DB.convidados.push({ id: Date.now(), nome: fd.get('nome'), camisa: fd.get('camisa'), tempo: fd.get('tempo') });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

const formPastor = document.getElementById('formPastor');
if (formPastor) formPastor.onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const casadoPastor = fd.get('casado') === 'sim';
  const conjuge = casadoPastor ? {
    nome: fd.get('conjugeNome'),
    nascimento: fd.get('conjugeNascimento'),
    rg: fd.get('conjugeRg'),
    cpf: fd.get('conjugeCpf'),
    camisa: fd.get('conjugeCamisa')
  } : null;
  DB.pastores.push({
    id: Date.now(),
    igreja: fd.get('igreja'),
    uf: fd.get('uf'),
    municipio: fd.get('municipio'),
    nome: fd.get('nome'),
    tel1: fd.get('tel1'),
    tel2: fd.get('tel2'),
    nascimento: fd.get('nascimento'),
    rg: fd.get('rg'),
    cpf: fd.get('cpf'),
    camisa: fd.get('camisa'),
    casado: casadoPastor,
    conjuge
  });
  e.target.reset();
  toggleConjugePastor();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

const formCampoPersonalizado = document.getElementById('formCampoPersonalizado');
if (formCampoPersonalizado) formCampoPersonalizado.onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  DB.camposPersonalizados.push({ id: Date.now(), pergunta: fd.get('pergunta'), tipo: fd.get('tipo'), ajuda: fd.get('ajuda') });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

const formRespostasPersonalizadas = document.getElementById('formRespostasPersonalizadas');
if (formRespostasPersonalizadas) formRespostasPersonalizadas.onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const respostas = DB.camposPersonalizados.map(c => ({ campoId: c.id, pergunta: c.pergunta, resposta: fd.get(`campo_${c.id}`) || '' }));
  DB.respostasPersonalizadas.push({ id: Date.now(), referencia: fd.get('referencia'), respostas });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formEquipe').onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const nome = fd.get('nomeEquipe');
  const responsavel = fd.get('responsavelEquipe');
  const membros = fd.get('membrosEquipe');
  DB.equipes.push({ id: Date.now(), nome, responsavel, membros });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formProjeto').onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const nome = fd.get('nomeProjeto');
  const equipeId = fd.get('projetoEquipe');
  const prazo = fd.get('prazoProjeto');
  const status = fd.get('statusProjeto');
  if (!equipeId) return alert('Selecione uma equipe para vincular o projeto.');
  DB.projetos.push({ id: Date.now(), nome, equipeId: Number(equipeId), prazo, status });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formTarefa').onsubmit = e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const titulo = fd.get('tituloTarefa');
  const projetoId = fd.get('tarefaProjeto');
  const responsavel = fd.get('responsavelTarefa');
  const prazo = fd.get('prazoTarefa');
  const prioridade = fd.get('prioridadeTarefa');
  const etiqueta = fd.get('etiquetaTarefa');
  const status = fd.get('statusTarefa');
  if (!projetoId) return alert('Selecione um projeto para a tarefa.');
  DB.tarefas.push({ id: Date.now(), titulo, projetoId: Number(projetoId), status, responsavel, prazo, prioridade, etiqueta });
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formOnibus').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.onibus.push({id:Date.now(), cidade:i[0].value, qtd:+i[1].value, empresa:i[2].value, data:i[3].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formVoo').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.voos.push({id:Date.now(), passageiro:i[0].value, voo:i[1].value, data:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

const formQuarto = document.getElementById('formQuarto');
if (formQuarto) formQuarto.onsubmit = e => {
  e.preventDefault();
  const i = e.target.elements;
  if (!tiposSelecionados.length) return alert('Inclua ao menos um tipo de cama para o quarto.');
  if (quartoEditandoId) {
    const quarto = DB.quartos.find(q => q.id === quartoEditandoId);
    if (!quarto) return alert('Quarto não encontrado para edição.');
    quarto.nome = i[0].value;
    quarto.tiposCama = [...tiposSelecionados];
    quartoSelecionadoId = quarto.id;
    prepararFormularioParaNovo();
  } else {
    const novoId = Date.now();
    DB.quartos.push({ id: novoId, nome: i[0].value, tiposCama: [...tiposSelecionados], ocupantes: [], layout: layoutPadraoQuarto(DB.quartos.length) });
    quartoSelecionadoId = novoId;
    prepararFormularioParaNovo();
  }
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

const formAlocacao = document.getElementById('formAlocacao');
if (formAlocacao) formAlocacao.onsubmit = e => {
  e.preventDefault();
  const quartoId = Number(document.getElementById('alocacaoQuarto').value);
  const familiaId = Number(document.getElementById('alocacaoParticipante').value);
  const quarto = DB.quartos.find(q => q.id === quartoId);
  const familia = DB.familias.find(f => f.id === familiaId);
  if (!quarto || !familia) return alert('Selecione um quarto e um participante válidos.');
  if (!quarto.ocupantes) quarto.ocupantes = [];
  if (quarto.ocupantes.includes(familiaId)) return alert('Esse participante já está vinculado ao quarto.');
  if (ocupacaoQuarto(quarto) + familia.qtd > capacidadeQuarto(quarto)) return alert('Capacidade insuficiente para essa família neste quarto.');
  quarto.ocupantes.push(familiaId);
  e.target.reset();
  atualizarLeitura(); atualizarEdicao(); salvar();
};

document.getElementById('formCronograma').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.cronograma.push({id:Date.now(), data:i[0].value, titulo:i[1].value, responsavel:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

document.getElementById('formRefeicao').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.refeicoes.push({id:Date.now(), data:i[0].value, tipo:i[1].value, descricao:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

document.getElementById('formSolicitacao').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.solicitacoes.push({id:Date.now(), item:i[0].value, qtd:+i[1].value, centro:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formAprovacao').onsubmit = e => { e.preventDefault(); const i = e.target.elements; if(!i[0].value) return alert('Escolha uma solicitação.'); const solicitacao = DB.solicitacoes.find(s=>s.id===Number(i[0].value)); DB.aprovacoes.push({id:Date.now(), item:solicitacao.item, qtd:solicitacao.qtd, valor:+i[1].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formPedido').onsubmit = e => { e.preventDefault(); const i = e.target.elements; if(!i[0].value) return alert('Escolha uma aprovação.'); const aprovacao = DB.aprovacoes.find(a=>a.id===Number(i[0].value)); DB.pedidos.push({id:Date.now(), item:aprovacao.item, fornecedor:i[1].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

document.getElementById('formPalestra').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.palestras.push({id:Date.now(), data:i[0].value, tema:i[1].value, palestrante:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formKids').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.kids.push({id:Date.now(), data:i[0].value, atividade:i[1].value, responsavel:i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formFinanceiro').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.financeiro.orcado = +i[0].value; DB.financeiro.realizado = +i[1].value; atualizarLeitura(); atualizarEdicao(); salvar(); };
document.getElementById('formCentro').onsubmit = e => { e.preventDefault(); const i = e.target.elements; DB.financeiro.centros.push({id:Date.now(), nome:i[0].value, orcado:+i[1].value, realizado:+i[2].value}); e.target.reset(); atualizarLeitura(); atualizarEdicao(); salvar(); };

window.removerFamilia = id => { limparFamiliaDeQuartos(id); DB.familias = DB.familias.filter(f=>f.id!==id); DB.missionarios = DB.missionarios.filter(f=>f.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerMissionario = id => { limparFamiliaDeQuartos(id); DB.missionarios = DB.missionarios.filter(f=>f.id!==id); DB.familias = DB.familias.filter(f=>f.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerEquipePessoa = id => { DB.equipePessoas = DB.equipePessoas.filter(p=>p.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerPreletor = id => { DB.preletores = DB.preletores.filter(p=>p.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerConvidado = id => { DB.convidados = DB.convidados.filter(c=>c.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerPastor = id => { DB.pastores = DB.pastores.filter(p=>p.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerCampoPersonalizado = id => { DB.camposPersonalizados = DB.camposPersonalizados.filter(c=>c.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerRespostaPersonalizada = id => { DB.respostasPersonalizadas = DB.respostasPersonalizadas.filter(r=>r.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerEquipe = id => {
  const projetosRemovidos = DB.projetos.filter(p => p.equipeId === id).map(p => p.id);
  DB.equipes = DB.equipes.filter(e => e.id !== id);
  DB.projetos = DB.projetos.filter(p => p.equipeId !== id);
  DB.tarefas = DB.tarefas.filter(t => !projetosRemovidos.includes(t.projetoId));
  DB.anexos = DB.anexos.filter(a => !projetosRemovidos.includes(a.projetoId));
  DB.custosProjetos = DB.custosProjetos.filter(c => !projetosRemovidos.includes(c.projetoId));
  DB.marcos = DB.marcos.filter(m => !projetosRemovidos.includes(m.projetoId));
  DB.notificacoesProjetos = DB.notificacoesProjetos.filter(n => !projetosRemovidos.includes(n.projetoId));
  if (projetosRemovidos.includes(projetoSelecionadoId)) projetoSelecionadoId = DB.projetos[0]?.id || null;
  atualizarLeitura(); atualizarEdicao(); salvar();
};
window.removerOnibus = id => { DB.onibus = DB.onibus.filter(o=>o.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerVoo = id => { DB.voos = DB.voos.filter(v=>v.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.desvincularParticipante = (quartoId, familiaId) => {
  const quarto = DB.quartos.find(q => q.id === quartoId);
  if (!quarto || !quarto.ocupantes) return;
  quarto.ocupantes = quarto.ocupantes.filter(id => id !== familiaId);
  atualizarLeitura(); atualizarEdicao(); salvar();
};
window.removerQuarto = id => { DB.quartos = DB.quartos.filter(q=>q.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerCronograma = id => { DB.cronograma = DB.cronograma.filter(c=>c.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerRefeicao = id => { DB.refeicoes = DB.refeicoes.filter(r=>r.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerSolicitacao = id => { DB.solicitacoes = DB.solicitacoes.filter(s=>s.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerAprovacao = id => { DB.aprovacoes = DB.aprovacoes.filter(a=>a.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerPedido = id => { DB.pedidos = DB.pedidos.filter(p=>p.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerPalestra = id => { DB.palestras = DB.palestras.filter(p=>p.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerKids = id => { DB.kids = DB.kids.filter(k=>k.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };
window.removerCentro = id => { DB.financeiro.centros = DB.financeiro.centros.filter(c=>c.id!==id); atualizarLeitura(); atualizarEdicao(); salvar(); };

// =============================================
// INICIALIZAÇÃO
// =============================================
inicializarQuartosIntegrados();
inicializarSubtabs();
inicializarTabsProjetos();
inicializarToggleParticipantes();
inicializarOverlayParticipante();
inicializarTabelaParticipantes();
atualizarContaUI();
atualizarLeitura();
atualizarEdicao();
</script>
</body>
</html>