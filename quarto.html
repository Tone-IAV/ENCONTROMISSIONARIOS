<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Distribui√ß√£o de Quartos por Fam√≠lias</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root {
    --bg: #f3f4f6;
    --panel: #ffffff;
    --accent: #2563eb;
    --accent-soft: #dbeafe;
    --danger: #b91c1c;
    --text: #111827;
    --muted: #6b7280;
    --border: #e5e7eb;
    --room-bg: #e5e7eb;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    background: #111827;
    color: white;
    padding: 0.75rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  header h1 {
    font-size: 1rem;
    font-weight: 600;
  }

  header span {
    font-size: 0.78rem;
    color: #9ca3af;
  }

  .badge {
    background: #1f2937;
    border-radius: 999px;
    padding: 0.2rem 0.75rem;
    font-size: 0.75rem;
    color: #d1d5db;
  }

  main {
    flex: 1;
    display: grid;
    grid-template-columns: 260px minmax(0, 1fr) 290px;
    gap: 0.75rem;
    padding: 0.75rem;
    overflow: hidden;
  }

  .panel {
    background: var(--panel);
    border-radius: 0.75rem;
    border: 1px solid var(--border);
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    min-height: 0;
  }

  .panel h2 {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .panel h2 small {
    font-size: 0.7rem;
    font-weight: 400;
    color: var(--muted);
  }

  label {
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 0.2rem;
    display: block;
  }

  input[type="text"],
  input[type="number"],
  select {
    width: 100%;
    padding: 0.35rem 0.4rem;
    border-radius: 0.5rem;
    border: 1px solid var(--border);
    font-size: 0.8rem;
  }

  input:focus,
  select:focus {
    outline: 2px solid var(--accent-soft);
    border-color: var(--accent);
  }

  button {
    border: none;
    border-radius: 999px;
    padding: 0.35rem 0.8rem;
    font-size: 0.78rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    white-space: nowrap;
  }

  button.primary {
    background: var(--accent);
    color: white;
  }

  button.secondary {
    background: var(--accent-soft);
    color: var(--accent);
  }

  button.danger {
    background: #fee2e2;
    color: var(--danger);
  }

  button.small {
    padding: 0.18rem 0.55rem;
    font-size: 0.7rem;
  }

  button:disabled {
    opacity: 0.5;
    cursor: default;
  }

  .stack {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .row {
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  .row.wrap {
    flex-wrap: wrap;
  }

  .spacer {
    flex: 1;
  }

  /* LISTA DE ESPA√áOS */

  .space-list {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    max-height: 220px;
    overflow-y: auto;
  }

  .space-item {
    border-radius: 0.6rem;
    border: 1px solid var(--border);
    padding: 0.4rem 0.5rem;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    background: #f9fafb;
  }

  .space-item.active {
    border-color: var(--accent);
    background: var(--accent-soft);
  }

  .space-color {
    width: 14px;
    height: 14px;
    border-radius: 0.3rem;
    flex-shrink: 0;
  }

  .space-name {
    flex: 1;
  }

  /* CANVAS / MAPA */

  #canvasWrapper {
    position: relative;
    flex: 1;
    border-radius: 0.75rem;
    border: 1px dashed var(--border);
    background-image: linear-gradient(
        to right,
        #e5e7eb 1px,
        transparent 1px
      ),
      linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
    background-size: 24px 24px;
    background-color: #f9fafb;
    overflow: auto;
  }

  #canvasInner {
    position: relative;
    width: 1600px;
    height: 900px;
  }

  .canvas-label {
    position: sticky;
    top: 0;
    left: 0;
    padding: 0.2rem 0.5rem;
    font-size: 0.7rem;
    background: rgba(17, 24, 39, 0.85);
    color: white;
    border-bottom-right-radius: 0.75rem;
    z-index: 5;
  }

  .room-card {
    position: absolute;
    min-width: 80px;
    min-height: 50px;
    padding: 0.3rem 0.35rem;
    background: var(--room-bg);
    border-radius: 0.55rem;
    border: 1px solid #9ca3af;
    font-size: 0.72rem;
    cursor: grab;
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.2);
  }

  .room-card:active {
    cursor: grabbing;
  }

  .room-header {
    display: flex;
    align-items: center;
    gap: 0.2rem;
    font-weight: 600;
  }

  .room-header span {
    flex: 1;
  }

  .room-tag {
    font-size: 0.6rem;
    padding: 0.05rem 0.35rem;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.08);
  }

  .room-beds,
  .room-capacity,
  .room-families {
    font-size: 0.65rem;
    color: var(--muted);
  }

  .room-families strong {
    color: var(--text);
  }

  .room-drop-hint {
    font-style: italic;
    font-size: 0.64rem;
    color: var(--muted);
  }

  .room-card.drop-target {
    outline: 2px dashed var(--accent);
  }

  /* FAM√çLIAS */

  .family-search {
    position: sticky;
    top: 0;
    background: var(--panel);
    padding-bottom: 0.4rem;
    z-index: 2;
  }

  .family-list {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .family-card {
    border-radius: 0.6rem;
    border: 1px solid var(--border);
    padding: 0.35rem 0.45rem;
    font-size: 0.78rem;
    background: #f9fafb;
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    cursor: grab;
  }

  .family-card span {
    font-weight: 600;
  }

  .family-card small {
    color: var(--muted);
    font-size: 0.7rem;
  }

  .family-card.assigned {
    opacity: 0.55;
  }

  .pill {
    border-radius: 999px;
    background: #e5e7eb;
    font-size: 0.65rem;
    padding: 0.1rem 0.4rem;
  }

  /* DETALHES DO QUARTO SELECIONADO */

  .details {
    font-size: 0.78rem;
    border-top: 1px solid var(--border);
    padding-top: 0.4rem;
    margin-top: 0.2rem;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .details h3 {
    font-size: 0.78rem;
    font-weight: 600;
  }

  .details ul {
    list-style: none;
    margin-top: 0.15rem;
  }

  .details li {
    font-size: 0.74rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .details li button {
    font-size: 0.65rem;
  }

  .muted {
    color: var(--muted);
    font-size: 0.74rem;
  }

  .chip {
    font-size: 0.7rem;
    padding: 0.1rem 0.4rem;
    border-radius: 999px;
    background: #e5e7eb;
  }
</style>
</head>

<body>
<header>
  <div>
    <h1>Distribui√ß√£o de Quartos ‚Ä¢ Evento</h1>
    <span>Monte pr√©dios, crie quartos, arraste fam√≠lias e organize o alojamento.</span>
  </div>
  <div class="badge">Vers√£o prot√≥tipo (HTML puro)</div>
</header>

<main>
  <!-- LADO ESQUERDO: ESPA√áOS / PR√âDIOS E QUARTOS -->
  <section class="panel" id="spacesPanel">
    <div class="stack">
      <h2>
        Espa√ßos / Pr√©dios
        <small>Ex.: Monte das Oliveiras, Alojamento Azul...</small>
      </h2>
      <div class="stack">
        <label for="spaceName">Novo espa√ßo</label>
        <div class="row">
          <input
            id="spaceName"
            type="text"
            placeholder="Nome do pr√©dio / espa√ßo"
          />
          <input
            id="spaceColor"
            type="color"
            value="#2563eb"
            style="width: 40px; padding: 0; border-radius: 0.5rem; border: 1px solid var(--border);"
          />
        </div>
        <button class="primary" id="addSpaceBtn">+ Adicionar espa√ßo</button>
      </div>

      <div class="space-list" id="spaceList"></div>
    </div>

    <div class="stack">
      <h2>
        Quartos do espa√ßo
        <small>Selecione um espa√ßo e use os atalhos.</small>
      </h2>

      <div class="stack">
        <label>Atalhos de quarto (presets de camas)</label>
        <div class="row wrap">
          <button class="secondary small" data-preset="casal">
            Casal (2)
          </button>
          <button class="secondary small" data-preset="pequena">
            Fam√≠lia pequena (4)
          </button>
          <button class="secondary small" data-preset="media">
            Fam√≠lia m√©dia (6)
          </button>
          <button class="secondary small" data-preset="grande">
            Beliches grande (8)
          </button>
        </div>
      </div>

      <div class="stack">
        <label>Ou crie manualmente</label>
        <div class="row wrap">
          <input
            id="roomName"
            type="text"
            placeholder="Nome / n¬∫ do quarto"
            style="flex: 1"
          />
          <input
            id="roomCapacity"
            type="number"
            min="1"
            value="4"
            style="width: 70px"
          />
        </div>
        <small class="muted">Capacidade = total de pessoas para esse quarto.</small>
        <button class="primary" id="addRoomBtn">+ Adicionar quarto</button>
      </div>
    </div>
  </section>

  <!-- CENTRO: MAPA ARRast√°vel -->
  <section class="panel" id="canvasPanel">
    <h2>
      Mapa do Espa√ßo Selecionado
      <small>Arraste os cart√µes para montar o desenho do pr√©dio.</small>
    </h2>
    <div id="canvasWrapper">
      <div class="canvas-label" id="canvasLabel">
        Nenhum espa√ßo selecionado
      </div>
      <div id="canvasInner"></div>
    </div>
  </section>

  <!-- DIREITA: FAM√çLIAS E DETALHES -->
  <section class="panel" id="familiesPanel">
    <h2>
      Fam√≠lias / Participantes
      <small>Arraste para dentro de um quarto.</small>
    </h2>

    <div class="family-search stack">
      <input
        type="text"
        id="familySearch"
        placeholder="Buscar fam√≠lia..."
      />
      <div class="row">
        <span class="muted" id="familyCountLabel"></span>
        <span class="spacer"></span>
        <span class="chip">Dica: cada fam√≠lia tem tamanho em pessoas üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
      </div>
    </div>

    <div class="family-list" id="familyList"></div>

    <div class="details" id="roomDetails">
      <h3>Quarto selecionado</h3>
      <p class="muted">
        Clique em um quarto no mapa para ver detalhes, capacidade e fam√≠lias
        alocadas.
      </p>
    </div>
  </section>
</main>

<script>
  // =========================
  // DADOS INICIAIS (EXEMPLO OU DB)
  // =========================

  const STORAGE_KEY = "encontroDB";

  function loadDB() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch (err) {
      console.error("N√£o foi poss√≠vel carregar dados do alojamento", err);
      return null;
    }
  }

  function persistDB(db) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    } catch (err) {
      console.error("N√£o foi poss√≠vel salvar o estado do alojamento", err);
    }
  }

  const defaultFamilies = [
    { id: "F1", name: "Fam√≠lia Silva", size: 4 },
    { id: "F2", name: "Fam√≠lia Santos", size: 3 },
    { id: "F3", name: "Fam√≠lia Oliveira", size: 5 },
    { id: "F4", name: "Fam√≠lia Souza", size: 2 },
    { id: "F5", name: "Fam√≠lia Pereira", size: 6 },
    { id: "F6", name: "Fam√≠lia Costa", size: 1 },
    { id: "F7", name: "Fam√≠lia Lima", size: 4 },
    { id: "F8", name: "Fam√≠lia Rocha", size: 3 },
    { id: "F9", name: "Fam√≠lia Alves", size: 5 },
    { id: "F10", name: "Fam√≠lia Nascimento", size: 2 }
  ];

  const spaces = [];
  const rooms = {};

  let families = [...defaultFamilies];
  let currentSpaceId = null;
  let selectedRoomId = null;
  let roomAutoId = 1;
  let spaceAutoId = 1;
  const db = loadDB();

  // =========================
  // HELPERS
  // =========================
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => document.querySelectorAll(sel);

  function createSpace(name, color) {
    const id = "S" + spaceAutoId++;
    spaces.push({ id, name, color, roomIds: [] });
    return id;
  }

  function getSpace(id) {
    return spaces.find((s) => s.id === id);
  }

  function createRoom(spaceId, name, capacity, preset, options = {}) {
    const id = options.id || "R" + roomAutoId;
    roomAutoId++;
    const x =
      options.x !== undefined ? options.x : 50 + (spaceId.charCodeAt(1) % 5) * 120;
    const y =
      options.y !== undefined ? options.y : 60 + (Object.keys(rooms).length % 5) * 70;

    const bedPresets = {
      casal: { label: "1 cama de casal", beds: "1C" },
      pequena: { label: "Casal + 2 solteiro", beds: "1C + 2S" },
      media: { label: "2 casal + 2 solteiro", beds: "2C + 2S" },
      grande: { label: "4 beliches", beds: "4B" }
    };

    const bedInfo = preset ? bedPresets[preset] : null;

    rooms[id] = {
      id,
      spaceId,
      name,
      capacity,
      bedsLabel: bedInfo ? bedInfo.label : "Configura√ß√£o personalizada",
      bedsCode: bedInfo ? bedInfo.beds : "",
      x,
      y,
      width: options.width || 120,
      height: options.height || 70,
      families: options.families ? [...options.families] : [], // array de ids de fam√≠lia
      sourceId: options.sourceId || null
    };

    const space = getSpace(spaceId);
    space.roomIds.push(id);
    return id;
  }

  function totalRoomOccupancy(room) {
    return room.families
      .map((fid) => families.find((f) => f.id === fid)?.size || 0)
      .reduce((a, b) => a + b, 0);
  }

  function isFamilyAssigned(familyId) {
    return Object.values(rooms).some((r) => r.families.includes(familyId));
  }

  function capacityFromQuarto(quarto) {
    if (!quarto) return 0;
    if (quarto.capacidadeManual) return quarto.capacidadeManual;
    const tipos = Array.isArray(quarto.tiposCama)
      ? quarto.tiposCama
      : quarto.tipo
        ? [{ tipo: quarto.tipo, quantidade: quarto.camas || 0, andares: quarto.andares }]
        : [];

    return tipos.reduce((total, tipo) => {
      if (tipo.tipo === "Casal") return total + (tipo.quantidade || 0) * 2;
      if (tipo.tipo === "Beliche")
        return total + (tipo.quantidade || 0) * (tipo.andares || 2);
      return total + (tipo.quantidade || 0);
    }, 0);
  }

  function persistRoomsToStorage() {
    if (!db || !Array.isArray(db.quartos)) return;
    Object.values(rooms).forEach((room) => {
      if (!room.sourceId) return;
      const alvo = db.quartos.find((q) => q.id === room.sourceId);
      if (!alvo) return;
      alvo.ocupantes = room.families.map((id) =>
        Number.isFinite(Number(id)) ? Number(id) : id
      );
      alvo.layout = {
        x: room.x,
        y: room.y,
        width: room.width,
        height: room.height
      };
      alvo.capacidadeManual = room.capacity;
      alvo.nome = room.name;
    });
    persistDB(db);
  }

  function populateFromDB() {
    if (!db) return false;

    if (Array.isArray(db.familias) && db.familias.length) {
      families = db.familias.map((f) => ({
        id: String(f.id),
        name: f.nome,
        size: f.qtd || 1
      }));
    }

    if (Array.isArray(db.quartos) && db.quartos.length) {
      const spaceId = createSpace("Mapa do alojamento", "#2563eb");
      currentSpaceId = spaceId;
      db.quartos.forEach((q, idx) => {
        const roomId = createRoom(spaceId, q.nome || `Quarto ${idx + 1}`, capacityFromQuarto(q) || 1, null, {
          sourceId: q.id,
          x: q.layout?.x,
          y: q.layout?.y,
          width: q.layout?.width,
          height: q.layout?.height,
          families: (q.ocupantes || []).map((id) => String(id))
        });
        rooms[roomId].bedsLabel = q.tiposCama?.length
          ? q.tiposCama
              .map((t) =>
                t.tipo === "Beliche"
                  ? `${t.quantidade} beliche(s) (${t.andares || 2} andares)`
                  : `${t.quantidade} cama(s) ${t.tipo.toLowerCase()}`
              )
              .join(" ‚Ä¢ ")
          : rooms[roomId].bedsLabel;
      });
      return true;
    }

    return false;
  }

  // =========================
  // RENDERIZA√á√ÉO
  // =========================

  function renderSpacesList() {
    const list = $("#spaceList");
    list.innerHTML = "";
    if (!spaces.length) {
      list.innerHTML =
        '<p class="muted">Nenhum espa√ßo criado ainda. Crie um acima.</p>';
      return;
    }

    spaces.forEach((space) => {
      const div = document.createElement("div");
      div.className =
        "space-item" + (space.id === currentSpaceId ? " active" : "");
      div.dataset.spaceId = space.id;

      div.innerHTML = `
        <div class="space-color" style="background:${space.color}"></div>
        <div class="space-name">${space.name}</div>
        <div class="chip">${space.roomIds.length} quarto(s)</div>
      `;

      div.addEventListener("click", () => {
        currentSpaceId = space.id;
        selectedRoomId = null;
        renderSpacesList();
        renderCanvas();
        renderRoomDetails();
      });

      list.appendChild(div);
    });
  }

  function renderCanvas() {
    const canvas = $("#canvasInner");
    const label = $("#canvasLabel");
    canvas.innerHTML = "";

    if (!currentSpaceId) {
      label.textContent = "Nenhum espa√ßo selecionado";
      return;
    }

    const space = getSpace(currentSpaceId);
    label.textContent = `Espa√ßo: ${space.name} (arraste os quartos)`;

    space.roomIds.forEach((roomId) => {
      const room = rooms[roomId];
      const card = document.createElement("div");
      card.className =
        "room-card" + (selectedRoomId === room.id ? " selected" : "");
      card.dataset.roomId = room.id;
      card.style.left = room.x + "px";
      card.style.top = room.y + "px";
      card.style.width = room.width + "px";
      card.style.height = room.height + "px";

      const occ = totalRoomOccupancy(room);

      card.innerHTML = `
        <div class="room-header">
          <span>${room.name}</span>
          <span class="room-tag">${occ}/${room.capacity}</span>
        </div>
        <div class="room-beds">${room.bedsLabel}</div>
        <div class="room-capacity">Capacidade: ${room.capacity} pessoa(s)</div>
        <div class="room-families">
          <strong>Fam√≠lias:</strong>
          ${
            room.families.length
              ? room.families
                  .map(
                    (fid) =>
                      families.find((f) => f.id === fid)?.name || "(removida)"
                  )
                  .join(", ")
              : '<span class="room-drop-hint">Arraste uma fam√≠lia para c√°.</span>'
          }
        </div>
      `;

      // Sele√ß√£o para aparecer nos detalhes
      card.addEventListener("click", (e) => {
        e.stopPropagation();
        selectedRoomId = room.id;
        renderCanvas();
        renderRoomDetails();
      });

      // Drag livre do cart√£o (layout do mapa)
      makeRoomDraggable(card, room);

      // Drop target para fam√≠lias
      card.addEventListener("dragover", (e) => {
        e.preventDefault();
        card.classList.add("drop-target");
      });

      card.addEventListener("dragleave", () => {
        card.classList.remove("drop-target");
      });

      card.addEventListener("drop", (e) => {
        e.preventDefault();
        card.classList.remove("drop-target");
        const familyId = e.dataTransfer.getData("text/family-id");
        if (!familyId) return;
        allocateFamilyToRoom(familyId, room.id);
      });

      canvas.appendChild(card);
    });

    // clique vazio do canvas = limpa sele√ß√£o
    canvas.addEventListener("click", () => {
      selectedRoomId = null;
      renderCanvas();
      renderRoomDetails();
    });
  }

  function renderFamiliesList() {
    const list = $("#familyList");
    const search = $("#familySearch").value.toLowerCase().trim();
    list.innerHTML = "";

    const filtered = families.filter((f) =>
      f.name.toLowerCase().includes(search)
    );

    $("#familyCountLabel").textContent = `${filtered.length} fam√≠lia(s) exibida(s)`;

    if (!filtered.length) {
      list.innerHTML = "<p class='muted'>Nenhuma fam√≠lia encontrada.</p>";
      return;
    }

    filtered.forEach((f) => {
      const assigned = isFamilyAssigned(f.id);
      const card = document.createElement("div");
      card.className = "family-card" + (assigned ? " assigned" : "");
      card.draggable = true;
      card.dataset.familyId = f.id;

      card.innerHTML = `
        <span>${f.name}</span>
        <small>${f.size} pessoa(s)</small>
        ${
          assigned
            ? "<small class='muted'>J√° alocada em algum quarto.</small>"
            : "<small class='muted'>Arraste para um quarto dispon√≠vel.</small>"
        }
      `;

      // drag start
      card.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/family-id", f.id);
      });

      list.appendChild(card);
    });
  }

  function renderRoomDetails() {
    const container = $("#roomDetails");
    if (!selectedRoomId || !rooms[selectedRoomId]) {
      container.innerHTML = `
        <h3>Quarto selecionado</h3>
        <p class="muted">
          Clique em um quarto no mapa para ver detalhes, alterar capacidade ou
          remover fam√≠lias.
        </p>`;
      return;
    }

    const room = rooms[selectedRoomId];
    const space = getSpace(room.spaceId);
    const occ = totalRoomOccupancy(room);

    let familiesHtml = "";
    if (!room.families.length) {
      familiesHtml = "<li class='muted'>Nenhuma fam√≠lia alocada.</li>";
    } else {
      familiesHtml = room.families
        .map((fid) => {
          const fam = families.find((f) => f.id === fid);
          if (!fam) return "";
          return `
          <li>
            <span>${fam.name} (${fam.size})</span>
            <button class="small danger" data-remove-family="${fid}">
              remover
            </button>
          </li>`;
        })
        .join("");
    }

    container.innerHTML = `
      <h3>${room.name} ‚Ä¢ ${space.name}</h3>
      <div>
        <div class="muted">Configura√ß√£o de camas:</div>
        <div>${room.bedsLabel}</div>
      </div>
      <div>
        <div class="muted">Capacidade:</div>
        <div>${occ}/${room.capacity} pessoa(s)</div>
      </div>

      <div class="stack">
        <label for="editCapacity">Alterar capacidade</label>
        <div class="row">
          <input id="editCapacity" type="number" min="1" value="${
            room.capacity
          }" style="width:80px;">
          <button class="secondary small" id="saveCapacityBtn">Salvar</button>
        </div>
      </div>

      <div class="stack">
        <label for="editName">Renomear quarto</label>
        <div class="row">
          <input id="editName" type="text" value="${
            room.name
          }" style="flex:1;">
          <button class="secondary small" id="saveNameBtn">Salvar</button>
        </div>
      </div>

      <div class="stack">
        <div class="muted">Fam√≠lias alocadas:</div>
        <ul>${familiesHtml}</ul>
        ${
          room.families.length
            ? `<button class="danger small" id="clearRoomBtn">Remover todas as fam√≠lias</button>`
            : ""
        }
      </div>
    `;

    // Listeners de detalhes
    const capBtn = $("#saveCapacityBtn");
    capBtn.addEventListener("click", () => {
      const val = parseInt($("#editCapacity").value, 10);
      if (!Number.isFinite(val) || val < 1) return;
      room.capacity = val;
      renderCanvas();
      renderRoomDetails();
      persistRoomsToStorage();
    });

    const nameBtn = $("#saveNameBtn");
    nameBtn.addEventListener("click", () => {
      const val = $("#editName").value.trim();
      if (!val) return;
      room.name = val;
      renderCanvas();
      renderSpacesList();
      renderRoomDetails();
      persistRoomsToStorage();
    });

    const clearBtn = $("#clearRoomBtn");
    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        room.families = [];
        renderCanvas();
        renderFamiliesList();
        renderRoomDetails();
        persistRoomsToStorage();
      });
    }

    container.querySelectorAll("[data-remove-family]").forEach((btn) => {
      const fid = btn.dataset.removeFamily;
      btn.addEventListener("click", () => {
        room.families = room.families.filter((id) => id !== fid);
        renderCanvas();
        renderFamiliesList();
        renderRoomDetails();
        persistRoomsToStorage();
      });
    });
  }

  // =========================
  // INTERA√á√ïES
  // =========================

  function allocateFamilyToRoom(familyId, roomId) {
    const room = rooms[roomId];
    if (!room) return;
    if (room.families.includes(familyId)) return;

    // Regra: fam√≠lia s√≥ pode estar em 1 quarto
    Object.values(rooms).forEach((r) => {
      r.families = r.families.filter((fid) => fid !== familyId);
    });

    const family = families.find((f) => f.id === familyId);
    const occupied = totalRoomOccupancy(room);
    const newTotal = occupied + family.size;

    if (newTotal > room.capacity) {
      alert(
        `Capacidade excedida!\nQuarto: ${room.name}\nCapacidade: ${room.capacity}\nSe adicionar ${family.name} (${family.size}), ficaria com ${newTotal}.`
      );
      return;
    }

    room.families.push(familyId);
    renderCanvas();
    renderFamiliesList();
    renderRoomDetails();
    persistRoomsToStorage();
  }

  function makeRoomDraggable(card, room) {
    let isDragging = false;
    let startX, startY, origX, origY;

    card.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return; // s√≥ bot√£o esquerdo
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      origX = room.x;
      origY = room.y;
      card.style.zIndex = 10;

      const onMouseMove = (ev) => {
        if (!isDragging) return;
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        let newX = origX + dx;
        let newY = origY + dy;
        // trava para n√£o sair muito pra fora
        newX = Math.max(10, Math.min(newX, 1500));
        newY = Math.max(40, Math.min(newY, 820));
        room.x = newX;
        room.y = newY;
        card.style.left = newX + "px";
        card.style.top = newY + "px";
      };

      const onMouseUp = () => {
        isDragging = false;
        card.style.zIndex = "";
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
        persistRoomsToStorage();
      };

      document.addEventListener("mousemove", onMouseMove);
      document.addEventListener("mouseup", onMouseUp);
    });
  }

  // =========================
  // BOT√ïES E CAMPOS
  // =========================

  // novo espa√ßo
  $("#addSpaceBtn").addEventListener("click", () => {
    const name = $("#spaceName").value.trim();
    if (!name) return;
    const color = $("#spaceColor").value;
    const id = createSpace(name, color);
    $("#spaceName").value = "";
    currentSpaceId = id;
    renderSpacesList();
    renderCanvas();
  });

  // presets de quarto
  $$("#spacesPanel button[data-preset]").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (!currentSpaceId) {
        alert("Crie e selecione um espa√ßo primeiro.");
        return;
      }
      const preset = btn.dataset.preset;
      const space = getSpace(currentSpaceId);
      const defaultName = space.roomIds.length + 1;
      const roomName = "Q" + defaultName;
      createRoom(currentSpaceId, roomName, preset === "grande" ? 8 : preset === "media" ? 6 : preset === "pequena" ? 4 : 2, preset);
      renderCanvas();
      renderSpacesList();
    });
  });

  // adicionar quarto manual
  $("#addRoomBtn").addEventListener("click", () => {
    if (!currentSpaceId) {
      alert("Crie e selecione um espa√ßo primeiro.");
      return;
    }
    const nameRaw = $("#roomName").value.trim();
    const capacity = parseInt($("#roomCapacity").value, 10) || 1;

    const space = getSpace(currentSpaceId);
    const fallbackName = "Q" + (space.roomIds.length + 1);
    const name = nameRaw || fallbackName;

    createRoom(currentSpaceId, name, capacity, null);
    $("#roomName").value = "";
    renderCanvas();
    renderSpacesList();
  });

  // busca de fam√≠lia
  $("#familySearch").addEventListener("input", () => {
    renderFamiliesList();
  });

  // =========================
  // BOOTSTRAP INICIAL
  // =========================

  const loadedFromDB = populateFromDB();

  if (!loadedFromDB) {
    // Espa√ßo e quartos de exemplo, s√≥ pra voc√™ ver funcionando
    const esp1 = createSpace("Monte das Oliveiras", "#dc2626");
    const esp2 = createSpace("Alojamento Azul", "#2563eb");
    currentSpaceId = esp1;

    createRoom(esp1, "32", 4, "pequena");
    createRoom(esp1, "33", 6, "media");
    createRoom(esp1, "34", 4, "pequena");
    createRoom(esp1, "35", 8, "grande");
    createRoom(esp2, "101", 4, "pequena");
    createRoom(esp2, "102", 2, "casal");
  }

  renderSpacesList();
  renderCanvas();
  renderFamiliesList();
  renderRoomDetails();
</script>
</body>
</html>
